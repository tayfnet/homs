<!DOCTYPE html><html lang="ar" dir="rtl"><head>
  
<script id="version-guard-toast">
(function() {
  var CURRENT_VERSION = "2.0.0.0-stable-plus";
  var KEY = "taif:app_version";
  try {
    var saved = localStorage.getItem(KEY);
    if (!saved) {
      localStorage.setItem(KEY, CURRENT_VERSION);
    } else if (saved !== CURRENT_VERSION) {
      // Clear taif:* except session
      try {
        var toDel = [];
        for (var i=0;i<localStorage.length;i++) toDel.push(localStorage.key(i));
        var PRESERVE = new Set([KEY, 'taif:session', 'taif:session_token']);
        toDel.forEach(function(k){
          if (k && k.indexOf("taif:")===0 && !PRESERVE.has(k) && !k.startsWith('taif:session/')) {
            localStorage.removeItem(k);
          }
        });
      } catch(_) {}
      try { localStorage.setItem(KEY, CURRENT_VERSION); } catch(_){}
      var showToast = function() {
        var wrap = document.createElement('div');
        wrap.setAttribute('dir','rtl');
        wrap.style.cssText = "position:fixed;top:14px;left:50%;transform:translateX(-50%);z-index:2147483647";
        var bubble = document.createElement('div');
        bubble.textContent = "üîÑ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿ•ŸÑŸâ ÿ•ÿµÿØÿßÿ± ÿ¨ÿØŸäÿØ ‚Äî ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©";
        bubble.style.cssText = [
          "background: rgba(17,24,39,.95)",
          "color:#fff",
          "border-radius:14px",
          "padding:10px 16px",
          "font:600 14px/1.3 system-ui,Segoe UI,Roboto,Tahoma",
          "box-shadow:0 8px 24px rgba(0,0,0,.25)",
          "border:1px solid rgba(255,255,255,.08)",
          "max-width:92vw",
          "text-align:center",
          "white-space:nowrap"
        ].join(";");
        wrap.appendChild(bubble);
        document.body.appendChild(wrap);
        setTimeout(function(){ bubble.style.opacity="0.0"; bubble.style.transition="opacity .45s ease"; }, 1400);
      };
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', showToast);
      else showToast();
    }
  } catch(_) {}
})();
</script>
<link rel="preconnect" href="https://unpkg.com" crossorigin><link rel="dns-prefetch" href="https://unpkg.com"><link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin><link rel="dns-prefetch" href="https://cdn.tailwindcss.com"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/><title>ŸÑŸàÿ≠ÿ© ÿ£ÿ≥ÿπÿßÿ± ÿµÿ±ŸÅ ÿßŸÑÿπŸÖŸÑÿßÿ™</title><script>
  window.tailwind=window.tailwind||{};
  tailwind.config={safelist:[
    'bg-gradient-to-tr','bg-gradient-to-r','text-white','text-gray-100','text-gray-900',
    'from-cyan-200','via-white','to-blue-200','to-cyan-200',
    'from-rose-200','via-amber-100','to-orange-200',
    'from-emerald-200','to-teal-200',
    'from-gray-900','via-gray-800','to-slate-900',
    'from-indigo-200','to-purple-200',
    'from-yellow-100','via-yellow-200','to-yellow-300',
    'from-sky-600','via-cyan-600','to-blue-600',
    'from-orange-500','via-pink-500','to-red-500',
    'from-emerald-600','via-teal-600','to-green-500',
    'from-gray-700','via-gray-600','to-gray-800',
    'from-indigo-600','via-purple-600','to-fuchsia-600',
    'from-yellow-600','via-amber-600','to-yellow-700',
    'from-purple-700','via-indigo-600','to-blue-600',
    'from-sky-100','via-cyan-100','to-blue-100',
    'from-orange-100','via-amber-200','to-rose-200',
    'from-teal-100','via-green-100','to-emerald-100',
    'from-blue-100','via-gray-200','to-teal-100',
    'from-gray-800','via-gray-700','to-gray-600',
    'from-indigo-100','via-purple-100','to-violet-100',
    'from-yellow-100','via-amber-100','to-yellow-200'
  ]};
</script><script defer src="https://cdn.tailwindcss.com"></script><script defer src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script><style>:root{

color-scheme:light;--firstcol-pr:32px}*{box-sizing:border-box}html,body{height:100%}.glass{background:rgba(255,255,255,.4);backdrop-filter:blur(10px)}.glass-strong{background:rgba(255,255,255,.65);backdrop-filter:blur(12px)}.toast{position:fixed;top:1rem;left:50%;transform:translateX(-50%);z-index:1100}.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:1050}.table-numbers,.table-numbers *{direction:ltr!important;unicode-bidi:bidi-override!important;text-align:center;font-family:Inter,Roboto,Arial,Tahoma,sans-serif}.table-currencies{table-layout:fixed;width:100%;border-collapse:collapse}.flag-slot img,.flag-slot svg{display:inline-block;vertical-align:-2px;border-radius:4px}@media(max-width:640px){.flag-slot img,.flag-slot svg{width:28px!important;height:18px!important}}@media(min-width:641px)and(max-width:1023px){.flag-slot img,.flag-slot svg{width:56px!important;height:36px!important}}@media(min-width:1024px){.flag-slot img,.flag-slot svg{width:72px!important;height:45px!important}}.cell-fixed{min-width:110px;display:inline-flex;justify-content:center;align-items:center;text-align:center}@media(max-width:640px){.cell-fixed{min-width:70px!important}}@media(min-width:768px){.cell-fixed{min-width:130px}}@media(min-width:1024px){.cell-fixed{min-width:150px}}.cell-change-mobile{padding:0 2px!important}.ad-wrap{position:relative;overflow:hidden;height:100%}.ad-item{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);white-space:nowrap;font-weight:600;transition:transform var(--ad-move,1.5s) ease-in-out}.no-trans{transition:none!important}.fld{height:38px;padding:.45rem .7rem;border:1px solid #d1d5db;border-radius:.75rem;background:#fff}.fld:focus{outline:2px solid rgba(59,130,246,.55)}.seg{display:inline-flex;border:1px solid #d1d5db;border-radius:.75rem;overflow:hidden}.seg>button{padding:.28rem .6rem;font-size:.75rem;line-height:1;border:0;background:#fff;color:#1f2937}.seg>button.mul.on{background:#16a34a;color:#fff}.seg>button.div.on{background:#dc2626;color:#fff}.code-badge{font-weight:800;font-size:.75rem;padding:.15rem .5rem;border-radius:.6rem;background:#0f172a;color:#fff}.name-inline{display:flex;align-items:center;gap:.45rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.buy-bg{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}.sell-bg{background:#fef2f2;border-color:#fecaca;color:#991b1b}.bulk-grid{display:grid;grid-template-columns:200px 90px .9fr .9fr .9fr .9fr;gap:.5rem}.bulk-head{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);z-index:10;border-bottom:1px solid #e5e7eb;padding:.5rem .25rem}.bulk-head>div{text-align:center}.bulk-head>div:first-child{text-align:right}.bulk-row{padding:.55rem .25rem;border-bottom:1px solid #eef2f7}.bulk-foot{position:sticky;bottom:0;background:transparent;padding:0;margin-top:.5rem}.m-label{display:none}@media(max-width:640px){.bulk-head{display:none}.bulk-row{grid-template-columns:1fr 1fr;grid-template-areas:"name name" "method method" "rb rs" "buy sell";gap:.45rem;padding:.6rem;border-bottom:1px solid #eaeef5;border-radius:.75rem}.m-label{display:block;font-size:12px;color:#6b7280;margin:0 0 .2rem}.cell-name{grid-area:name}.cell-method{grid-area:method}.cell-rb{grid-area:rb}.cell-rs{grid-area:rs}.cell-buy{grid-area:buy}.cell-sell{grid-area:sell}}.view-card{border:1px solid #e5e7eb;border-radius:1rem;padding:.75rem;background:#fff}.view-card.sel{outline:3px solid rgba(59,130,246,.5)}.board-row:hover{background:linear-gradient(90deg,rgba(229,231,235,.7),rgba(191,219,254,.9));box-shadow:0 2px 8px rgba(0,0,0,.12)}.hdr{display:grid;grid-template-columns:1fr;gap:.5rem}@media (min-width:640px){.hdr{grid-template-columns:35% 30% 35%}}@media (max-width:640px){.hdr > *{min-height:72px}}@media (max-width:640px){.footer-grid{grid-template-columns:75% 25% !important;}}@media (max-width:640px){.cell-change-mobile{font-size:12px!important;min-width:5.75ch!important;padding:0 .3rem!important;white-space:nowrap!important}}.name-box{flex:1 1 auto;min-width:0;max-width:100%;overflow:hidden}.name-track{display:inline-block;white-space:nowrap;padding-inline:2px}.name-box.is-scroll .name-track{animation:name-marquee 9s linear infinite}100%{transform:translateX(-100%)}@media(max-width:640px){.currency-name{font-size:13px !important;line-height:1.1 !important;}.currency-icon-mobile{display:none !important;}}@media(max-width:640px){.currency-cell-mobile{gap:0.25rem !important;}.name-box{overflow:hidden;max-width:100%;flex:1;}.name-box .name-track{display:inline-block;white-space:nowrap;animation:name-marquee 8s linear infinite;}100%{transform:translateX(-100%)}}@media(max-width:640px){.currency-cell-mobile{gap:0.25rem !important;}.name-box{overflow:visible !important;white-space:normal !important;flex:1;}.name-box .name-track{white-space:normal !important;word-break:break-word;font-size:13px !important;line-height:1.1 !important;}}@media(max-width:640px){.name-box{overflow:visible !important;white-space:normal !important;flex:1;}.name-box .name-track{white-space:normal !important;word-break:break-word;font-size:13px !important;line-height:1.2 !important;}.table-currencies{table-layout:fixed !important;width:100% !important;}.cell-change-mobile{min-width:58px !important;max-width:58px !important;height:32px !important;font-size:12px !important;line-height:32px !important;padding:0 !important;display:inline-flex !important;align-items:center !important;justify-content:center !important;white-space:nowrap !important;}}@media(max-width:640px){.name-box{overflow:visible !important;white-space:normal !important;flex:1;}.name-box .name-track{white-space:normal !important;word-break:break-word;font-size:13px !important;line-height:1.2 !important;}}@media(max-width:640px){.name-box{overflow:hidden !important;flex:1;display:-webkit-box !important;-webkit-box-orient:vertical;-webkit-line-clamp:2;}.name-box .name-track{white-space:normal !important;word-break:break-word;font-size:13px !important;line-height:1.2 !important;}}@media(max-width:640px){.currency-cell-mobile{gap:0.15rem !important;}.name-box{overflow:hidden !important;flex:1;display:-webkit-box !important;-webkit-box-orient:vertical;-webkit-line-clamp:2;}.name-box .name-track{white-space:normal !important;word-break:break-word;font-size:13px !important;line-height:1.2 !important;}}.name-track{animation:none !important;transform:none !important;}.name-box.is-scroll .name-track{animation:none !important;transform:none !important;}@media(max-width:640px){.card-label{font-size:12px !important;color:#111827 !important;margin-bottom:4px !important;line-height:1 !important;}.pill-card{height:40px !important;min-height:40px !important;display:inline-flex !important;align-items:center !important;justify-content:center !important;padding:0 12px !important;border-radius:14px !important;}.card-grid-mobile{gap:.5rem !important;}}@media(max-width:640px){.pill-card{height:38px !important;min-height:38px !important;padding:0 12px !important;width:92% !important;margin-inline:auto !important;}}@media(min-width:641px){.pill-card{width:94% !important;margin-inline:auto !important;}}@media(min-width:641px){.card-grid-mobile{gap:0.75rem !important;}}@media(min-width:1024px){.card-grid-mobile{gap:1rem !important;}}@media(max-width:640px){.board-row .table-numbers{min-width:7ch !important;height:38px !important;display:inline-flex !important;align-items:center !important;justify-content:center !important;padding:0 12px !important;font-size:14px !important;}.board-row .name-box{max-width:100% !important;}.board-row .name-track{white-space:normal !important;word-break:break-word;line-height:1.2 !important;display:-webkit-box !important;-webkit-box-orient:vertical;-webkit-line-clamp:2;font-size:13px !important;}}@media(max-width:640px){.board-row{grid-template-columns:2fr 0.9fr 0.9fr 0.8fr !important;}.board-row .name-track{font-size:14px !important;line-height:1.3 !important;-webkit-line-clamp:2;}.board-row .cell-change-mobile,.board-row .table-numbers span{min-width:60px !important;max-width:60px !important;height:34px !important;font-size:12px !important;line-height:34px !important;}}@media(max-width:640px){.board-row .cell-change-mobile,.board-row .table-numbers span{min-width:52px !important;max-width:52px !important;height:34px !important;font-size:12px !important;line-height:34px !important;}}@media(max-width:640px){.board-row .pill-buy,.board-row .pill-sell{height:40px !important;min-height:40px !important;line-height:40px !important;padding:0 14px !important;font-size:14px !important;display:inline-flex !important;align-items:center !important;justify-content:center !important;}.board-row .cell-change-mobile{min-width:52px !important;max-width:52px !important;height:30px !important;line-height:30px !important;font-size:11px !important;padding:0 6px !important;display:inline-flex !important;align-items:center !important;justify-content:center !important;white-space:nowrap !important;}}@media(max-width:640px){.board-row .pill-buy,.board-row .pill-sell{height:40px !important;min-height:40px !important;min-width:92px !important;max-width:92px !important;padding:0 8px !important;font-size:14px !important;line-height:40px !important;white-space:nowrap !important;overflow:hidden !important;text-overflow:clip !important;display:inline-flex !important;align-items:center !important;justify-content:center !important;}.board-row .cell-change-mobile{min-width:52px !important;max-width:52px !important;height:30px !important;line-height:30px !important;font-size:11px !important;white-space:nowrap !important;}}@media(max-width:640px){.board-row{grid-template-columns:1fr 100px 100px 60px !important;}.board-row .name-box{max-width:100% !important;}.board-row .name-track{white-space:normal !important;word-break:normal !important;overflow-wrap:anywhere !important;font-size:14px !important;line-height:1.3 !important;display:-webkit-box !important;-webkit-box-orient:vertical;-webkit-line-clamp:2;}.board-row .currency-cell-mobile{gap:0.25rem !important;}}@media(max-width:640px){.backdrop .glass-strong{max-height:86vh !important;overflow:auto !important;}.form-currency .grid{gap:.6rem !important;}.form-currency .fld{height:34px !important;min-height:34px !important;padding:.28rem .6rem !important;font-size:14px !important;}.form-currency .btn-row{position:sticky !important;bottom:0 !important;background:transparent;padding-top:.5rem !important;}.form-currency .btn-row .w-32,.form-currency .btn-row .w-36{height:44px !important;}}@media(max-width:640px){.form-currency .fld{height:28px !important;min-height:28px !important;padding:.18rem .5rem !important;font-size:13px !important;}}@media(max-width:640px){.form-currency .grid{gap:.45rem !important;}.form-currency label.grid{gap:.25rem !important;}.form-currency .fld{height:30px !important;min-height:30px !important;padding:.22rem .5rem !important;font-size:13.5px !important;}}@media(max-width:640px){.backdrop{align-items:flex-start !important;padding-top:8px !important;}.backdrop .glass-strong{margin-top:0 !important;}}@media(max-width:640px){.toast .glass{font-size:14px !important;line-height:1.1 !important;white-space:nowrap !important;max-width:92vw !important;overflow:hidden !important;text-overflow:ellipsis !important;padding:.55rem .8rem !important;}}@media(max-width:640px){.themes-grid .view-card{padding:.55rem !important;border-radius:.9rem !important;}.themes-grid .view-card.sel{outline-width:2px !important;}.themes-grid .view-card .h-16{height:48px !important;}.themes-grid .view-card .mb-2{margin-bottom:.35rem !important;}.themes-grid .view-card .font-bold{font-size:13.5px !important;}.themes-grid .view-card .text-xs{font-size:10.5px !important;}}@media(max-width:640px){.themes-grid .view-card{padding:.45rem !important;border-radius:.8rem !important;}.themes-grid .view-card .h-16{height:44px !important;}.themes-grid .view-card .mb-2{margin-bottom:.3rem !important;}.themes-grid .view-card .font-bold{font-size:13px !important;}.themes-grid .view-card .text-xs{font-size:10px !important;}.themes-grid + .flex.justify-end.gap-2.pt-4 > button{height:38px !important;padding-inline:.75rem !important;font-size:14px !important;border-radius:.7rem !important;}}@media(max-width:640px){.backdrop .glass-strong{padding:10px !important;max-width:94vw !important;overflow:auto !important;}.themes-grid{padding-inline:2px !important;gap:.45rem !important;}.themes-grid .view-card{margin:0 !important;}.themes-grid + .flex.justify-end.gap-2.pt-4{padding-top:.35rem !important;gap:.35rem !important;}.themes-grid + .flex.justify-end.gap-2.pt-4 > button{margin:0 !important;}}@media(max-width:640px){.bottom-fixed{--footer-h:48px;}@media (max-width:640px){.bottom-fixed{--footer-h:40px;}}}.bg-cover-layer{position:fixed;inset:-15vh 0 -15vh 0;z-index:-1;pointer-events:none;}@media(max-width:640px){#body{min-height:100dvh;}}@media(max-width:640px){.backdrop{padding-top:16px !important;align-items:flex-start !important;}}@media(max-width:640px){.backdrop{padding-top:48px !important;align-items:flex-start !important;}}.fab{transition:background .2s ease,transform .15s ease;}.menu-panel{margin-top:6px;}.fab{transition:background .2s ease,transform .15s ease;}.menu-panel{position:absolute;left: 0;top:calc(100% + 4px);margin-top:0;}.menu-backdrop{position:fixed;inset:0;z-index:100000;}.menu-panel > .glass{max-height:80vh;overflow:auto;}.drawer-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:100000;}.drawer{position:fixed;top:0;left: 0;height:100dvh;width:60vw;background: var(--panel-bg) !important;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);border-right: 1px solid var(--panel-border) !important;box-shadow:12px 0 28px rgba(0,0,0,.15);transform:translateX(-100%);transition:transform .28s ease;z-index:100001;display:flex;flex-direction:column;border-top-left-radius:14px;border-bottom-left-radius:14px;}.drawer.open{transform:translateX(0);}.drawer header{position:sticky;top:0;height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;font-weight:800;background: color-mix(in oklab, var(--panel-bg) 92%, #ffffff) !important;border-bottom: 1px solid var(--panel-border) !important;border-top-left-radius:14px;}.drawer .content{padding:10px;overflow:auto;}.btn-drawer{display:flex;align-items:center;gap:.6rem;padding:.55rem .8rem;border:1px solid #e5e7eb;border-radius:.9rem;background:#fff;font-weight:700;box-shadow:0 1px 3px rgba(0,0,0,.06);}.btn-drawer:active{transform:scale(.98)}.section-title{margin:.5rem .25rem .35rem;font-size:.9rem;color:#374151;font-weight:800}.sep{height:1px;background:#eef2f7;margin:.5rem 0}.fab{transition:background .2s ease,transform .15s ease;}@media (min-width:641px){.drawer{width:360px !important;}}@media (min-width:1024px){.drawer{width:380px !important;}}@media (min-width:1280px){.drawer{width:420px !important;}}@media (min-width:641px){.drawer{width:320px !important;}}@media (min-width:1024px){.drawer{width:340px !important;}}@media (min-width:1280px){.drawer{width:360px !important;}}.pick-list .font-extrabold{font-weight:800}@media (max-width:640px){.pick-list{gap:.8rem !important;}.pick-list button{padding:.85rem .75rem !important;}.pick-list .font-extrabold{font-size:16px}}@media(max-width:640px){.cell-change-mobile{font-size:10px !important;}}@media (min-width:641px){.ad-wrap .ad-item{font-size:clamp(18px,1.6vw,28px) !important;font-weight:800 !important;letter-spacing:.2px !important;line-height:1.1 !important;}.ad-wrap .ad-item span{padding-inline:1rem !important;}}@media (min-width:1280px){.ad-wrap .ad-item{font-size:clamp(22px,1.4vw,32px) !important;}}.bg-fixed-gradient{position:fixed;inset:-25vh 0 -25vh 0;z-index:-1;pointer-events:none;}@media (min-width:641px){.change-pill{height:38px !important;min-width:118px !important;padding:0 14px !important;font-size:15px !important;gap:.35rem !important;display:inline-flex !important;align-items:center !important;justify-content:center !important;}}@media (min-width:1024px){.change-pill{height:40px !important;min-width:130px !important;font-size:16px !important;}}@media (min-width:641px){.card-grid-mobile{align-items:center !important;}.card-grid-mobile > div{display:flex;flex-direction:column;align-items:center;gap:.35rem;}.card-grid-mobile .pill-card{height:38px !important;min-height:38px !important;}}@media (min-width:641px){.card-grid-mobile .pill-card{height:42px !important;min-height:42px !important;}.card-grid-mobile .change-pill{height:42px !important;min-height:42px !important;}}@media (min-width:1024px){.card-grid-mobile .pill-card{height:44px !important;min-height:44px !important;}.card-grid-mobile .change-pill{height:44px !important;min-height:44px !important;}}@media (min-width:641px){.card-grid-mobile{gap:1rem !important;}.card-grid-mobile > div{gap:.5rem !important;}}@media (min-width:1024px){.card-grid-mobile{gap:1.25rem !important;}}@media (min-width:641px){.icon-pill-after{background:#cfd8e3 !important;color:#111827 !important;border:1px solid rgba(17,24,39,.08) !important;display:inline-flex !important;align-items:center;}}@media (min-width:641px){.board-head >:first-child,.board-row >:first-child{padding-right:28px !important;}}@media (min-width:1024px){.board-head >:first-child,.board-row >:first-child{padding-right:32px !important;}}@media (min-width:1536px){.board-head >:first-child,.board-row >:first-child{padding-right:36px !important;}}@media (min-width:641px){.hdr{padding-right:0px !important;}}@media (min-width:641px){.title-box{transform:none !important;}}@media (min-width:641px){.hdr{height:136px !important;}.logo-box,.banner-box,.title-box{min-height:136px !important;height:136px !important;}.title-box{transform:none;}}@media (min-width:768px){.hdr{height:136px !important;}.logo-box,.banner-box,.title-box{min-height:136px !important;height:136px !important;}.title-box{transform:none;}}.title-plain{background:transparent !important;border:none !important;box-shadow:none !important;}@media (min-width:641px){.hdr{grid-template-columns:calc(35% - 1px) calc(30% - 1px) calc(35% - 1px);gap:0 !important;}}.logo-box img,.banner-box img{width:100% !important;height:100% !important;object-fit:fill !important;}.logo-modal .section{border:1px solid #e5e7eb;border-radius:12px;background:#ffffffcc;backdrop-filter:blur(6px);padding:12px}.logo-modal .section-title{font-weight:800;color:#334155;font-size:.95rem;margin-bottom:.35rem;display:flex;align-items:center;gap:.4rem}.logo-modal .hint{font-size:.78rem;color:#64748b}.logo-modal .row{display:grid;grid-template-columns:1fr;gap:.6rem}@media(min-width:640px){.logo-modal .row{grid-template-columns:220px 1fr}}.logo-modal .preview{display:flex;align-items:center;justify-content:center;width:220px;height:130px;border:1px dashed #cbd5e1;border-radius:10px;background:#fff}.logo-modal .actions{display:flex;gap:.5rem;flex-wrap:wrap}.logo-modal .sticky-actions{position:sticky;bottom:0;background:transparent;padding-top:.5rem}@media (max-width:640px){.logo-box,.banner-box{height:116px !important;min-height:116px !important;}.logo-box img,.banner-box img{width:100% !important;height:100% !important;object-fit:fill !important;}.hdr{gap:6px !important;}.title-plain{padding-block:6px !important;}header + .rounded-3xl{margin-top:6px !important;}.hdr > *{min-height:116px !important;}}@media (max-width:640px){.hdr{gap:3px !important;}.title-plain{padding-block:2px !important;}}@media (max-width:640px){.title-plain{min-height:40px !important;height:auto !important;padding-block:2px !important;display:flex !important;align-items:center !important;justify-content:center !important;}}@media (max-width:640px){.hdr{grid-template-columns:1fr 1fr !important;grid-template-areas:"logo banner" "title title" !important;gap:6px !important;align-items:stretch !important;}.logo-box{grid-area:logo !important;aspect-ratio:1 / 1 !important;height:auto !important;min-height:0 !important;}.banner-box{grid-area:banner !important;aspect-ratio:1 / 1 !important;height:auto !important;min-height:0 !important;}.title-plain{grid-area:title !important;min-height:0 !important;padding-block:6px !important;}.hdr > *{min-height:0 !important;}.logo-box img,.banner-box img{width:100% !important;height:100% !important;object-fit:fill !important;}}@media (max-width:640px){.hdr{grid-template-columns:1fr 1fr !important;grid-template-areas:"logo banner" "title title" !important;gap:6px !important;}.logo-box,.banner-box{height:96px !important;min-height:96px !important;aspect-ratio:auto !important;}.logo-box img,.banner-box img{width:100% !important;height:100% !important;object-fit:fill !important;}.title-plain{padding-block:6px !important;}}.btn-drawer{background:linear-gradient(135deg,#f8fafc 0%,#eef2f7 55%,#e8f0ff 100%) !important;border-color:rgba(148,163,184,.35) !important;color:#0f172a !important;box-shadow:inset 0 2px 8px rgba(15,23,42,.06),0 1px 3px rgba(0,0,0,.06) !important;}.btn-drawer:hover{background:linear-gradient(135deg,#eef2f7 0%,#e2e8f0 50%,#dde7ff 100%) !important;}.btn-drawer:active{transform:scale(.985) !important;}.section-title{color:#1f2937 !important;}.fab{width:56px !important;height:56px !important;border-radius:16px !important;background:radial-gradient(120% 120% at 30% 20%,#ffffffcc 0%,#eef2ffcc 45%,#e0e7ffcc 100%) !important;border:1px solid rgba(99,102,241,.35) !important;box-shadow:0 8px 24px rgba(30,58,138,.18),inset 0 1px 0 rgba(255,255,255,.7),inset 0 -1px 0 rgba(99,102,241,.25) !important;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);color:#111827 !important;display:flex;align-items:center;justify-content:center;transition:transform .18s ease,box-shadow .25s ease,background .25s ease;}@keyframes fab-glow{0%,100%{box-shadow:0 8px 22px rgba(30,58,138,.16),0 0 0 0 rgba(99,102,241,.0),inset 0 1px 0 rgba(255,255,255,.7),inset 0 -1px 0 rgba(99,102,241,.25);}50%{box-shadow:0 10px 26px rgba(30,58,138,.20),0 0 0 8px rgba(99,102,241,.06),inset 0 1px 0 rgba(255,255,255,.8),inset 0 -1px 0 rgba(99,102,241,.28);}}@media (max-width:640px){header{position:relative !important;}.fab{width:44px !important;height:44px !important;border-radius:12px !important;font-size:20px !important;}}@media (max-width:640px){.logo-box,.banner-box{height:84px !important;min-height:84px !important;}}@media (max-width:640px){.logo-box,.banner-box{height:80px !important;min-height:80px !important;}}@media (max-width:640px){.backdrop{align-items:center !important;justify-content:center !important;padding-top:0 !important;}.backdrop .glass-strong{margin-top:0 !important;max-height:86vh !important;}}.th-vipPearl .rounded-3xl{background:linear-gradient(135deg,#f0f9ff,#ecfeff) !important;border-color:#bae6fd !important;}.th-vipPearl .btn-drawer{background:linear-gradient(135deg,#f0f9ff,#e6fffb) !important;border-color:#bae6fd !important;color:#0f172a !important;}.th-vipPearl .glass-strong{background:rgba(255,255,255,.92) !important;border-color:#bae6fd !important;}.th-vipPearl .pill-buy{background:linear-gradient(90deg,#22c55e,#16a34a) !important;color:#fff !important;}.th-vipPearl .pill-sell{background:linear-gradient(90deg,#ef4444,#b91c1c) !important;color:#fff !important;}.th-vipPearl .change-pill{background:rgba(14,165,233,.15) !important;color:#0369a1 !important;}body{--th-text:#111827;--th-muted:#6b7280;--th-input-bg:#ffffff;--th-input-text:#111827;--th-input-border:#e5e7eb;--th-placeholder:#9ca3af;}.th-vipPearl{--th-text:#0f172a;--th-muted:#475569;--th-input-bg:#ffffff;--th-input-text:#0f172a;--th-input-border:#bae6fd;--th-placeholder:#64748b;}body[class*="th-"],body[class*="th-"] .glass-strong .fld,.backdrop .glass-strong .fld{background:var(--th-input-bg) !important;color:var(--th-input-text) !important;border-color:var(--th-input-border) !important;}.glass-strong .fld::placeholder,.backdrop .glass-strong .fld::placeholder{color:var(--th-placeholder) !important;opacity:1 !important;}.bulk-head>div,.pick-list .text-sm,.section-title,.card-label{color:var(--th-muted) !important;}.table-numbers{color:var(--th-text) !important;}.change-pill{font-weight:800 !important;}:root{

--th-text:#111827;--th-muted:#475569;--panel-bg:rgba(255,255,255,.96);--panel-text:#111827;--panel-border:#e5e7eb;--chip-bg:#e2e8f0;--chip-text:#111827;--chip-border:rgba(17,24,39,.08);--focus:#60a5fa88;}.th-vipPearl{--th-text:#0f172a;--th-muted:#475569;--panel-bg:rgba(255,255,255,.96);--panel-text:#0f172a;--panel-border:#bae6fd;--chip-bg:#dbeafe;--chip-text:#0f172a;--chip-border:#93c5fd;--focus:#06b6d488;}body[class*="th-"],body[class*="th-"] .btn-drawer,.view-card,.glass-strong{border-color:var(--panel-border) !important;}.glass-strong{background:var(--panel-bg) !important;color:var(--panel-text) !important;}.view-card{background:color-mix(in oklab,var(--panel-bg) 90%,#ffffff) !important;}.btn-drawer{background:linear-gradient(135deg,color-mix(in oklab,var(--panel-bg) 96%,#ffffff),color-mix(in oklab,var(--panel-bg) 86%,#ffffff)) !important;color:var(--panel-text) !important;}.fld{background:var(--panel-bg) !important;color:var(--panel-text) !important;border-color:var(--panel-border) !important;}.fld::placeholder{color:color-mix(in oklab,var(--panel-text) 45%,#9ca3af) !important;opacity:1 !important;}.fld:focus{outline:2px solid var(--focus) !important;}.icon-pill-after{background:var(--chip-bg) !important;color:var(--chip-text) !important;border:1px solid var(--chip-border) !important;}.table-numbers{color:var(--th-text) !important;}.change-pill{font-weight:800 !important;}.themes-grid .view-card .font-bold,.themes-grid .view-card .text-xs{color:#111827 !important;opacity:.95 !important;}
/* === Cards-only extra slim (scoped) === */
@media (min-width: 641px){
  .cards-view .view-card{ padding: .10rem !important; }
  /* both price pills and change badges carry 'pill-card' in CardsView */
  .cards-view .view-card .pill-card{
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    padding-inline: .75rem !important; /* ‚âà px-3 sm:px-4 */
  }
}
/* === Cards-only ultra slim inner spacing === */
@media (min-width: 641px){
  .cards-view .card-grid-mobile{
    margin-top: 0 !important; /* mt-0 */
    gap: 0 !important;        /* gap-0 */
  }
}
/* === Unified header box heights === */
@media (min-width:641px){
  .logo-box, .banner-box, .title-box {
    min-height:136px !important;
    height:136px !important;
  }
}
/* Typography fix for title: allow wrapping and normalize spacing */
@keyframes name-marquee {
  0% { transform: translateX(0); }
  100% { transform: translateX(-100%); }
}

/* === Stable+ readability for BUY/SELL pills === */
.pill-buy, .pill-sell{
  color:#F9FAFB !important;
  -webkit-text-stroke:0.6px rgba(0,0,0,.45);
  text-shadow:0 1px 1px rgba(0,0,0,.35), 0 0 1px rgba(0,0,0,.35);
  font-weight:900 !important;
}
.cards-view .pill-card.from-green-500,
.cards-view .pill-card.from-red-500{
  color:#F9FAFB !important;
  -webkit-text-stroke:0.6px rgba(0,0,0,.45);
  text-shadow:0 1px 1px rgba(0,0,0,.35), 0 0 1px rgba(0,0,0,.35);
  font-weight:900 !important;
}

</style><style id="fab-fix">.bottom-fixed{--footer-h:48px;}@media (max-width:640px){.bottom-fixed{--footer-h:40px;}}.drawer{z-index:100001;}.drawer-backdrop{z-index:100000;}</style>
<style id="title-unified">
/* === Title unified style === */
.title-plain h1 {
  background: linear-gradient(to right, #6B21A8, #DB2777, #2563EB);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  -webkit-text-fill-color: transparent;
  filter: drop-shadow(0 1px 1px rgba(0,0,0,.18));
  white-space: normal;
  word-break: break-word;
  word-spacing: normal;
  letter-spacing: normal;
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 2;
  overflow: hidden;
  font-size: clamp(1.5rem, 4vw, 2.7rem);
  line-height: 1.2;
  text-align: center;
  margin: 0;
  padding-inline: 2px;
}
@media (max-width:640px) {
  .title-plain h1 {
    font-size: clamp(16px, 5vw, 20px);
    line-height: 1.15;
    -webkit-line-clamp: 3;
  }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style id="fs-no-select">
/* Disable text selection briefly when toggling fullscreen to avoid highlight */
.no-select {
  -webkit-user-select: none !important;
  -moz-user-select: none !important;
  -ms-user-select: none !important;
  user-select: none !important;
}
</style>

</head><body id="body" class="min-h-screen text-gray-900"><div id="bgfix" class="bg-fixed-gradient bg-gradient-to-tr from-cyan-200 via-white to-cyan-200"></div><div id="root"></div><script defer crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script><script defer crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script><script defer src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<!-- Supabase Adapter (unified API) -->
<script>
(function(){
  const SUPABASE_URL = "https://ibbtgjheqdgcacmcbpaq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImliYnRnamhlcWRnY2FjbWNicGFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNjkwMDQsImV4cCI6MjA3NTY0NTAwNH0.ymJHT9Qt7hFCPxTKHLexfoQ4mqo4igbCTu5mHjMgEHY";
  // Reduce realtime events per second for better performance
  const client = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    // The original config requested up to 10 events per second from Supabase's realtime service.
    // Lowering this to 3 reduces the number of realtime messages and can help improve perceived responsiveness,
    // especially on low‚Äëpower devices or slow network connections.
    realtime: { params: { eventsPerSecond: 3 } }
  }) : null;

  const channels = new Map();
  const pollers = new Map();
  // Increase polling intervals to reduce CPU/network overhead.
  // When the page/tab is visible we poll every 7 seconds instead of 2.5.
  const POLL_MS_VISIBLE = 7000;
  // When the page/tab is hidden we poll every 30 seconds instead of 8.
  const POLL_MS_HIDDEN  = 30000;
  function __clearPoller(key){ try{ const t = pollers.get(key); if(t){ clearInterval(t); pollers.delete(key); } }catch(_){ } }

  function snap(val){ return { val: () => val }; }

  async function getKV(key){
    const { data, error } = await client.from('app_state').select('value').eq('key', key).maybeSingle();
    if (error) return null;
    return (data && 'value' in data) ? data.value : null;
  }
  async function setKV(key, value){
    await client.from('app_state').upsert([{ key, value }], { onConflict: 'key' });
  }
  async function getUsersMap(){
    const { data } = await client.from('users').select('*');
    const map = {}; (data||[]).forEach(u=>{ map[u.username] = u; }); return map;
  }
  async function getLogsMap(){
    const { data } = await client
      .from('adminactionslog')
      .select('*')
      // Exclude anonymous and system actors
      .neq('actor','anon')
      .neq('actor','system')
      // Retrieve the most recent records first and limit the number of rows
      // to avoid downloading the entire history on every refresh.
      .order('at',{ascending:false})
      .limit(200);
    const map = {};
    (data || [])
      .filter(row => !['addUser','updateUser','deleteUser'].includes(String(row.action || '')))
      .forEach(row => {
        const id = (row.at || Date.now()) + '_' + Math.random().toString(36).slice(2);
        map[id] = row;
      });
    return map;
  }

  
function subscribe(table, filter, onTick, nameKey){
  const name = `realtime_${table}_${nameKey||'all'}`;
  const ch = client.channel(name)
    .on('postgres_changes', { event:'*', schema:'public', table, filter }, async () => {
      try { await onTick(); } catch(_) {}
    });
  ch.subscribe();
  try { onTick && onTick(); } catch(_) {}
  return ch;
}


  const $db = {
    ref: (path) => ({ key: path }),
    async set(refOrPath, value){
      const key = typeof refOrPath === 'string' ? refOrPath : (refOrPath && refOrPath.key);
      if (!key) return;

      if (key.startsWith('taif/users/')){
        const username = key.split('/')[2];
        if (value === null || value === undefined){
          await client.from('users').delete().eq('username', username);
          return;
        }
        const rec = Object.assign({ username }, value||{});
        await client.from('users').upsert([rec], { onConflict: 'username' });
        return;
      }
      if (key === 'taif/users'){ return; }

      if (key === 'taif/adminactionslog' && (value===null || value===undefined)){
        await client.from('adminactionslog').delete().gt('id',0);
        return;
      }
      if (key.startsWith('taif/adminactionslog/')){
        await client.from('adminactionslog').insert([ value || {} ]);
        return;
      }

      if (key === 'taif/base' && value && typeof value === 'object' && value.date && value.base){
        await setKV('taif/base', value);
        return;
      }
      await setKV(key, value);
    },
    
onValue(refOrPath, cb){
      const key = typeof refOrPath === 'string' ? refOrPath : (refOrPath && refOrPath.key);
      if (!key) return null;

      let __lastJSON = null;
      const __update = async () => {
        try {
          let val;
          if (key === 'taif/users'){ val = await getUsersMap(); }
          else if (key.startsWith('taif/adminactionslog')){ val = await getLogsMap(); }
          else { val = await getKV(key); }
          const j = JSON.stringify(val);
          if (j !== __lastJSON) {
            __lastJSON = j;
            cb(snap(val));
          }
        } catch(_){}
      };

      (async () => { await __update(); })();

      let ch;
      if (key === 'taif/users'){
        ch = subscribe('users', undefined, __update, 'users');
      } else if (key.startsWith('taif/adminactionslog')){
        ch = subscribe('adminactionslog', undefined, __update, 'logs');
      } else {
        ch = subscribe('app_state', `key=eq.${key}`, __update, key);
      }
      channels.set(key, ch);

      try {
        const __startPoll = () => {
          const ms = (typeof document !== 'undefined' && document.visibilityState === 'hidden') ? POLL_MS_HIDDEN : POLL_MS_VISIBLE;
          __clearPoller(key);
          const t = setInterval(() => { __update(); }, ms);
          pollers.set(key, t);
        };
        __startPoll();
        const __visHandler = () => { __startPoll(); };
        if (typeof document !== 'undefined') {
          document.addEventListener('visibilitychange', __visHandler);
        }
        if (ch) ch.__visHandler = __visHandler;
      } catch(_){}

      return ch;
    },

    
off(refOrPath){
      const key = typeof refOrPath === 'string' ? refOrPath : (refOrPath && refOrPath.key);
      const ch = channels.get(key);
      if (ch){
        try{ client.removeChannel(ch); }catch(_){ }
        try{
          if (ch.__visHandler && typeof document !== 'undefined'){
            document.removeEventListener('visibilitychange', ch.__visHandler);
            ch.__visHandler = null;
          }
        }catch(_){}
        channels.delete(key);
      }
      __clearPoller(key);
    }

  };

  window.$db = $db;
  window.dispatchEvent(new Event('db-ready'));
})();
</script>

<script type="text/babel" data-plugins="transform-react-jsx">
/* ======== React App (Complete) ======== */
const {useState,useEffect,useMemo,useRef,useCallback}=React;

/* === Logs presentation helpers (Arabic mapping) === */// === ŸÖŸàŸÑŸëÿØ ÿ¨ŸèŸÖŸÑ ÿπÿ±ÿ®Ÿäÿ© ÿ®ÿ¥ÿ±Ÿäÿ© + ÿ±ŸÖŸàÿ≤ ===
const ACTION_ICONS = {
  'ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿØŸàŸÑÿßÿ±':'üíµ','ÿ™ÿπÿØŸäŸÑ ÿπŸÖŸÑÿ©':'‚úèÔ∏è','ÿ™ÿπÿØŸäŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÖŸÑÿßÿ™':'üõ†Ô∏è','ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™':'‚ö°',
  'ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸáŸàŸäÿ©':'üñºÔ∏è','ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸàŸÇÿ™':'üïí','ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ (ŸÜÿ¨ÿßÿ≠)':'‚úÖ','ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ (ŸÅÿ¥ŸÑ)':'‚ùå',
  'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨':'üö™','ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ¨ŸÑ':'‚ö†Ô∏è','ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ':'üë§','ÿ≠ÿ∞ŸÅ ŸÖÿ≥ÿ™ÿÆÿØŸÖ':'üë§','ÿ™ÿπÿØŸäŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ':'üë§'
};
const humanizeLog = (lg={}) => {
  const a = lg.action || '';
  const t = lg.target || '';
  if (a === 'ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿØŸàŸÑÿßÿ±') return `ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ÿ≥ÿπÿ± ÿßŸÑÿØŸàŸÑÿßÿ± ${t ? '‚Äî ' + t : ''}`;
  if (a === 'ÿ™ÿπÿØŸäŸÑ ÿπŸÖŸÑÿ©') return `ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ÿπŸÖŸÑÿ© ${t}`;
  if (a === 'ÿ™ÿπÿØŸäŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÖŸÑÿßÿ™') return `ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÖŸÑÿßÿ™ ${t}`;
  if (a === 'ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™') return `ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ${t}`;
  if (a === 'ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸáŸàŸäÿ©') return `${t || 'ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸáŸàŸäÿ©'}`;
  if (a === 'ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸàŸÇÿ™') return `ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸàŸÇÿ™ ${t}`;
  if (a === 'ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ¨ŸÑ') return `ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿ®ÿßŸÑŸÉÿßŸÖŸÑ`;
  if (a === 'ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ') return `ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ${t}`;
  if (a === 'ÿ≠ÿ∞ŸÅ ŸÖÿ≥ÿ™ÿÆÿØŸÖ') return `ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ${t}`;
  if (a === 'ÿ™ÿπÿØŸäŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ') return `ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ${t}`;
  if (a === 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ (ŸÜÿ¨ÿßÿ≠)') return `ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ`;
  if (a === 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ (ŸÅÿ¥ŸÑ)') return `ŸÅÿ¥ŸÑ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ`;
  if (a === 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨') return `ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨`;
  return `${a} ${t}`.trim();
};
const fmtDT = (iso) => { try { return new Date(iso).toLocaleString(); } catch(_) { return String(iso||''); } };
const mapAction = (a) => {
  const dict = {
    addUser: 'ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ',
    updateUser: 'ÿ™ÿπÿØŸäŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ',
    deleteUser: 'ÿ≠ÿ∞ŸÅ ŸÖÿ≥ÿ™ÿÆÿØŸÖ',
    'ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ': 'ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ',
    'ÿ™ÿπÿØŸäŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ': 'ÿ™ÿπÿØŸäŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ',
    'ÿ≠ÿ∞ŸÅ ŸÖÿ≥ÿ™ÿÆÿØŸÖ': 'ÿ≠ÿ∞ŸÅ ŸÖÿ≥ÿ™ÿÆÿØŸÖ',
    editUSD: 'ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿØŸàŸÑÿßÿ±',
    bulkEdit: 'ÿ™ÿπÿØŸäŸÑ ŸÉŸÑ ÿßŸÑÿπŸÖŸÑÿßÿ™',
    editData: 'ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ£ÿ≥ÿπÿßÿ±',
    clearLogs: 'ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ¨ŸÑ',
    editBanner: 'ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™',
    changeView: 'ÿ™ÿ∫ŸäŸäÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿπÿ±ÿ∂',
    changeTheme: 'ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ´ŸäŸÖ',
    editLogo: 'ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÑŸàÿ∫Ÿà/ÿßŸÑÿπŸÜŸàÿßŸÜ',
    adjustDatetime: 'ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸàŸÇÿ™',
    resetBase: 'ÿ™ÿ≠ÿØŸäÿ´ ÿÆÿ∑ ÿßŸÑÿ£ÿ≥ÿßÿ≥ ÿßŸÑŸäŸàŸÖŸä'
  };
  return dict[a] || a || '';
};
const prettyTarget = (t='') => {
  try {
    if (!t) return '';
    const s = String(t);
    if (s === 'taif/data') return 'ÿßŸÑÿ£ÿ≥ÿπÿßÿ±';
    if (s === 'taif/base') return 'ÿÆÿ∑ ÿßŸÑÿ£ÿ≥ÿßÿ≥ ÿßŸÑŸäŸàŸÖŸä';
    if (s === 'adminactionslog') return 'ÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿ•ÿØÿßÿ±ÿ©';
    if (s === 'taif/banner') return 'ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™';
    if (s === 'taif/title') return 'ÿπŸÜŸàÿßŸÜ ÿßŸÑÿµŸÅÿ≠ÿ©';
    if (s === 'taif/logo') return 'ÿßŸÑÿ¥ÿπÿßÿ±';
    if (s === 'taif/bannerImg') return 'ÿµŸàÿ±ÿ© ÿßŸÑŸáŸäÿØÿ±';
    if (s === 'taif/datetime') return 'ÿßŸÑŸàŸÇÿ™ ŸàÿßŸÑÿ™ÿßÿ±ŸäÿÆ';
    if (s.startsWith('taif/users/')) return 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ' + s.split('/')[2];
    return s;
  } catch(_) { return t || ''; }
};



/* ==== Live-perms Helpers (added) ==== */
/* ==== Device Lock Helpers (single-device session) ==== */
const DEVICE_KEY = 'taif:device_id';
function ensureDeviceId(){
  try{
    let id = localStorage.getItem(DEVICE_KEY);
    if(!id){
      const rnd = (crypto && crypto.getRandomValues) ? crypto.getRandomValues(new Uint32Array(4)) : new Uint32Array([Date.now() & 0xffffffff, Math.random()*1e9|0, Math.random()*1e9|0, Math.random()*1e9|0]);
      id = 'dev_' + Array.from(rnd).map(n=>n.toString(16)).join('');
      localStorage.setItem(DEVICE_KEY, id);
    }
    return id;
  }catch(_){ return 'dev_fallback'; }
}

const arrEq = (a,b) => {
  if (!Array.isArray(a) || !Array.isArray(b)) return false;
  if (a.length !== b.length) return false;
  const A = [...a].sort(), B = [...b].sort();
  for (let i=0;i<A.length;i++) if (A[i]!==B[i]) return false;
  return true;
};
const toPermArray = (objOrArr) => {
  if (Array.isArray(objOrArr)) return objOrArr;
  if (objOrArr && typeof objOrArr==='object')
    return Object.keys(objOrArr).filter(k => objOrArr[k]);
  return [];
};

/* === Security helpers (images) === */
const __IMG_TYPES = new Set(['image/png','image/jpeg','image/webp','image/svg+xml','image/gif']);
const __MAX_IMG_BYTES = 5 * 1024 * 1024;
const validateImage = (file, setToast) => {
  if(!file) return false;
  if(!__IMG_TYPES.has(file.type)){
    setToast?.({text:"‚ö†Ô∏è ÿßŸÑÿµŸäÿ∫ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ÿ©: PNG, JPEG, WebP ŸÅŸÇÿ∑", type:"error"});
    return false;
  }
  if(file.size > __MAX_IMG_BYTES){
    setToast?.({text:"‚ö†Ô∏è ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ŸÑŸÑÿµŸàÿ±ÿ© 1MB", type:"error"});
    return false;
  }
  return true;
};
/* === Focus trap for modals === */
const useFocusTrap = (enabled, containerRef) => {
  useEffect(() => {
    if(!enabled) return;
    const root = (containerRef && containerRef.current) || document;
    const q = 'a[href],button,textarea,input,select,[tabindex]:not([tabindex="-1"])';
    const getList = () => {
      const base = containerRef?.current || document;
      return Array.from(base.querySelectorAll(q)).filter(el => !el.hasAttribute('disabled'));
    };
    const listInit = getList();
    if(listInit[0]) { try { listInit[0].focus(); } catch(_){} }
    const onKey = (e) => {
      if(e.key !== 'Tab') return;
      const list = getList();
      if(!list.length) return;
      const first = list[0], last = list[list.length-1];
      const active = document.activeElement;
      if(e.shiftKey){
        if(active === first || !containerRef?.current?.contains(active)) { e.preventDefault(); last.focus(); }
      } else {
        if(active === last || !containerRef?.current?.contains(active)) { e.preventDefault(); first.focus(); }
      }
    };
    document.addEventListener('keydown', onKey);
    return () => document.removeEventListener('keydown', onKey);
  }, [enabled, containerRef]);
};
/* ================== ÿßŸÑÿ´Ÿàÿßÿ®ÿ™ ================== */
// Versioned snapshot ‚Äî cache handled via Supabase + CACHE_KEY
// Incremented the APP_VERSION to force a one-time reset of cached data in
// localStorage. This helps avoid blank screens caused by incompatible data
// structures from older versions persisting in storage. When the version
// stored in localStorage differs from this value the app will clear
// localStorage and reload defaults.
const APP_VERSION = "1.3.3.3";
 // ÿßŸÑÿ•ÿµÿØÿßÿ± ÿßŸÑÿ≠ÿßŸÑŸä
const K=Object.freeze({
  DATA:"taif:data",
  BANNER:"taif:banner:v2",
  DT:"taif:datetime",
  THEME:"taif:customTheme",
  BASE:"taif:dailyBase",
  VIEW:"taif:viewMode",
  LOGO:"taif:logo",
  TITLE:"taif:title",
  BANNERIMG:"taif:bannerImage"
});

// ŸÖÿØÿ© ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ¨ŸÑÿ≥ÿ© ÿ®ÿßŸÑŸÖŸÑŸÑŸä ÿ´ÿßŸÜŸäÿ© (ŸáŸÜÿß 6 ÿ≥ÿßÿπÿßÿ™)
const SESSION_TTL_MS = 1000 * 60 * 60 * 24 * 365;
/********************
 * Cache helpers
 ********************/
const CACHE_KEY = "taif:cache";
const loadCache = () => {
  try { return JSON.parse(localStorage.getItem(CACHE_KEY)) || null; }
  catch { return null; }
};
const saveCache = (obj) => {
  try { localStorage.setItem(CACHE_KEY, JSON.stringify(obj)); } catch {}
};

/* In-memory key/value store only for ephemeral runtime cache */
const __memKV = new Map();

/* ================== ÿØŸàÿßŸÑ ŸÖÿ≥ÿßÿπÿØÿ© ================== */
/* ================== StorageManager ================== */

/* Supabase-only mode: in-memory snapshot (no localStorage) */
const StorageManager = (()=>{
  let _mem = null;
  return {
    load: () => _mem,
    save: (obj) => { _mem = obj; },
    clear: () => { _mem = null; }
  };
})();

const clamp=(n,min,max)=>Math.min(Math.max(+n||0,min),max);
const toNum=v=>+v||0;
const two=n=>String(n).padStart(2,'0');
const readJSON=(k,fb)=>{ try{ return __memKV.has(k) ? __memKV.get(k) : fb }catch{ return fb } };
const saveJSON=(k,v)=>{ try{ __memKV.set(k,v) }catch{} };
const fmt=n=>new Intl.NumberFormat('en-US').format(toNum(n));
/* ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸàŸÇÿ™ ŸàÿßŸÑÿ™ÿßÿ±ŸäÿÆ */
const isValidTime=s=>/^([01]\d|2[0-3]):[0-5]\d$/.test((s||"").trim());
const isValidDateDMY=s=>{
  const m=(s||"").trim().match(/^(\d{2})-(\d{2})-(\d{4})$/);
  if(!m)return false;
  const d=+m[1],mo=+m[2]-1,y=+m[3],dt=new Date(y,mo,d);
  return dt.getFullYear()===y&&dt.getMonth()===mo&&dt.getDate()===d
};
const dmyToIso=s=>{
  if(!isValidDateDMY(s))return "";
  const [d,mo,y]=s.split("-");
  return `${y}-${mo}-${d}`
};
const isoToDmy=s=>{
  if(!s||!/^\d{4}-\d{2}-\d{2}$/.test(s))return "";
  const [y,mo,d]=s.split("-");
  return `${d}-${mo}-${y}`
};
/* ================== ÿßŸÑÿ´ŸäŸÖÿßÿ™ ================== */
const THEMES=[
  {id:"sunset",name:"ÿ∫ÿ±Ÿàÿ®",cls:"bg-gradient-to-tr from-rose-200 via-amber-100 to-orange-200 text-gray-900",head:"bg-gradient-to-r from-orange-500 via-pink-500 to-red-500 text-white",banner:"from-orange-100 via-amber-200 to-rose-200"},
  {id:"mint",name:"ŸÜÿπŸÜÿßÿπŸä",cls:"bg-gradient-to-tr from-emerald-200 via-white to-teal-200 text-gray-900",head:"bg-gradient-to-r from-emerald-600 via-teal-600 to-green-500 text-white",banner:"from-teal-100 via-green-100 to-emerald-100"},
  {id:"lav",name:"ŸÑÿßŸÅŸÜÿØÿ±",cls:"bg-gradient-to-tr from-indigo-200 via-white to-purple-200 text-gray-900",head:"bg-gradient-to-r from-indigo-600 via-purple-600 to-fuchsia-600 text-white",banner:"from-indigo-100 via-purple-100 to-violet-100"},
  {id:"gold",name:"ÿ∞Ÿáÿ®Ÿä ŸÅÿßÿÆÿ±",cls:"bg-gradient-to-tr from-yellow-100 via-yellow-200 to-yellow-300 text-gray-900",head:"bg-gradient-to-r from-yellow-600 via-amber-600 to-yellow-700 text-white",banner:"from-yellow-100 via-amber-100 to-yellow-200"},
  {id:"vipPearl",name:"VIP ‚Äî Pearl Glass",cls:"bg-gradient-to-tr from-blue-100 via-gray-200 to-teal-100 text-gray-900",head:"bg-gradient-to-r from-sky-600 via-cyan-600 to-blue-600 text-white",banner:"from-sky-100 via-cyan-100 to-blue-100"},
  {id:"vipTaif",name:"VIP ‚Äî Taif Brand",cls:"bg-gradient-to-tr from-indigo-100 via-amber-100 to-violet-100 text-gray-900",head:"bg-gradient-to-r from-yellow-600 via-amber-600 to-yellow-700 text-white",banner:"from-indigo-100 via-amber-100 to-violet-100"}
];
const THEME_MAP=Object.fromEntries(THEMES.map(t=>[t.cls,t]));
const DEF_HEAD="bg-gradient-to-r from-purple-700 via-indigo-600 to-blue-600 text-white";
const DEF_BANNER="from-blue-100 via-gray-200 to-teal-100";
const headCls=theme=>THEME_MAP[theme]?.head||DEF_HEAD;
const bannerCls=theme=>THEME_MAP[theme]?.banner||DEF_BANNER;
const THEME_WHITELIST=new Set(THEMES.map(t=>t.cls));
/* ================== ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ================== */

const DEFAULT_DATA = [
  {flag:"üá∫üá∏", icon:"USD", code:"USD", name:"ÿßŸÑÿØŸàŸÑÿßÿ± ÿßŸÑÿ£ŸÖÿ±ŸäŸÉŸä", buy:11300, sell:11400, ratioBuy:1, ratioSell:1, method:"multiply"},
  {flag:"üá™üá∫", icon:"EUR", code:"EUR", name:"ÿßŸÑŸäŸàÿ±Ÿà", ratioBuy:1.1700, ratioSell:1.1625, method:"multiply"},
  {flag:"üáπüá∑", icon:"TRY", code:"TRY", name:"ÿßŸÑŸÑŸäÿ±ÿ© ÿßŸÑÿ™ÿ±ŸÉŸäÿ©", ratioBuy:42.4, ratioSell:41.8, method:"divide"},
  {flag:"üá∏üá¶", icon:"SAR", code:"SAR", name:"ÿßŸÑÿ±ŸäÿßŸÑ ÿßŸÑÿ≥ÿπŸàÿØŸä", ratioBuy:3.8, ratioSell:3.77, method:"divide"},
  {flag:"üá¶üá™", icon:"AED", code:"AED", name:"ÿßŸÑÿØÿ±ŸáŸÖ ÿßŸÑÿ•ŸÖÿßÿ±ÿßÿ™Ÿä", ratioBuy:3.75, ratioSell:3.70, method:"divide"},
  {flag:"üá∂üá¶", icon:"QAR", code:"QAR", name:"ÿßŸÑÿ±ŸäÿßŸÑ ÿßŸÑŸÇÿ∑ÿ±Ÿä", ratioBuy:3.75, ratioSell:3.69, method:"divide"},
  {flag:"üáØüá¥", icon:"JOD", code:"JOD", name:"ÿßŸÑÿØŸäŸÜÿßÿ± ÿßŸÑÿ£ÿ±ÿØŸÜŸä", ratioBuy:1.38, ratioSell:1.3975, method:"multiply"},
  {flag:"üá¨üáß", icon:"GBP", code:"GBP", name:"ÿßŸÑÿ¨ŸÜŸäŸá ÿßŸÑÿ•ÿ≥ÿ™ÿ±ŸÑŸäŸÜŸä", ratioBuy:1.30, ratioSell:1.32, method:"multiply"},
];

/* ================== Toast ================== */
const Toast = ({ toast, onClose }) => {
  useEffect(() => {
    if (!toast) return;
    const timer = setTimeout(onClose, 3000);
    return () => clearTimeout(timer);
  }, [toast]);
  if (!toast) return null;
  let style = "bg-green-100 border-green-400 text-green-800";
  if (toast.type === "error") style = "bg-red-100 border-red-400 text-red-800";
  if (toast.type === "info") style = "bg-blue-100 border-blue-400 text-blue-800";
  return ReactDOM.createPortal(
    <div className="toast cursor-pointer" role="status" aria-live="polite" onClick={onClose}>
      <div className={`glass rounded-xl px-5 py-3 border shadow font-semibold ${style}` } aria-live="polite">
        {toast.text}
      </div>
    </div>,
    document.body
  );
};
/* ================== ŸÖŸÉŸàŸÜÿßÿ™ ÿµÿ∫Ÿäÿ±ÿ© ================== */
const Btn=({className="",...p})=>
  <button type="button" className={`px-3 py-2 rounded-lg font-semibold transition active:scale-[.98] ${className}`} {...p}/>
const Modal=({open,onClose,title,children})=>{
useEffect(()=>{
  if(!open)return;
  const esc=e=>e.key==="Escape"&&onClose();
  document.addEventListener("keydown",esc);
  return()=>document.removeEventListener("keydown",esc)
},[open,onClose]);
const dlgRef = useRef(null);
useFocusTrap(open, dlgRef);
if(!open)return null;
return ReactDOM.createPortal(
  <div className="backdrop" onClick={e=>e.currentTarget===e.target&&onClose()}>
    <div ref={dlgRef} tabIndex={-1} className="glass-strong w-full max-w-[92vw] sm:max-w-3xl md:max-w-4xl rounded-2xl border border-gray-200 shadow-2xl p-4 sm:p-6 relative" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <button type="button" onClick={onClose} className="absolute top-3 left-3" aria-label="ÿ•ÿ∫ŸÑÿßŸÇ">‚ùå</button>
      {title&&<div className="text-lg font-bold mb-2 sm:mb-3" id="modal-title">{title}</div>}
      <div className="grid gap-3">{children}</div>
    </div>
  </div>, document.body
);
};
// ÿ™ÿ≠ŸÇŸÇ ÿ£ŸÜ ÿßŸÑŸÜÿµ ŸáŸà ÿ•ŸäŸÖŸàÿ¨Ÿä ÿπŸÑŸÖ ÿµÿ≠Ÿäÿ≠ (ÿ≤Ÿàÿ¨ Regional Indicator)
const isFlagEmoji = (s="") => /^[\uD83C][\uDDE6-\uDDFF][\uD83C][\uDDE6-\uDDFF]$/.test(s);
// ÿßÿ¥ÿ™ŸÇÿßŸÇ ÿπŸÑŸÖ ŸÖŸÜ ŸÉŸàÿØ ÿßŸÑÿπŸÖŸÑÿ© ŸÖÿπ ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÜÿßÿ°ÿßÿ™ ÿßŸÑÿ¥ÿßÿ¶ÿπÿ©
const FLAG_OVERRIDES = {
  USD:"üá∫üá∏", EUR:"üá™üá∫", GBP:"üá¨üáß", JPY:"üáØüáµ", CAD:"üá®üá¶", AUD:"üá¶üá∫", CHF:"üá®üá≠",
  SAR:"üá∏üá¶", AED:"üá¶üá™", QAR:"üá∂üá¶", TRY:"üáπüá∑", EGP:"üá™üá¨", INR:"üáÆüá≥", CNY:"üá®üá≥"
};
const computeFlag = (code="") => {
  if (FLAG_OVERRIDES[code]) return FLAG_OVERRIDES[code];
  const cc = (code||"").slice(0,2).toUpperCase();
  if (cc.length===2 && cc[0]>='A' && cc[0]<='Z' && cc[1]>='A' && cc[1]<='Z') {
    const a = 0x1F1E6 + (cc.charCodeAt(0)-65);
    const b = 0x1F1E6 + (cc.charCodeAt(1)-65);
    return String.fromCodePoint(a,b);
  }
  return "üè≥Ô∏è";
};
const normalizeFlags = (list=[]) => list.map(r => ({ ...r, flag: isFlagEmoji(r.flag||"") ? r.flag : computeFlag(r.code) }));
/* Flag component: ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ•ŸäŸÖŸàÿ¨Ÿä ÿ•ŸÑŸâ SVG */
const Flag = ({emoji}) => {
  const ref = useRef(null);
  const online = typeof navigator !== "undefined" ? navigator.onLine : true;
  useEffect(() => {
    if (!ref.current) return;
    let display = "üè≥Ô∏è";
    if (isFlagEmoji(emoji)) display = emoji;
    // reset content each time to avoid duplicate nodes
    ref.current.textContent = display;
    if (display !== "üè≥Ô∏è" && online && window.twemoji) {
      try {
        window.twemoji.parse(ref.current, {
          folder: "svg",
          ext: ".svg",
          base: "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/",
          attributes: () => ({ loading: "lazy", decoding: "async", referrerpolicy: "no-referrer" })
        });
      } catch (_) {}
    }
  }, [emoji, online]);
  return <span ref={ref} className="flag-slot" aria-hidden="true">{emoji || "üè≥Ô∏è"}</span>;
};
/* ================== ÿ•ÿØÿÆÿßŸÑ ÿ£ÿ±ŸÇÿßŸÖ ÿ∞ŸÉŸä ================== */
const NumIn = ({ value, onChange, allowDecimal=false, min, max, className="", ...rest }) => {
  // Convert numbers to a non-scientific decimal string
  const formatForDisplay = useCallback((val) => {
    if (val === null || val === undefined) return "";
    if (typeof val === 'number') {
      // If the absolute value is between 0 and 1, check for exponential form.
      if (val !== 0 && Math.abs(val) < 1) {
        const s = val.toString();
        if (/e[-+]/i.test(s)) {
          const [base, exp] = s.split('e');
          const exponent = parseInt(exp, 10);
          // Negative exponent indicates a small decimal like 1e-9.
          if (exponent < 0) {
            // Remove decimal point from base and construct a zero‚Äëpadded fraction
            let baseStr = base.replace('.', '');
            // Remove leading minus if present and remember sign
            const sign = baseStr.startsWith('-') ? '-' : '';
            if (sign) baseStr = baseStr.slice(1);
            const zeros = '0'.repeat(Math.abs(exponent) - 1);
            return sign + '0.' + zeros + baseStr;
          }
        }
      }
    }
    return String(val);
  }, []);
  const [text,setText] = useState(value===0||value ? formatForDisplay(value) : "");
  useEffect(() => {
    setText(value===0 || value ? formatForDisplay(value) : "");
  }, [value, formatForDisplay]);
  const norm=(s,d)=>{
    if(s==null) return "";
    let o = String(s)
      .replace(/[\u0660-\u0669]/g,a=>"0123456789"[a.charCodeAt(0)-0x0660])
      .replace(/[\u06F0-\u06F9]/g,a=>"0123456789"[a.charCodeAt(0)-0x06F0])
      .replace(/\u066B/g,".")
      .replace(/\u066C/g,"")
      .replace(/,|\s/g,"");
    o = o.replace(d ? /[^0-9.]/g : /[^0-9]/g,"");
    if(d){
      const i=o.indexOf(".");
      if(i!==-1) o = o.slice(0,i+1)+o.slice(i+1).replace(/\./g,"");
    }
    return o;
  };
  const onCh = e => {
    let raw = e.target.value;
    let v = norm(raw, allowDecimal);
    // Update the visible text with the normalized value to avoid invalid characters
    if (allowDecimal && v === ".") {
      setText("0.");
      return;
    }
    setText(v);
    if(!v){ 
      onChange?.(null);
      return;
    }
    let n = allowDecimal ? parseFloat(v) : parseInt(v,10);
    if(!isNaN(n)){
      if(min!=null && n<min) n=min;
      if(max!=null && n>max) n=max;
      onChange?.(n);
    }
  };
  const onBl = () => {
    if (text === "" || text === ".") {
      setText("");
      onChange?.(null);
      return;
    }
    let v = norm(text, allowDecimal);
    let n = allowDecimal ? parseFloat(v) : parseInt(v, 10);
    if (!isFinite(n)) {
      setText("");
      onChange?.(null);
      return;
    }
    if (min != null && n < min) n = min;
    if (max != null && n > max) n = max;
    onChange?.(n);
    // When committing the value back to the input, always use a non
    // scientific representation so that users see the full decimal.
    setText(formatForDisplay(n));
  };
  return (
    <input
      lang="en"
      type="text"
      inputMode={allowDecimal?"decimal":"numeric"}
      pattern={allowDecimal?"[0-9.]*":"[0-9]*"}
      className={`table-numbers text-center ${className}`}
      value={text}
      onChange={onCh}
      onBlur={onBl}
      {...rest}
    />
  );
};
/* ================== ÿπŸÜÿßÿµÿ± Ÿàÿßÿ¨Ÿáÿ© ================== */
const Arrow=({dir="flat"})=>{
  const c=dir==="up"?"text-green-600":dir==="down"?"text-red-600":"text-blue-600";
  const d=dir==="up"?"M12 4l6 8H6l6-8z":dir==="down"?"M12 20l-6-8h12l-6 8z":"M5 12h14v2H5z";
  return <svg className={`${c} w-4 h-4 sm:w-5 sm:h-5`} viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d={d}/></svg>;
};
const ChangeBadge=({pct,className=""})=>{
  const n=+pct,pos=n>0,neg=n<0,dir=pos?"up":neg?"down":"flat";
  const badge=pos?"text-green-700 bg-green-100":neg?"text-red-700 bg-red-100":"text-blue-700 bg-blue-100";
  return <span className={`table-numbers inline-flex items-center gap-1.5 px-2 sm:px-3 py-1.5 rounded-xl font-bold shadow ${badge} ${className}`}><Arrow dir={dir}/>{`${pos?"+":neg?"‚àí":""}${Math.abs(n).toFixed(2)}%`}</span>;
};
const CurrencyInfo=({row,showName=true})=>{
  const isMobile = typeof window !== "undefined" && window.matchMedia && window.matchMedia("(max-width: 640px)").matches;
  const renderName = showName && !isMobile;
  return (
    <div className="flex items-center currency-cell-mobile gap-2 sm:gap-3 min-w-0">
      <Flag emoji={row.flag} />
      <div className="flex items-center gap-2 min-w-0 flex-1">
        <span className="font-extrabold text-sm sm:text-base md:text-lg">{row.code}</span>
        {renderName && (
          <div className="name-box">
            <span className="name-track currency-name">{row.name}</span>
          </div>
        )}
        {row.icon && (
          <span className="icon-pill-after hidden sm:inline px-2 py-0.5 rounded bg-gray-300 text-gray-800 text-[10px] sm:text-xs align-middle">{row.icon}</span>
        )}
      </div>
    </div>
  );
};const PricePill=({value,type="buy",className=""})=>{
  const g=type==="buy"?"from-green-500 to-green-700":"from-red-500 to-red-700";
  return <span className={`table-numbers inline-flex items-center justify-center min-w-[8ch] sm:min-w-[10ch] px-3 sm:px-5 py-1.5 rounded-xl font-black shadow bg-gradient-to-r ${g} text-white text-sm sm:text-lg md:text-xl ${className}`}>{fmt(value)}</span>;
};
/* ================== ÿßŸÑÿ≠ÿ≥ÿßÿ® ================== */
/*
 * Safely compute the local buy/sell price for a currency relative to the USD.
 * Ratios are normalised so that only strictly positive values are used.
 * Invalid or missing ratios default to 1 to avoid division by zero or
 * scientific notation when editing values.
 */
const calcPrice = (row, usd) => {
  // USD rows simply mirror the USD buy/sell values
  if (row.code === "USD") {
    return { buy: usd.buy, sell: usd.sell };
  }
  // Extract numeric ratio values.  toNum(null) yields 0, so we get 0 for
  // empty or invalid entries.  Negative values are not possible via the
  // input component because only digits and a decimal point are permitted.
  const rawBuy = toNum(row.ratioBuy);
  const rawSell = toNum(row.ratioSell);
  // Ensure we never divide or multiply by zero or a falsy value.  Default to
  // 1 when the ratio is not a strictly positive number.  This prevents
  // Infinity or zero results while editing.  During saving the data is
  // sanitised to enforce positive ratios.
  const buyRatio = rawBuy > 0 ? rawBuy : 1;
  const sellRatio = rawSell > 0 ? rawSell : 1;
  if (row.method === "divide") {
    return {
      buy: Math.round(usd.buy / buyRatio),
      sell: Math.round(usd.sell / sellRatio)
    };
  }
  return {
    buy: Math.round(usd.buy * buyRatio),
    sell: Math.round(usd.sell * sellRatio)
  };
};
const composeRows = (data, base) => {
  // Locate the USD entry once so that we can normalise all other currencies
  const usd = data.find(d => d.code === "USD") || { buy: 5000, sell: 5050 };
      return data.map(r => {
    const { buy, sell } = calcPrice(r, usd);
    const baseEntry = base[r.code];
        // numbers; newer ones wrap the sell price inside an object.  When an
        let baseSell = 0;
    if (typeof baseEntry === "object" && baseEntry !== null) {
      baseSell = toNum(baseEntry.sell);
    } else if (baseEntry != null) {
      baseSell = toNum(baseEntry);
    }
        let changePct = 0;
    if (baseSell > 0) {
      changePct = ((sell - baseSell) / baseSell) * 100;
    }
    return { ...r, buy, sell, changePct };
  });
};
// --
// Ensure that each currency entry has valid ratio values.  When users edit
// currencies (for example during bulk operations or USD edits) they can
// accidentally remove or zero out the ratio values.  Downstream calculations
// depend on ratioBuy and ratioSell being positive numbers.  Defining
// sanitizeData at top level makes it accessible from any handler and avoids
// undefined reference errors (previously sanitizeData was scoped inside
// composeRows and inaccessible in the Save handler).
const sanitizeData = (list) => list.map(r => ({
  ...r,
  ratioBuy: r.ratioBuy > 0 ? r.ratioBuy : 1,
  ratioSell: r.ratioSell > 0 ? r.ratioSell : 1
}));
/* ================== ÿ∑ÿ±ŸÇ ÿßŸÑÿπÿ±ÿ∂ ================== */
const CardsView = ({ rows, onEditUSD, canEditUSD }) => {
  // Determine mobile view once per render to toggle long currency names
  const isMobile = typeof window !== "undefined" && window.matchMedia && window.matchMedia("(max-width: 640px)").matches;
  return (
  <div className="p-1 sm:p-0 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-1 sm:gap-2 md:gap-2">
    {rows.map(r=>(
      <div key={r.code} className={`view-card hover:shadow-md transition ${(r.code==="USD" && canEditUSD)?"cursor-pointer":""}`} onClick={()=> (r.code==="USD" && canEditUSD) && onEditUSD(r)}>
        <CurrencyInfo row={r} showName={!isMobile} />
        <div className="mt-2 grid grid-cols-3 items-end card-grid-mobile gap-1" dir="rtl">
          <div className="text-center">
            <div className="card-label">ÿ¥ÿ±ÿßÿ°</div>
            <PricePill value={r.buy} type="buy" className="pill-card w-full text-sm"/>
          </div>
          <div className="text-center">
            <div className="card-label">ŸÖÿ®Ÿäÿπ</div>
            <PricePill value={r.sell} type="sell" className="pill-card w-full text-sm"/>
          </div>
          <div className="text-center">
            <div className="card-label">ÿßŸÑÿ™ÿ∫ŸäŸëÿ±</div>
            <ChangeBadge pct={r.changePct} className="w-full justify-center text-xs pill-card"/>
          </div>
        </div>
      </div>
    ))}
  </div>
  );
};
const BoardView=({rows,head,onEditUSD, canEditUSD})=>{
  const isMobile = typeof window !== "undefined" && window.matchMedia && window.matchMedia("(max-width: 640px)").matches;
  return (
  <div className="w-full">
    <div className={`board-head grid grid-cols-[1fr_0.9fr_0.9fr_0.8fr] sm:grid-cols-[1.2fr_1fr_1fr_0.8fr] items-center h-12 sm:h-14 px-3 sm:px-6 ${head}`}>
      <div className="font-bold text-sm sm:text-xl text-right">üåê ÿßŸÑÿπŸÖŸÑÿ©</div>
      <div className="font-bold text-sm sm:text-xl text-center sm:pl-20">üíµ ÿ¥ÿ±ÿßÿ°</div>
      <div className="font-bold text-sm sm:text-xl text-center">üí∞ ŸÖÿ®Ÿäÿπ</div>
      <div className="font-bold text-sm sm:text-xl text-center">üìà ÿßŸÑÿ™ÿ∫ŸäŸëÿ±</div>
    </div>
    <div className="divide-y divide-gray-200">
      {rows.map(r=>(
        <div key={r.code} className={`board-row grid grid-cols-[1fr_0.9fr_0.9fr_0.8fr] sm:grid-cols-[1.2fr_1fr_1fr_0.8fr] items-center gap-2 px-2 sm:px-4 py-2.5 sm:py-1.5 ${(r.code==="USD" && canEditUSD)?"cursor-pointer":""}`} onClick={()=> (r.code==="USD" && canEditUSD) && onEditUSD(r)}>
          <div className="flex items-center gap-2 sm:gap-3">
            <CurrencyInfo row={r} showName={!isMobile} />
          </div>
          <div className="flex justify-center sm:pl-20"><PricePill value={r.buy} type="buy" className="pill-buy"/></div>
          <div className="flex justify-center"><PricePill value={r.sell} type="sell" className="pill-sell"/></div>
          <div className="flex justify-center"><ChangeBadge pct={r.changePct} className="cell-change-mobile change-pill"/></div>
        </div>
      ))}
    </div>
  </div>
);};
/* ================== ŸÑÿßÿ¶ÿ≠ÿ© ÿßÿÆÿ™Ÿäÿßÿ± ÿπŸÖŸÑÿ© (ÿ™ÿµŸÖŸäŸÖ ÿ¨ÿØŸäÿØ) ================== */
const MobilePickList = ({rows, action="edit", onChoose}) => {
  const label = action==="delete" ? "ÿ≠ÿ∞ŸÅ" : "ÿ™ÿ≠ÿ±Ÿäÿ±";
  const labelCls = action==="delete" ? "text-red-600" : "text-slate-500";
  return (
    <div className="grid gap-2 pick-list">
      {rows.map(r => (
        <button key={r.code}
          type="button"
          onClick={()=>onChoose(r)}
          className="w-full text-right rounded-2xl border border-white/50 bg-white/30 hover:bg-white/50 backdrop-blur-md shadow-inner px-3 py-3 transition"
        >
          <div className="flex items-center justify-between gap-3">
            <span className={`text-sm font-semibold ${labelCls}`}>{label}</span>
            <div className="flex items-center gap-2">
              <span className="flex items-center gap-2">
                <span className="font-extrabold text-slate-700">{r.name}</span>
                <span className="mx-1">‚Äî</span>
                <span className="inline-flex font-black text-slate-900">{r.code}</span>
              </span>
              <Flag emoji={r.flag}/>
            </div>
          </div>
        </button>
      ))}
    </div>
  );
};
/* ================== ŸÖŸàÿØÿßŸÑ ÿßŸÑŸàŸÇÿ™ ================== */
function DatetimeModal({open,onClose,dt,autoTime,setDT,setAuto,setToast}){
  const [tmpDt,setTmpDt]=useState({...dt});
  const [tmpAuto,setTmpAuto]=useState(autoTime);
  const [isoDate,setIsoDate]=useState(dt.date?dmyToIso(dt.date):"");
  useEffect(()=>{ if(open){ setTmpDt({...dt}); setTmpAuto(autoTime); setIsoDate(dt.date?dmyToIso(dt.date):"") }},[open,dt,autoTime]);
  const save=()=>{
    if(!tmpAuto){
      if(!isValidTime(tmpDt.time||"")){ setToast({text:"ÿµŸäÿ∫ÿ© ÿßŸÑŸàŸÇÿ™ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ© (HH:MM)", type:"error"}); return; }
      if(!isoDate){ setToast({text:"ÿßÿÆÿ™ÿ± ÿ™ÿßÿ±ŸäÿÆŸãÿß ÿµÿ≠Ÿäÿ≠Ÿãÿß", type:"error"}); return; }
      const dmy=isoToDmy(isoDate);
      if(!isValidDateDMY(dmy)){ setToast({text:"ÿµŸäÿ∫ÿ© ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©", type:"error"}); return; }
      setDT(v=>({...v,time:tmpDt.time,date:dmy,is12:!!tmpDt.is12}));
    }else{
      setDT(v=>({...v,is12:!!tmpDt.is12}));
    }
    setAuto(!!tmpAuto);
    setToast({text:"ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸàŸÇÿ™", type:"success"});
    onClose();
  };
  return (
    <Modal open={open} onClose={onClose} title="ÿ∂ÿ®ÿ∑ ÿßŸÑŸàŸÇÿ™ ŸàÿßŸÑÿ™ÿßÿ±ŸäÿÆ">
      <div className="flex flex-wrap items-center gap-4">
        <label className="inline-flex items-center gap-2">
          <input type="checkbox" checked={tmpAuto} onChange={e=>setTmpAuto(e.target.checked)}/>
          <span>ÿ™ÿ≠ÿØŸäÿ´ ÿ™ŸÑŸÇÿßÿ¶Ÿä</span>
        </label>
        <label className="inline-flex items-center gap-2">
          <input type="checkbox" checked={!!tmpDt.is12} onChange={e=>setTmpDt(v=>({...v,is12:e.target.checked}))}/>
          <span>ÿ™ŸÜÿ≥ŸäŸÇ 12 ÿ≥ÿßÿπÿ©</span>
        </label>
      </div>
      {!tmpAuto&&(
        <div className="grid sm:grid-cols-2 gap-3">
          <label className="grid gap-1">
            <span className="text-sm text-gray-600">ÿßŸÑŸàŸÇÿ™</span>
            <input type="time" className="fld table-numbers" value={(tmpDt.time||"").slice(0,5)} onChange={e=>setTmpDt(v=>({...v,time:e.target.value}))}/>
          </label>
          <label className="grid gap-1">
            <span className="text-sm text-gray-600">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</span>
            <input type="date" className="fld table-numbers" value={isoDate} onChange={e=>setIsoDate(e.target.value)}/>
          </label>
        </div>
      )}
      <div className="btn-row flex justify-end gap-2 pt-2">
        <Btn className="text-white bg-red-600 w-32 h-11" onClick={()=>{onClose(); setToast({text:"‚ùå ÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ°", type:"error"})}}>ÿ•ŸÑÿ∫ÿßÿ°</Btn>
        <Btn className="text-white bg-green-600 w-32 h-11" onClick={save}>ÿ≠ŸÅÿ∏</Btn>
      </div>
    </Modal>
  );
}
/* ================== ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä ================== */
function App(){
  const cachedApp = loadCache();
  const [lastSync,setLastSync] = useState(cachedApp?.lastSync || null);

  // ====== ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ (ÿ£ŸàŸÜŸÑÿßŸäŸÜ/ÿ£ŸàŸÅŸÑÿßŸäŸÜ) ======
  const [online, setOnline] = useState(navigator.onLine);
  // ÿπÿ±ÿ∂ ÿßŸÑÿ™Ÿàÿ≥ÿ™ ŸÅŸÇÿ∑ ÿπŸÜÿØ ÿ™ÿ≠ŸàŸÑ ÿßŸÑŸÑŸÖÿ®ÿ© ŸÖŸÜ ÿ£ÿ≠ŸÖÿ± ÿ•ŸÑŸâ ÿ£ÿÆÿ∂ÿ±
  const prevOnline = useRef(navigator.onLine);
  useEffect(() => {
    // ŸÑÿß ÿ™ÿπŸÖŸÑ ÿ¥Ÿäÿ° ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ÿ™ÿ∫Ÿäÿ± ÿßŸÑÿ≠ÿßŸÑÿ©
    if (prevOnline.current === online) {
      return;
    }
    // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿ£ŸàŸÅŸÑÿßŸäŸÜ (ÿ£ÿ≠ŸÖÿ±) Ÿàÿµÿßÿ±ÿ™ ÿ£ŸàŸÜŸÑÿßŸäŸÜ (ÿ£ÿÆÿ∂ÿ±) ‚Üí ÿ£ÿ∏Ÿáÿ± ÿßŸÑÿ™Ÿàÿ≥ÿ™
    if (prevOnline.current === false && online === true) {
      setToast({ text: "üîÑ ÿ™ŸÖÿ™ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ‚Äî ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©", type: "info" });
    }
    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©
    prevOnline.current = online;
  }, [online]);
  useEffect(() => {
    const goOnline = () => {
    setOnline(true);
  };
    const goOffline = () => setOnline(false);
    window.addEventListener("online", goOnline);
    window.addEventListener("offline", goOffline);
    return () => {
      window.removeEventListener("online", goOnline);
      window.removeEventListener("offline", goOffline);
    };
  }, []);

  // ====== ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ•ÿµÿØÿßÿ± (Ÿäÿπÿ™ŸÖÿØ ŸÅŸÇÿ∑ ÿπŸÑŸâ ÿ±ŸÇŸÖ ÿßŸÑÿ•ÿµÿØÿßÿ±) ======
  useEffect(()=>{
    try {
      const stored = StorageManager.load();
      if (!stored) {
        // ÿ£ŸàŸÑ ŸÖÿ±ÿ© ŸäŸÅÿ™ÿ≠ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ‚Üí ŸÜŸÉÿ™ÿ® ÿßŸÑÿ•ÿµÿØÿßÿ±
        StorageManager.save({ version: APP_VERSION });
      } else if (stored.version !== APP_VERSION) {
        // ÿ•ÿ∞ÿß ÿßŸÑÿ•ÿµÿØÿßÿ± ŸÖÿÆÿ™ŸÑŸÅ ‚Üí ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿ®ÿßŸÑŸÉÿßŸÖŸÑ (ÿ≠ÿ≥ÿ® ÿßŸÑŸÇÿßÿπÿØÿ© ŸÑÿØŸäŸÉ)
        
        StorageManager.save({ version: APP_VERSION });
        setToast({ text: "‚ÑπÔ∏è ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©...", type: "info" });
        // ÿ®ÿπÿØ ÿ£ŸàŸÑ Snapshot ÿ±ÿ¶Ÿäÿ≥Ÿä (data) ‚Üí ŸÜÿπÿ±ÿ∂ Toast ÿßŸÑŸÜÿ¨ÿßÿ≠
        const unsub = window.$db?.onValue(window.$db.ref('taif/data'), (snap)=>{
          if (snap.val()) {
            setToast({ text: "‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™", type: "success" });
            if (unsub) window.$db.off(window.$db.ref('taif/data'));
          }
        });
      }
    } catch(e) { console.error("Version check error", e); }
  }, []);
/* ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÜ LocalStorage */
  const p=readJSON(K.DATA,null),
        pBanner=readJSON(K.BANNER,null),
        pDT=readJSON(K.DT,null);
  const initStored = StorageManager.load() || {};
  const [logo,setLogo] = useState(cachedApp?.logo || "");
  const [title,setTitle] = useState(cachedApp?.title || "ŸÑŸàÿ≠ÿ© ÿ£ÿ≥ÿπÿßÿ± ÿµÿ±ŸÅ ÿßŸÑÿπŸÖŸÑÿßÿ™");
  const [bannerImg,setBannerImg] = useState(cachedApp?.bannerImg || "");
  /* ÿßŸÑÿ´ŸäŸÖ */
  // Retrieve the theme from localStorage.  We ignore any theme from cachedApp
  // (Supabase snapshot) so that each user's selection remains local.  If no
  // value is stored yet we fall back to the default theme (empty string).
  let pTheme;
  try {
    pTheme = localStorage.getItem(K.THEME);
  } catch (_) {
    pTheme = null;
  }
  const [theme,setTheme] = useState(pTheme || "");
  useEffect(()=>{
  const body=document.getElementById("body");
  const t=THEME_MAP[theme];
  const cls=theme&&THEME_WHITELIST.has(theme)?theme:"bg-gradient-to-tr from-cyan-200 via-white to-cyan-200 text-gray-900";
  const idClass=t?`th-${t.id}`:"th-default";
  body.className=`min-h-screen transition-colors duration-500 ${cls} ${idClass}`;
  try{ const bg=document.getElementById("bgfix"); if(bg){ bg.className=`bg-fixed-gradient bg-gradient-to-tr ${bannerCls(theme)}`; } }catch(_){};
},[theme]);
  // Persist the selected theme to localStorage whenever it changes.  This
  // ensures that users keep their personal theme across sessions.
  useEffect(() => {
    try {
      localStorage.setItem(K.THEME, theme);
    } catch (_) {}
  }, [theme]);
  /* ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© */
  const cached = readJSON(K.DATA, null);
  const cachedData = (initStored && initStored.data) || (cached && cached.data) || null;
  const [data,setData] = useState(cachedApp?.data || []);
  /* autosave removed: caching handled via Supabase snapshot */
  /* ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ */
  const defB={texts:["üì¢ ÿ£ŸáŸÑÿßŸã ÿ®ŸÉŸÖ","üíµ ÿ£ÿ≥ÿπÿßÿ±ŸÜÿß ÿ™ŸÜÿßŸÅÿ≥Ÿäÿ© ŸäŸàŸÖŸäŸãÿß","üåê ÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÜÿß"],color:"#000000",moveDur:1.5,stayDur:3};
  const initB={...defB,...(pBanner||{})};
  const [banner,setBanner] = useState(cachedApp?.banner || defB);
  const [bTmp,setBTmp]=useState({...banner});
  useEffect(()=>{saveJSON(K.BANNER,banner)},[banner]);
  /* ÿßŸÑŸàŸÇÿ™ ŸàÿßŸÑÿ™ÿßÿ±ŸäÿÆ */
  const [dt,setDT] = useState(cachedApp?.datetime || {date:"",time:"",is12:false});
  const [autoTime,setAuto]=useState(true);
  useEffect(()=>{saveJSON(K.DT,dt)},[dt]);

  // ==== ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ Ÿàÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ====
  // ŸÜÿ≠ÿßŸàŸÑ ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑÿ¨ŸÑÿ≥ÿ© ŸÖŸÜ localStorage Ÿàÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä ÿ®ÿØŸàŸÜ ŸÅÿ™ÿ±ÿ© ÿßŸÜÿ™Ÿáÿßÿ° ÿµŸÑÿßÿ≠Ÿäÿ©
  const [currentUser, setCurrentUser] = useState(() => {
    try {
      const s = localStorage.getItem('taif:session');
      if (s) {
        const sess = JSON.parse(s);
        if (sess) {
          return sess;
        }
      }
    } catch (_) {}
    return null;
  });
  // ÿ≠ŸÇŸàŸÑ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
  const [loginUser, setLoginUser] = useState('');
  const [loginPass, setLoginPass] = useState('');
  const [loginErr, setLoginErr] = useState('');
  // ŸÑŸÜ ŸÜÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸàÿØÿßŸÑ ŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ÿπÿØ ÿßŸÑÿ¢ŸÜÿõ ÿ≥ŸÜÿπÿ±ÿ∂ ÿµŸÅÿ≠ÿ© ŸÉÿßŸÖŸÑÿ©
  const [loginModalOpen, setLoginModalOpen] = useState(false);
  // ŸÑŸàÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ (ŸÑŸÑÿ≥Ÿàÿ®ÿ±ÿ£ÿØŸÖŸÜ)
  const [adminModalOpen, setAdminModalOpen] = useState(false);
  // ÿ≠ÿßŸÑÿ© ŸÑÿ™ÿ≠ÿØŸäÿØ ŸÖÿß ÿ•ÿ∞ÿß ŸÉŸÜÿß ŸÅŸä Ÿàÿ∂ÿπ ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ. ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ true ŸÜÿ∏Ÿáÿ± ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑŸÅÿßÿ±ÿ∫.
  const [addingUser, setAddingUser] = useState(false);
  const [usersList, setUsersList] = useState({});
  const [editUserName, setEditUserName] = useState(null);
  // ==== ÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿ•ÿØÿßÿ±ÿ© ====
  // ÿ≠ÿßŸÑÿ© ŸÑŸÅÿ™ÿ≠ Ÿàÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ≥ÿ¨ŸÑ
  const [logsModalOpen, setLogsModalOpen] = useState(false);
  // ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿ™Ÿä ÿ™ŸÖ ÿ¨ŸÑÿ®Ÿáÿß ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
  const [logsList, setLogsList] = useState([]);
  // ÿØÿßŸÑÿ© ŸÑŸÅÿ™ÿ≠ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿØÿßÿ±ÿ©: Ÿäÿ¨ŸÑÿ® ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ŸÖŸÜ Supabase ŸàŸäÿπÿ±ÿ∂Ÿáÿß ŸÅŸä ŸÜÿßŸÅÿ∞ÿ© ÿÆÿßÿµÿ©
  const openLogs = () => {
    const fb = dbRef.current;
    if (!fb) {
      setToast({ text: '‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™', type: 'error' });
      return;
    }
    // ÿßÿ≥ÿ™ÿÆÿØŸÖ onValue ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸÑÿ¨ŸÑÿ® ÿßŸÑÿ≥ÿ¨ŸÑÿå ÿ´ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ
    const r = window.$db.ref('taif/adminactionslog');
    const unsub = window.$db.onValue(r, (snap) => {
      const obj = snap.val() || {};
      // ÿ≠ŸàŸëŸÑ ÿßŸÑŸÉÿßÿ¶ŸÜ ÿ•ŸÑŸâ ŸÖÿµŸÅŸàŸÅÿ©ÿå ÿ´ŸÖ ÿ±ÿ™Ÿëÿ®Ÿáÿß ÿ™ŸÜÿßÿ≤ŸÑŸäŸãÿß ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
      // ÿ≠ŸàŸëŸÑ ÿßŸÑŸÉÿßÿ¶ŸÜ ÿ•ŸÑŸâ ŸÖÿµŸÅŸàŸÅÿ©ÿå ÿ´ŸÖ ÿ±ÿ™Ÿëÿ®Ÿáÿß ÿ™ŸÜÿßÿ≤ŸÑŸäŸãÿß ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
      const list = Object.values(obj).sort((a, b) => {
        const atA = a && a.at ? a.at : 0;
        const atB = b && b.at ? b.at : 0;
        return atB - atA;
      });
      setLogsList(list);
      setLogsModalOpen(true);
      if (unsub) window.$db.off(r);
    });
  };
  // ÿØÿßŸÑÿ© ŸÑŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
  const clearLogs = () => {
    if (!window.confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÖÿ≥ÿ≠ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿ®ÿßŸÑŸÉÿßŸÖŸÑÿü')) return;
    const fb = dbRef.current;
    if (!fb) {
      setToast({ text: '‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™', type: 'error' });
      return;
    }
    try {
      window.$db.set(window.$db.ref('taif/adminactionslog'), null);
      setLogsList([]);
      setToast({ text: '‚úÖ ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ¨ŸÑ ÿ®ŸÜÿ¨ÿßÿ≠', type: 'success' });
    } catch (_) {
      setToast({ text: '‚ö†Ô∏è ÿ™ÿπÿ∞ÿ± ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ¨ŸÑ', type: 'error' });
    }
  };
  // ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÉŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ. ÿ≥Ÿäÿ™ŸÖ ÿπÿ±ÿ∂Ÿáÿß ŸÉŸÖÿ¨ŸÖŸàÿπÿ© ŸÖŸÜ ŸÖÿ±ÿ®ÿπÿßÿ™ ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ± ŸÅŸä ŸÑŸàÿ≠ÿ© ÿßŸÑÿ•ÿØÿßÿ±ÿ©.
  // key: ÿßÿ≥ŸÖ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ© ŸÉŸÖÿß ŸáŸà ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä hasPermissionÿå label: ŸÜÿµ ÿßŸÑÿ≤ÿ± ÿ£Ÿà ÿßŸÑŸàÿµŸÅ ÿßŸÑÿ∏ÿßŸáÿ± ŸÑŸÑŸÖÿ¥ÿ±ŸÅ.
  const PERMISSIONS = [
    { key: 'editUSD', label: 'üíµ ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿØŸàŸÑÿßÿ±' },
    { key: 'bulkEdit', label: 'üõ†Ô∏è ÿ™ÿπÿØŸäŸÑ ŸÉŸÑ ÿßŸÑÿπŸÖŸÑÿßÿ™' },
    { key: 'addCurrency', label: '‚ûï ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÖŸÑÿ©' },
    { key: 'editCurrency', label: '‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ ÿπŸÖŸÑÿ©' },
    { key: 'deleteCurrency', label: 'üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿπŸÖŸÑÿ©' },
    { key: 'editBanner', label: '‚ö° ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™' },
    { key: 'changeView', label: 'üéõÔ∏è ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿπÿ±ÿ∂' },
    { key: 'changeTheme', label: 'üé® ÿßŸÑÿ´ŸäŸÖ' },
    { key: 'editLogo', label: 'üñºÔ∏è ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÑŸàÿ∫Ÿà/ÿßŸÑÿπŸÜŸàÿßŸÜ' },
    { key: 'adjustDatetime', label: 'üïí ÿ∂ÿ®ÿ∑ ÿßŸÑŸàŸÇÿ™' }
    ,{ key: 'manageUsers', label: 'üë§ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ' }
  ,
    { key: 'viewAdminLogs', label: 'üìú ÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿ•ÿØÿßÿ±ÿ©' },
{ key: 'logout',        label: 'üö™ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨' }
];

  // ÿÆÿ±Ÿäÿ∑ÿ© ŸÑÿ™ÿ≠ŸàŸäŸÑ ŸÖŸÅÿßÿ™Ÿäÿ≠ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿ•ŸÑŸâ ÿßŸÑÿ™ÿ≥ŸÖŸäÿßÿ™ ÿßŸÑŸÖŸÇÿ±Ÿàÿ°ÿ©
  const permLabelMap = PERMISSIONS.reduce((acc, p) => {
    acc[p.key] = p.label;
    return acc;
  }, {});
  // ÿ®ŸäÿßŸÜÿßÿ™ ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÑŸÑÿ•ÿ∂ÿßŸÅÿ©/ÿßŸÑÿ™ÿπÿØŸäŸÑ
  // username: ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
  // password: ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑŸÜÿµŸäÿ© (ŸÑŸäÿ≥ÿ™ ŸÖÿ¥ŸÅÿ±ÿ©)
  // role: Ÿäÿ®ŸÇŸâ ŸÖŸàÿ¨ŸàÿØÿßŸã ŸÑŸÑÿ™ŸàÿßŸÅŸÇÿå ŸÑŸÉŸÜŸá ÿ≥ŸäŸèÿπŸäŸëŸÜ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑÿ¨ÿØÿØ (admin) ŸàŸäŸèÿ≠ÿßŸÅÿ∏ ÿπŸÑŸäŸá ÿπŸÜÿØ ÿßŸÑÿ™ÿπÿØŸäŸÑ
  // perms: ŸÉÿßÿ¶ŸÜ ŸäŸÖÿ´ŸëŸÑ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ÿõ ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠ ŸáŸä ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ŸàÿßŸÑŸÇŸäŸÖ true/false
  // ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿßŸÑÿßÿ≥ŸÖ ÿ£Ÿäÿ∂Ÿãÿß
  const [userForm, setUserForm] = useState({ username:'', password:'', name:'', role:'', perms:{} });
  const [adminErr, setAdminErr] = useState('');

  // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ≠ÿßŸÑŸä ŸÅŸÑŸÜ ŸÜÿ∏Ÿáÿ± ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿ≠ÿ™Ÿâ Ÿäÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ. ŸÑŸÜ ŸÜÿ≥ÿ™ÿÆÿØŸÖ loginModalOpen ŸÑŸáÿ∞ÿß ÿßŸÑÿ∫ÿ±ÿ∂.
  // ŸäŸÖŸÉŸÜ ŸÑÿßÿ≠ŸÇŸãÿß ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ loginModalOpen ŸÑÿ£ÿ∫ÿ±ÿßÿ∂ ÿ£ÿÆÿ±Ÿâ.

  // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
  const handleLogin = async (e) => {
    if (e) e.preventDefault();
    setLoginErr('');
    if (!loginUser || !loginPass) {
      // ÿπŸÜÿØ ÿ™ÿ±ŸÉ ÿßŸÑÿ≠ŸÇŸàŸÑ ŸÅÿßÿ±ÿ∫ÿ© ŸÑÿß Ÿäÿ™ŸÖ ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
      setLoginErr('‚ö†Ô∏è ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸàŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±');
      return;
    }
    try {
      // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ŸáŸäÿ¶ÿ© Supabase ŸÅŸä window.$db ÿ£ŸàŸÑÿßŸã. ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ÿ¨ÿßŸáÿ≤Ÿãÿßÿå ŸÜÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÜÿ™ÿ∏ÿßÿ± ŸàŸÑÿß ŸÜÿ≠ÿßŸàŸÑ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ.
      if (!window.$db) {
        setLoginErr('‚è≥ Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±ÿå ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
        return;
      }
      const fb = dbRef.current;
      if (!fb) {
        setLoginErr('‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
        return;
      }
      // ÿßÿ¨ŸÑÿ® ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ Ÿàÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÖÿ∑ŸÑŸàÿ® ÿ®ÿØŸÑÿßŸã ŸÖŸÜ ÿ¨ŸÑÿ® ŸÖÿ≥ÿßÿ± Ÿàÿßÿ≠ÿØ
      const uRef = window.$db.ref('taif/users');
      const unsub = window.$db.onValue(uRef, (snap) => {
        const users = snap.val() || {};
        const obj = users[loginUser];
        // ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿ®ÿπÿØ ÿ¨ŸÑÿ® ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©
        if (unsub) window.$db.off(uRef);
        if (!obj) {
          setLoginErr('‚ö†Ô∏è ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
          try { window.Log && window.Log.loginFail && window.Log.loginFail(loginUser); } catch(_) {}
          return;
        }
        // ÿ®ÿπÿ∂ ÿßŸÑÿ®ŸÜŸâ ÿ™ÿÆÿ≤ŸÜ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÅŸä ÿ≠ŸÇŸÑ password ÿ£Ÿà passwordHash
        const hash = obj.password || obj.passwordHash || '';
        try {
          const bcryptObj = window.bcrypt || (window.dcodeIO && window.dcodeIO.bcrypt);
          if (!bcryptObj) {
            setLoginErr('‚ö†Ô∏è ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑÿ™ÿ≠ŸÇŸÇ');
            return;
          }
          bcryptObj.compare(loginPass, hash, function(err, same) { 
            if (err || !same) {
              setLoginErr('‚ö†Ô∏è ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
              try { window.Log && window.Log.loginFail && window.Log.loginFail(loginUser); } catch(_) {}
              return;
            }
            // permissions array
            let perms = [];
            if (Array.isArray(obj.permissions)) perms = obj.permissions;
            else if (obj.permissions && typeof obj.permissions === 'object') {
              perms = Object.keys(obj.permissions).filter(k => obj.permissions[k]);
            }

            // === Single-device lock ===
            const deviceId = ensureDeviceId();
            const lockKey  = `taif/session/${loginUser}`;
            const lockRef  = window.$db.ref(lockKey);
            const once = window.$db.onValue(lockRef, async (snap2) => {
              if (once) window.$db.off(lockRef);
              const lock = snap2 && snap2.val ? snap2.val() : null;
              if (lock && lock.deviceId && lock.deviceId !== deviceId) {
                setLoginErr('‚õî Ÿáÿ∞ÿß ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸÖŸÇŸÅŸàŸÑ ÿπŸÑŸâ ÿ¨Ÿáÿßÿ≤ ÿ¢ÿÆÿ±. ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ÿßŸÑÿ¨Ÿáÿßÿ≤ ÿßŸÑÿ£ŸàŸÑ ÿ£ŸàŸÑÿßŸã.');
                try { window.Log && window.Log.loginFail && window.Log.loginFail(loginUser); } catch(_) {}
                return;
              }
              const token = (crypto.randomUUID && crypto.randomUUID()) || (Date.now() + '_' + Math.random().toString(36).slice(2));
              try { localStorage.setItem('taif:session_token', token); } catch(_){}

              await window.$db.set(lockRef, {
                deviceId,
                token,
                ua: navigator.userAgent,
                lockedAt: Date.now(),
                lastSeen: Date.now()
              });

              const sess = { username: loginUser, role: obj.role || '', permissions: perms };
              try { localStorage.setItem('taif:session', JSON.stringify(sess)); } catch (_) {}
              setCurrentUser(sess);
              setLoginModalOpen(false);
              setLoginUser('');
              setLoginPass('');
              setLoginErr('');
              setToast({ text: '‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠', type: 'success' });
              try { window.Log && window.Log.loginSuccess && window.Log.loginSuccess(loginUser); } catch(_) {}
            });
        
        });
        } catch (err) {
          console.error(err);
          setLoginErr('‚ö†Ô∏è ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±');
        }
      });
    } catch (err) {
      console.error(err);
      setLoginErr('‚ö†Ô∏è ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ');
      try { window.Log && window.Log.loginFail && window.Log.loginFail(loginUser); } catch(_) {}
    }
  };

  // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
  const handleLogout = async () => {
    try {
      const me = currentUser && currentUser.username;
      if (me) { await window.$db.set(window.$db.ref(`taif/session/${me}`), null); }
      try { localStorage.removeItem('taif:session_token'); } catch(_){ }
    } catch(_){ }

    try { localStorage.removeItem('taif:session'); } catch (_) {}
    setCurrentUser(null);
    setLoginModalOpen(true);
    try { window.Log && window.Log.logout && window.Log.logout((currentUser && currentUser.username) || ''); } catch(_) {}
  };

  // ŸÅÿ≠ÿµ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: Ÿäÿ±ÿ¨ÿπ true ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸäŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ŸÉÿßŸÖŸÑÿ© (ÿ≥Ÿàÿßÿ° ÿ≥Ÿàÿ®ÿ±ÿ£ÿØŸÖŸÜ ÿ£Ÿà ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶)ÿå ÿ£Ÿà ŸäŸÖŸÑŸÉ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© ÿµÿ±ÿßÿ≠ÿ©Ÿã
  const hasPermission = useCallback((perm) => {
    if (!currentUser) return false;
    // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶ ŸàÿßŸÑÿ≥Ÿàÿ®ÿ±ÿ£ÿØŸÖŸÜ ŸäŸÖÿ™ŸÑŸÉÿßŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™
    if (currentUser.role === 'superadmin' || currentUser.role === 'emergency') return true;
    return Array.isArray(currentUser.permissions) && currentUser.permissions.includes(perm);
  }, [currentUser]);

// ==== Live account watcher: force logout on delete / ban, live role & perms update with toast (added) ====
useEffect(() => {
  if (!currentUser) return;
  const r = window.$db.ref('taif/users');
  const unsub = window.$db.onValue(r, (snap) => {
    try {
      const users = snap.val() || {};
      const me = users[currentUser.username];
      if (!me) {
        setToast({ text: "üö™ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ≠ÿ≥ÿßÿ®ŸÉ ‚Äî ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨", type: "error" });
        handleLogout();
        return;
      }
      if (me.banned) {
        setToast({ text: "‚õî ÿ≠ÿ≥ÿßÿ®ŸÉ ŸÖŸàŸÇŸëŸÅ ‚Äî ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨", type: "error" });
        handleLogout();
        return;
      }
      const newRole = me.role || '';
      const newPerms = toPermArray(me.permissions);
      const oldPerms = Array.isArray(currentUser.permissions) ? currentUser.permissions : [];
      const roleChanged = (currentUser.role || '') !== newRole;
      const permsChanged = !arrEq(oldPerms, newPerms);
      if (roleChanged || permsChanged) {
        const updated = { ...currentUser, role: newRole, permissions: newPerms };
        setCurrentUser(updated);
        try { localStorage.setItem('taif:session', JSON.stringify(updated)); } catch (_) {}
        setToast({ text: "üîÑ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ŸÉ ŸÑÿ≠ÿ∏ŸäŸãÿß", type: "info" });
      }
    } catch (_){}
  });
  return () => { if (unsub) window.$db.off(r); };
}, [currentUser?.username]);


  // ÿ¨ŸÑÿ® ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿπŸÜÿØ ŸÅÿ™ÿ≠ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ•ÿØÿßÿ±ÿ©
  useEffect(() => {
    if (!adminModalOpen) return;
    const fb = dbRef.current;
    if (!fb) return;
    const r = window.$db.ref('taif/users');
    const unsub = window.$db.onValue(r, (snap) => {
      const obj = snap.val() || {};
      setUsersList(obj);
    });
    return () => {
      if (unsub) window.$db.off(r);
    };
  }, [adminModalOpen]);

  // ÿ≠ŸÅÿ∏ ÿ£Ÿà ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä ÿßŸÑŸÇÿßÿπÿØÿ©
  const handleSaveUser = async () => {
    setAdminErr('');
    const { username, password, name, role, perms } = userForm;
    if (!username || (!editUserName && !password)) {
      setAdminErr('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©');
      return;
    }
    try {
      const fb = dbRef.current;
      if (!fb) {
        setAdminErr('‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
        return;
      }
      const bcryptObj = window.bcrypt || (window.dcodeIO && window.dcodeIO.bcrypt);
      if (!bcryptObj) {
        setAdminErr('‚ö†Ô∏è ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±');
        return;
      }
      const oldUser = editUserName ? usersList[editUserName] : null;
      // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿØŸäÿ±Ÿãÿß ÿπÿßÿØŸäŸãÿßÿå ŸÑÿß ŸäŸèÿ≥ŸÖÿ≠ ŸÑŸá ÿ®ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿ¨ÿØÿØ
      if (!editUserName && currentUser && currentUser.role === 'admin') {
        setAdminErr('‚ö†Ô∏è ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ');
        return;
      }
      // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ™ÿπÿØŸäŸÑ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿ±ÿ™ÿ®ÿ©
      if (editUserName) {
        if (currentUser) {
          // ÿßŸÑŸÖÿØŸäÿ± ÿßŸÑÿπÿßÿØŸä ŸÑÿß ŸäŸÖŸÉŸÜŸá ÿ™ÿπÿØŸäŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¢ÿÆÿ±
          if (currentUser.role === 'admin' && editUserName !== currentUser.username) {
            setAdminErr('‚ö†Ô∏è ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ™ÿπÿØŸäŸÑ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ');
            return;
          }
          // ÿßŸÑÿ≥Ÿàÿ®ÿ±ÿ£ÿØŸÖŸÜ ŸÑÿß ŸäŸÖŸÉŸÜŸá ÿ™ÿπÿØŸäŸÑ ÿ≥Ÿàÿ®ÿ±ÿ£ÿØŸÖŸÜ ÿ¢ÿÆÿ± ÿ£Ÿà ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶
          if (currentUser.role === 'superadmin') {
            if (oldUser && (oldUser.role === 'superadmin' || oldUser.role === 'emergency')) {
              setAdminErr('‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿπÿØŸäŸÑ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®Ÿáÿ∞Ÿá ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™');
              return;
            }
          }
          // ÿ∫Ÿäÿ± ÿ∞ŸÑŸÉ (emergency) Ÿäÿ≥ŸÖÿ≠ ŸÑŸá ÿ®ŸÉŸÑ ÿ¥Ÿäÿ°
        }
      }
      // ÿ≠ŸÖÿßŸäÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶: ŸÖŸÜÿπ ÿ™ÿπÿØŸäŸÑ ÿ£Ÿà ÿ•ŸÜÿ¥ÿßÿ° ÿ£Ÿà ÿ™ÿπŸäŸäŸÜ ÿØŸàÿ± ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶ ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ÿ∫Ÿäÿ± ÿµÿßÿ≠ÿ® ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶
      if (oldUser && oldUser.role === 'emergency' && (!currentUser || currentUser.role !== 'emergency')) {
        setAdminErr('‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿπÿØŸäŸÑ ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶ ÿ•ŸÑÿß ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶');
        return;
      }
      // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿØŸàÿ± ÿßŸÑŸÖÿ∑ŸÑŸàÿ® ŸáŸà ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶ ŸàŸÑŸÉŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä ŸÑŸäÿ≥ ÿ∑Ÿàÿßÿ±ÿ¶ÿå ÿßŸÖŸÜÿπ ÿßŸÑÿπŸÖŸÑŸäÿ©
      if (!editUserName && role === 'emergency' && (!currentUser || currentUser.role !== 'emergency')) {
        setAdminErr('‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶ ÿ•ŸÑÿß ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶');
        return;
      }
      if (editUserName && role === 'emergency' && (!currentUser || currentUser.role !== 'emergency')) {
        setAdminErr('‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿ∫ŸäŸäÿ± ÿØŸàÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ•ŸÑŸâ ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶ ÿ•ŸÑÿß ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶');
        return;
      }
      const hashExisting = oldUser ? oldUser.password : null;
      const getHashed = (plain, callback) => {
        if (!plain) {
          callback(null, hashExisting);
          return;
        }
        bcryptObj.hash(plain, 10, function(err, hash) {
          callback(err, hash);
        });
      };
      getHashed(password, (err, hash) => {
        if (err) {
          setAdminErr('‚ö†Ô∏è ÿ™ÿπÿ∞ÿ± ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ®ÿµŸÖÿ©');
          return;
        }
        // ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ≠ÿØÿØ ÿßŸÑÿØŸàÿ±ÿå ŸÜÿπŸäŸëŸÜ admin ÿßŸÅÿ™ÿ±ÿßÿ∂ŸäŸãÿß ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑÿ¨ÿØÿØ ÿ£Ÿà ŸÜÿ≠ÿßŸÅÿ∏ ÿπŸÑŸâ ÿßŸÑÿØŸàÿ± ÿßŸÑŸÇÿØŸäŸÖ ÿπŸÜÿØ ÿßŸÑÿ™ÿπÿØŸäŸÑ
        let newRole = role;
        if (!newRole) {
          newRole = editUserName && oldUser && oldUser.role ? oldUser.role : 'admin';
        }
        // ÿ™ÿ≠ŸàŸäŸÑ ŸÉÿßÿ¶ŸÜ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿ•ŸÑŸâ ŸÖÿµŸÅŸàŸÅÿ© ŸÖŸÜ ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠ ÿßŸÑÿ™Ÿä ŸÇŸäŸÖÿ™Ÿáÿß true
        let permsArray = [];
        if (perms && typeof perms === 'object') {
          permsArray = Object.keys(perms).filter(k => perms[k]);
        }
        // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖÿØŸäÿ± ŸäÿπÿØŸÑ ŸÜŸÅÿ≥Ÿáÿå ŸÑÿß ŸäŸÖŸÉŸÜŸá ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿØŸàÿ± ÿ£Ÿà ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™
        if (editUserName && currentUser && currentUser.role === 'admin' && editUserName === currentUser.username) {
          if (oldUser) {
            // ÿßÿ≠ÿ™ŸÅÿ∏ ÿ®ÿßŸÑÿØŸàÿ± ÿßŸÑŸÇÿØŸäŸÖ
            newRole = oldUser.role;
            // ÿßÿ≠ÿ™ŸÅÿ∏ ÿ®ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©
            if (Array.isArray(oldUser.permissions)) {
              permsArray = oldUser.permissions;
            } else if (oldUser.permissions && typeof oldUser.permissions === 'object') {
              permsArray = Object.keys(oldUser.permissions).filter(k => oldUser.permissions[k]);
            }
          }
        }
        const newUserData = {
          role: newRole,
          permissions: permsArray,
          password: hash,
          name: name || ''
        };
        const key = editUserName || username;
        window.$db.set(window.$db.ref(`taif/users/${key}`), newUserData);
        // ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ© ŸÅŸä ÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿ•ÿØÿßÿ±ÿ©
        try {
          const log = {
            
            actor: currentUser ? currentUser.username : 'unknown',
            action: editUserName ? 'updateUser' : 'addUser',
            target: key
          };
          window.$db.set(window.$db.ref(`taif/adminactionslog/${Date.now()}_${Math.random().toString(36).slice(2)}`), log);
        } catch (_) {}
        setAdminModalOpen(false);
        setEditUserName(null);
        setAddingUser(false);
        setUserForm({ username:'', password:'', name:'', role:'', perms:{} });
        setAdminErr('');
      });
    } catch (err) {
      console.error(err);
      setAdminErr('‚ö†Ô∏è ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ≠ŸÅÿ∏');
    }
  };

  const handleEditUser = (uname) => {
    const u = usersList[uname];
    if (!u) return;
    // ÿ™ÿ≠ÿØŸäÿØ ÿ•ÿ∞ÿß ŸÖÿß ŸÉÿßŸÜ Ÿäÿ≠ŸÇ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä ÿßŸÑÿ™ÿπÿØŸäŸÑ
    let allowedEdit = false;
    const role = currentUser ? currentUser.role : '';
    if (role === 'emergency') {
      allowedEdit = true;
    } else if (role === 'superadmin') {
      // ÿßŸÑÿ≥Ÿàÿ®ÿ±ÿ£ÿØŸÖŸÜ ŸäŸÖŸÉŸÜŸá ÿ™ÿπÿØŸäŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿ£ŸÇŸÑ ŸÖÿ±ÿ™ÿ®ÿ© (ŸÑŸäÿ≥ ÿ≥Ÿàÿ®ÿ±ÿ£ÿØŸÖŸÜ ŸàŸÑÿß ÿ∑Ÿàÿßÿ±ÿ¶)
      if (u.role !== 'superadmin' && u.role !== 'emergency') allowedEdit = true;
    } else if (role === 'admin') {
      // ÿßŸÑŸÖÿØŸäÿ± ŸäŸÖŸÉŸÜŸá ÿ™ÿπÿØŸäŸÑ ŸÜŸÅÿ≥Ÿá ŸÅŸÇÿ∑ (ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±/ÿßŸÑÿßÿ≥ŸÖ)
      if (uname === currentUser.username) allowedEdit = true;
    }
    if (!allowedEdit) {
      setToast({ text: '‚ö†Ô∏è ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ™ÿπÿØŸäŸÑ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ', type: 'error' });
      return;
    }
    setEditUserName(uname);
    // ÿ™ÿ≠ŸàŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿ•ŸÑŸâ ŸÉÿßÿ¶ŸÜ {perm:true}
    const permsObj = {};
    if (Array.isArray(u.permissions)) {
      u.permissions.forEach((p) => { permsObj[p] = true; });
    } else if (u.permissions && typeof u.permissions === 'object') {
      Object.keys(u.permissions).forEach((p) => { if (u.permissions[p]) permsObj[p] = true; });
    }
    setUserForm({ username: uname, password:'', name: u.name || '', role: u.role || '', perms: permsObj });
    setAdminModalOpen(true);
  };

  const handleDeleteUser = (uname) => {
    // ÿ¨ŸÑÿ® ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÖÿ≥ÿ™ŸáÿØŸÅ ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™
    const targetUser = usersList[uname];
    if (!targetUser) return;
    const myRole = currentUser ? currentUser.role : '';
    const targetRole = targetUser.role || '';
    let allowedDelete = false;
    if (myRole === 'emergency') {
      // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶ ŸäŸÖŸÉŸÜŸá ÿ≠ÿ∞ŸÅ ÿ£Ÿä ŸÖÿ≥ÿ™ÿÆÿØŸÖ
      allowedDelete = true;
    } else if (myRole === 'superadmin') {
      // ÿßŸÑÿ≥Ÿàÿ®ÿ±ÿ£ÿØŸÖŸÜ ŸäŸÖŸÉŸÜŸá ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑÿ£ŸÇŸÑ ŸÖÿ±ÿ™ÿ®ÿ© (ŸÑŸäÿ≥ ÿ≥Ÿàÿ®ÿ±ÿ£ÿØŸÖŸÜ ŸàŸÑÿß ÿ∑Ÿàÿßÿ±ÿ¶)
      if (targetRole !== 'superadmin' && targetRole !== 'emergency') {
        allowedDelete = true;
      }
    } else {
      // ÿßŸÑŸÖÿØŸäÿ± ÿ£Ÿà ÿ£Ÿä ÿØŸàÿ± ÿ¢ÿÆÿ± ŸÑÿß ŸäŸÖŸÉŸÜŸá ÿ≠ÿ∞ŸÅ ÿ£Ÿä ŸÖÿ≥ÿ™ÿÆÿØŸÖ
      allowedDelete = false;
    }
    if (!allowedDelete) {
      setToast({ text: '‚ö†Ô∏è ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ', type: 'error' });
      return;
    }
    if (!window.confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿü')) return;
    try {
      const fb = dbRef.current;
      if (!fb) return;
      window.$db.set(window.$db.ref(`taif/users/${uname}`), null);
      try {
        const log = {
          
          actor: currentUser ? currentUser.username : 'unknown',
          action: 'deleteUser',
          target: uname
        };
        window.$db.set(window.$db.ref(`taif/adminactionslog/${Date.now()}_${Math.random().toString(36).slice(2)}`), log);
      } catch (_) {}
    } catch (err) { console.error(err); }
  };

  // ÿ®ÿØÿ° ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ: ŸÜŸÅÿ™ÿ≠ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ•ÿØÿßÿ±ÿ© ŸàŸÜŸÅÿπŸëŸêŸÑ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©
  const openAddUser = () => {
    setEditUserName(null);
    setAddingUser(true);
    setUserForm({ username:'', password:'', name:'', role:'', perms:{} });
    setAdminModalOpen(true);
  };
  /* ÿ≥ÿßÿπÿ© ÿßŸÑÿπÿ±ÿ∂ */
  const nowStr=useCallback(()=>{
    const d=new Date(),mm=two(d.getMinutes()),hh24=two(d.getHours()),
          h12=(d.getHours()%12)||12,amp=d.getHours()>=12?"PM":"AM";
    const t=dt.is12?`${h12}:${mm} ${amp}`:`${hh24}:${mm}`;
    const dd=`${two(d.getDate())}-${two(d.getMonth()+1)}-${d.getFullYear()}`;
    return {time:(autoTime||!dt.time)?t:dt.time,date:dt.date||dd}
  },[dt,autoTime]);
  const [clock,setClock]=useState(nowStr());
  useEffect(()=>{const id=setInterval(()=>setClock(nowStr()),1000);return()=>clearInterval(id)},[nowStr]);
  /* ÿÆÿ∑ ÿ£ÿ≥ÿßÿ≥ ÿßŸÑÿ™ÿ∫ŸäŸëÿ± ÿßŸÑŸäŸàŸÖŸä */
  const today=()=>{const d=new Date();return `${d.getFullYear()}-${two(d.getMonth()+1)}-${two(d.getDate())}`};
  const [base,setBase] = useState(cachedApp?.base || {});
  const [baseDate,setBaseDate] = useState(cachedApp?.baseDate || "");
    // compare against the latest values without capturing stale state.
  const baseRef = useRef(base);
  useEffect(() => { baseRef.current = base; }, [base]);
    // can compare against the latest value.  Without this ref the closure
    const baseDateRef = useRef(baseDate);
  useEffect(() => { baseDateRef.current = baseDate; }, [baseDate]);
  // Keep a reference to the latest data so that midnight updates use the most recent values.
  const dataRef = useRef(data);
  useEffect(() => { dataRef.current = data; }, [data]);

      const hasRemoteBase = useRef(false);
    useEffect(() => {
    try {
            if (!base || Object.keys(base).length === 0) {
                const b = {};
        const tmpRows = composeRows(data, {});
        tmpRows.forEach(r => { b[r.code] = r.sell; });
        const todayStr = today();
        setBase(b);
        setBaseDate(todayStr);
                saveSnapshot({ base: b, baseDate: todayStr });
                _synced.current.base = true;
      }
    } catch (_err) {
      /* ignore errors */
    }
  }, [data]);
    useEffect(() => {
    let timer;
    const schedule = () => {
      const now = new Date();
      const mid = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 0, 0, 0).getTime();
      const t = Math.max(0, mid - Date.now());
      timer = setTimeout(() => {
                const b = {};
        try {
          const tmpRows = composeRows(dataRef.current, {});
          tmpRows.forEach(r => { b[r.code] = r.sell; });
        } catch (_) {}
        setBase(b);
        const d = today();
        setBaseDate(d);
                saveSnapshot({ base: b, baseDate: d });
        // Mark as synced so the push effect writes to Supabase
        _synced.current.base = true;
        // Schedule the next midnight reset
        schedule();
      }, t);
    };
    schedule();
    return () => clearTimeout(timer);
  }, []);
  /* ÿµŸÅŸàŸÅ ŸÖÿ≠ÿ≥Ÿàÿ®ÿ© */
  const rows = useMemo(() => composeRows(data, base), [data, base]);
  /* ÿµŸÅŸàŸÅ ŸÑŸÑÿπÿ±ÿ∂ ŸÖÿπ ŸÖÿ±ÿßÿπÿßÿ© ÿßŸÑÿ£ŸàŸÜŸÑÿßŸäŸÜ/ÿ£ŸàŸÅŸÑÿßŸäŸÜ */
  const lastGoodRowsRef = useRef([]);
  useEffect(()=>{ if (rows && rows.length) lastGoodRowsRef.current = rows; }, [rows]);
  const rowsDisplay = useMemo(() => {
    return online ? rows : (lastGoodRowsRef.current.length ? lastGoodRowsRef.current : rows);
  }, [rows, online]);
  /* ÿ™ÿ≠ÿ±ŸäŸÉ ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑÿ≥ŸÅŸÑŸä */
  const contRef=useRef(null),itemRef=useRef(null);
  const [ad,setAd]=useState({i:0,snap:true,x:0});
  const timer=useRef(null);
  const clearT=()=>{ if(timer.current){ clearTimeout(timer.current); timer.current=null } };
  const centerShift=()=>{try{const cw=contRef.current?.clientWidth||0,W=(document.body?.clientWidth)||window.innerWidth||0;return Math.max(0,(W-cw)/2)}catch(_){return 0}};
  const measure=w=>{
    const cw=contRef.current?.clientWidth||0,iw=itemRef.current?.clientWidth||0,p=8;
    return !cw||!iw?0: w==='right'?(cw/2+iw/2)+p : w==='left'?-(cw/2+iw/2)-p : 0
  };
  const startAd=useCallback(()=>{
    if(!banner.texts.length)return; clearT();
    setAd(v=>({...v,snap:true,x:measure('right')}));
    requestAnimationFrame(()=>requestAnimationFrame(()=>{
      setAd(v=>({...v,snap:false,x:centerShift()}));
      timer.current=setTimeout(()=>{
        timer.current=setTimeout(()=>{
          setAd(v=>({...v,x:measure('left')}));
          timer.current=setTimeout(()=>{
            setAd(v=>({i:(v.i+1)%banner.texts.length,snap:true,x:centerShift()}));
            startAd();
          },banner.moveDur*1000);
        },banner.stayDur*1000);
      },banner.moveDur*1000);
    }));
  },[banner.texts,banner.moveDur,banner.stayDur]);
  useEffect(()=>{startAd();return()=>clearT()},[startAd]);
  /* ÿ≠ÿßŸÑÿ© ÿßŸÑŸàÿßÿ¨Ÿáÿ© ŸàÿßŸÑŸÖŸàÿØÿßŸÑÿßÿ™ */
  const [menu,setMenu]=useState(false),gearRef=useRef(null);
useEffect(()=>{ 
  if(!menu) return; 
  const onKey=(e)=>{ if(e.key==='Escape') setMenu(false); };
  document.addEventListener('keydown', onKey); 
  return ()=>document.removeEventListener('keydown', onKey);
}, [menu]);
const [modal,setModal]=useState(null),[toast,setToast]=useState(null);
  // ÿ•ÿ∫ŸÑÿßŸÇ ÿ£Ÿä ŸÇŸàÿßÿ¶ŸÖ/ŸÜŸàÿßŸÅÿ∞ ÿπŸÜÿØ ŸÅŸÇÿØÿßŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ
  useEffect(()=>{
    if(!online){
      try{ setMenu(false); }catch(_){}
      try{ setModal(null); }catch(_){}
    }
  }, [online]);
  const [editIdx,setEditIdx]=useState(null);
  /* USD */
  const usd=data.find(d=>d.code==="USD")||{buy:5000,sell:5050};
  const [usdTmp,setUsdTmp]=useState({buy:usd.buy,sell:usd.sell});
const onEditUSD=row=>{ if(!online){ setToast({text:"‚ö†Ô∏è ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ ‚Äî ÿßŸÑÿ™ÿπÿØŸäŸÑ ŸÖÿ™ÿßÿ≠ ŸÅŸÇÿ∑ ÿπŸÜÿØ ÿßŸÑÿßÿ™ÿµÿßŸÑ", type:"error"}); return; } setUsdTmp({buy:row.buy,sell:row.sell}); setModal("usd")};
  /* ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿπÿ±ÿ∂ */
  // Load the display mode (view) from localStorage.  We ignore any value from
  // cachedApp (Supabase snapshot) to keep this preference local to each user.
  let pView;
  try {
    pView = localStorage.getItem(K.VIEW);
  } catch (_) {
    pView = null;
  }
  const [view,setView] = useState(pView || "cards");
  const [vTmp,setVTmp]=useState(view);
  // Persist the selected view to localStorage whenever it changes.
  useEffect(() => {
    try {
      localStorage.setItem(K.VIEW, view);
    } catch (_) {}
  }, [view]);
  /* ÿßŸÑÿ´ŸäŸÖ (ÿßÿÆÿ™Ÿäÿßÿ± ŸÖÿ§ŸÇÿ™) */
  const [tTmp, setTTmp] = useState(theme);
  useEffect(()=>{ if (modal === "themes") setTTmp(theme); }, [modal, theme]);
  /* ÿ™ÿπÿØŸäŸÑ ÿ¨ŸÖÿßÿπŸä */
  const [bulk,setBulk]=useState([]),[q,setQ]=useState("");
  const openBulk=()=>{setBulk(data.map(d=>({...d})));setQ("");setModal("bulk")};
  /* ŸÖÿ≥ŸàÿØÿßÿ™ ŸÖŸàÿØÿßŸÑ ÿßŸÑŸÑŸàÿ∫Ÿà/ÿßŸÑÿπŸÜŸàÿßŸÜ */
  const [logoTmp,setLogoTmp]=useState(logo);
  const [titleTmp,setTitleTmp]=useState(title);
  const [bannerImgTmp,setBannerImgTmp]=useState(bannerImg);
  useEffect(()=>{ if(modal==="logo"){ setLogoTmp(logo); setTitleTmp(title); setBannerImgTmp(bannerImg); } }, [modal, logo, title, bannerImg]);
/* ÿßŸÑŸÑŸàÿ∫Ÿà */
  const onLogo=(file)=>{
    if(!file)return;
    const r=new FileReader();
    r.onload=e=>{const b64=e.target.result;setLogo(b64);setToast({text:"‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÑŸàÿ∫Ÿà", type:"success"})};
    r.readAsDataURL(file);
  };
  const removeLogo=()=>{setLogo("");setToast({text:"‚ùå ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑŸÑŸàÿ∫Ÿà", type:"error"})};
  /* ÿ≤ÿ± ÿßŸÑÿ™ÿ±ÿ≥ (ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿπÿßÿ¶ŸÖÿ©) */
  const toggleMenu=()=>setMenu(m=>!m);
  /* ÿ£ÿµŸÜÿßŸÅ ŸÑŸÑÿ£ŸÑŸàÿßŸÜ ÿ≠ÿ≥ÿ® ÿßŸÑÿ´ŸäŸÖ */
  const headerClass=headCls(theme),banClass=bannerCls(theme);
// ================== Save unified snapshot ==================
const saveSnapshot = (partial={}) => {
  const current = StorageManager.load() || {};
  const snapshot = {
    version: APP_VERSION,
    lastSync: new Date().toISOString(),
    data,
    banner,
    title,
    logo,
    bannerImg,
    datetime: { ...dt, autoTime },
    base,
    baseDate,
    theme,
    view,
    ...current,
    ...partial
  };
  setLastSync(snapshot.lastSync);
  StorageManager.save(snapshot);
  try {
    saveCache(snapshot);
  } catch(_) {}

};
  // Supabase synchronization: data, banner, title, logo, bannerImg, base, datetime
  const dbRef = React.useRef(null);
  const _remote = React.useRef({ data:false, banner:false, theme:false, title:false, logo:false, bannerImg:false, view:false, base:false , datetime:false });
  // Hydration flags:
  // ŸÖÿ±ÿ¨ÿπ ŸÑÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ŸáŸäÿ¶ÿ©
  const syncSetup = React.useRef(()=>{});
  // ÿØÿßŸÑÿ© ŸÑŸÅÿµŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™
  const detachAll = () => {
    try{
      if(!dbRef.current) return;
      const fb = dbRef.current;
      const paths = ['taif/data','taif/banner','taif/title','taif/logo','taif/bannerImg','taif/datetime','taif/base','taif/theme','taif/view'];
      paths.forEach(p => window.$db.off(window.$db.ref(p)));
    }catch(_){}
  };
  // Hydration flags: ŸÑÿß ŸÜŸÉÿ™ÿ® ÿ£Ÿä ÿ•ÿπÿØÿßÿØ ŸÑŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿ™Ÿâ ŸÜÿ≥ÿ™ŸÑŸÖ ÿ£ŸàŸÑ Snapshot
  const _synced = React.useRef({ data:false, banner:false, theme:false, title:false, logo:false, bannerImg:false, view:false, base:false , datetime:false });
  // Subscribe once when Supabase is ready
  React.useEffect(()=>{
    if(!dbRef.current) return;
    if(!_synced.current.datetime) return;
    if(_remote.current.datetime){ _remote.current.datetime=false; return; }
    dbRef.current.set(dbRef.current.ref('taif/datetime'), {
      time: dt.time,
      date: dt.date,
      is12: dt.is12,
      autoTime
    });
  }, [dt, autoTime]);
  React.useEffect(()=>{
    const setup = () => {
      syncSetup.current = setup;
      const fb = window.$db;
      if (!fb) return;
      dbRef.current = fb;
      // data (currencies)
      window.$db.onValue(window.$db.ref('taif/data'), (snap) => {
        _synced.current.data = true;
        const v = snap.val();
        if (v && Array.isArray(v)) {
          _remote.current.data = true;
          setData(v);
          saveSnapshot({ data: v });
          saveJSON(K.DATA, { data: v });
        } else {
          // ÿ•ÿ∞ÿß ÿßŸÑŸÇÿßÿπÿØÿ© ŸÅÿßÿ∂Ÿäÿ© ŸÑÿ£ŸàŸÑ ŸÖÿ±ÿ© ‚Üí ŸÜÿ±ŸÅÿπ DEFAULT_DATA
          window.$db.set(window.$db.ref('taif/data'), DEFAULT_DATA);
          setData(DEFAULT_DATA);
          saveSnapshot({ data: DEFAULT_DATA });
          saveJSON(K.DATA, { data: DEFAULT_DATA });
        }
      });
      // banner
      window.$db.onValue(window.$db.ref('taif/banner'), (snap)=>{
        _synced.current.banner = true;
        const v = snap.val();
        if (v && typeof v === 'object') {
          _remote.current.banner = true;
          setBanner(v);
          setBTmp(v);
          saveSnapshot({ banner: v });
        }
      });
      // theme and view are stored locally only and not synchronized
      // title / logo / bannerImg
      window.$db.onValue(window.$db.ref('taif/title'), (snap)=>{
        _synced.current.title = true;
        const v = snap.val();
        if (typeof v === 'string' && v !== title) {
          _remote.current.title = true;
          setTitle(v);
          saveSnapshot({ title: v });
        }
      });
      window.$db.onValue(window.$db.ref('taif/logo'), (snap)=>{
        _synced.current.logo = true;
        const v = snap.val();
        if (typeof v === 'string' && v !== logo) {
          _remote.current.logo = true;
          setLogo(v);
          saveSnapshot({ logo: v });
        }
      });
      window.$db.onValue(window.$db.ref('taif/bannerImg'), (snap)=>{
        _synced.current.bannerImg = true;
        const v = snap.val();
        if (typeof v === 'string' && v !== bannerImg) {
          _remote.current.bannerImg = true;
          setBannerImg(v);
          saveSnapshot({ bannerImg: v });
        }
      });
      // datetime
      window.$db.onValue(window.$db.ref('taif/datetime'), (snap)=>{
        _synced.current.datetime = true;
        const v = snap.val();
        if (v && typeof v === 'object') {
          _remote.current.datetime = true;
          setDT({time:v.time||"", date:v.date||"", is12:!!v.is12});
          setAuto(!!v.autoTime);
          saveSnapshot({ datetime: {time:v.time||'', date:v.date||'', is12:!!v.is12, autoTime:!!v.autoTime} });
        }
      });
            window.$db.onValue(window.$db.ref('taif/base'), (snap) => {
        _synced.current.base = true;
        const v = snap.val();
        if (!v || !v.date || !v.base) {
          // The remote base does not exist yet.  Initialise it from
          // the local cache or current data.
          let newBase;
          let newDate;
          const localBase = baseRef.current;
          const localDate = baseDateRef.current;
          if (localBase && Object.keys(localBase).length > 0 && localDate) {
            newBase = { ...localBase };
            newDate = localDate;
          } else {
            newBase = {};
            composeRows(dataRef.current || data, {}).forEach(row => {
              newBase[row.code] = row.sell;
            });
            newDate = today();
          }

          // Update the local state and snapshot.
          _remote.current.base = true;
          setBase(newBase);
          setBaseDate(newDate);
          saveSnapshot({ base: newBase, baseDate: newDate });

          try {
            // Write the new base to Supabase and mark as existing.
            hasRemoteBase.current = true;
            _remote.current.base = true;
            window.$db.set(window.$db.ref('taif/base'), { date: newDate, base: newBase });
            // Ensure a daily lock exists for this base date.  This lock indicates
            // that the base for the day has been initialised and should not be
            // reset again.  It is written regardless of the current time.
            window.$db.set(window.$db.ref('locks/base-' + newDate), { at: Date.now() });
          } catch (_) {}
          return;
        }
                const cleaned = {};
        try {
          Object.entries(v.base).forEach(([code, entry]) => {
            if (entry && typeof entry === 'object' && 'sell' in entry) {
              cleaned[code] = toNum(entry.sell);
            } else {
              cleaned[code] = toNum(entry);
            }
          });
        } catch (_) {}
        const remoteDate = v.date;
        const localDate = baseDateRef.current;
                hasRemoteBase.current = true;
                if (!localDate || localDate !== remoteDate) {
          _remote.current.base = true;
          setBase(cleaned);
          setBaseDate(remoteDate);
          saveSnapshot({ base: cleaned, baseDate: remoteDate });
          // Create or update the daily base lock to signal that the base has
          // been processed for this date.
          try {
            window.$db.set(window.$db.ref('locks/base-' + remoteDate), { at: Date.now() });
          } catch (_) {}
          return;
        }
                const currentBase = baseRef.current;
        if (!currentBase || Object.keys(currentBase).length === 0) {
          _remote.current.base = true;
          setBase(cleaned);
          setBaseDate(remoteDate);
          saveSnapshot({ base: cleaned, baseDate: remoteDate });
          try {
            window.$db.set(window.$db.ref('locks/base-' + remoteDate), { at: Date.now() });
          } catch (_) {}
        }
        // Always ensure the lock exists even if the base was not updated above.
        try {
          window.$db.set(window.$db.ref('locks/base-' + remoteDate), { at: Date.now() });
        } catch (_) {}
                return;
      });

        // Note: writing the initial base to Supabase is now performed inside
        // the onValue listener for `taif/base` above.  This prevents multiple
        // writes on every page load by waiting for the remote value to be
        // resolved first before creating a new one if necessary.
    };
    if (window.$db) setup();
    else {
      const onReady = () => { setup(); window.removeEventListener('db-ready', onReady); };
      window.addEventListener('db-ready', onReady);
    }
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);
  // ÿ•ÿπÿßÿØÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿ®ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿπŸÜÿØ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ¥ÿ®ŸÉÿ©
  React.useEffect(()=>{
    if(!window.$db) return;
    if(!online){
      detachAll();
      return;
    }
    // ÿπŸÜÿØ ÿßŸÑÿπŸàÿØÿ© ÿ£ŸàŸÜŸÑÿßŸäŸÜ: ÿ£ÿπÿØ ÿßŸÑÿ™ŸáŸäÿ¶ÿ© ŸàÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™
    try {
      detachAll();
      if (typeof syncSetup.current === 'function') syncSetup.current();
      // ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© ÿ£ŸàŸÅŸÑÿßŸäŸÜ ‚Üí ÿ£ÿ∏Ÿáÿ± ÿßŸÑÿ™Ÿàÿ≥ÿ™
      if (prevOnline.current === false && online === true) {
        setToast({ text: "üîÑ ÿ™ŸÖÿ™ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ‚Äî ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©", type: "info" });
      }
    } catch (_) {}
  }, [online]);
  // Push local changes to Supabase (guard remote->local loops)
  React.useEffect(()=>{
    if(!dbRef.current) return;
    if(!_synced.current.data) return;  // ŸÑÿß ÿ™ŸÉÿ™ÿ® ŸÇÿ®ŸÑ ÿ£ŸàŸÑ Snapshot
    if(_remote.current.data){ _remote.current.data=false; return; }
    dbRef.current.set(dbRef.current.ref('taif/data'), data);
  }, [data]);
  React.useEffect(()=>{
    if(!dbRef.current) return;
    if(!_synced.current.banner) return;  // ŸÑÿß ÿ™ŸÉÿ™ÿ® ŸÇÿ®ŸÑ ÿ£ŸàŸÑ Snapshot
    if(_remote.current.banner){ _remote.current.banner=false; return; }
    dbRef.current.set(dbRef.current.ref('taif/banner'), banner);
  }, [banner]);
  React.useEffect(()=>{
    if(!dbRef.current) return;
    if(!_synced.current.title) return;  // ŸÑÿß ÿ™ŸÉÿ™ÿ® ŸÇÿ®ŸÑ ÿ£ŸàŸÑ Snapshot
    if(_remote.current.title){ _remote.current.title=false; return; }
    dbRef.current.set(dbRef.current.ref('taif/title'), title);
  }, [title]);
  React.useEffect(() => {
    if (!dbRef.current) return;
    // ŸÑÿß ÿ™ŸÉÿ™ÿ® ŸÇÿ®ŸÑ ÿ£ŸàŸÑ Snapshot ŸÑÿ™ÿ¨ŸÜÿ® ÿßŸÑŸÉÿ™ÿßÿ®ÿ© ÿßŸÑŸÖÿ®ŸÉÿ±ÿ© ÿßŸÑÿ™Ÿä ŸÇÿØ ÿ™ÿ≤ŸäŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿπŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
    if (!_synced.current.logo) return;
    if (_remote.current.logo) { _remote.current.logo = false; return; }
    dbRef.current.set(dbRef.current.ref('taif/logo'), logo || '');
  }, [logo]);
  // Do not push theme and view to Supabase.  These settings are kept
  // locally in each user's browser using localStorage rather than being
  // synchronised across all users.
  // Note: theme and view preferences are stored locally via localStorage and are not synced.
  React.useEffect(() => {
    if (!dbRef.current) return;
    // ŸÑÿß ÿ™ŸÉÿ™ÿ® ŸÇÿ®ŸÑ ÿ£ŸàŸÑ Snapshot ŸÑÿ™ÿ¨ŸÜÿ® ÿßŸÑŸÉÿ™ÿßÿ®ÿ© ÿßŸÑŸÖÿ®ŸÉÿ±ÿ© ÿßŸÑÿ™Ÿä ŸÇÿØ ÿ™ÿ≤ŸäŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿπŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
    if (!_synced.current.bannerImg) return;
    if (_remote.current.bannerImg) { _remote.current.bannerImg = false; return; }
    dbRef.current.set(dbRef.current.ref('taif/bannerImg'), bannerImg || '');
  }, [bannerImg]);

    // has synced the initial value from Supabase we monitor changes to
  // base and baseDate.  On any change we write the new value back to the
  // database unless the change came from Supabase itself (guarded by
    // users while still allowing offline support via the in‚Äëmemory cache.
  React.useEffect(() => {
    if (!dbRef.current) return;
    if (!_synced.current.base) return; // don't write before first snapshot
    // If the change originated from Supabase, skip writing and reset the flag
    if (_remote.current.base) { _remote.current.base = false; return; }
            if (hasRemoteBase.current) return;
    try {
      // ÿπŸÜÿØ ÿØŸÅÿπ ÿÆÿ∑ ÿßŸÑÿ£ÿ≥ÿßÿ≥ ÿ•ŸÑŸâ Supabase ŸÖŸÜ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ÿßŸÑŸÖÿ≠ŸÑŸäÿå ÿπŸäŸëŸÜ ÿßŸÑÿπŸÑÿßŸÖÿßÿ™ ŸÑÿπÿØŸÖ ÿ™ŸÉÿ±ÿßÿ± ÿßŸÑŸÉÿ™ÿßÿ®ÿ©
      hasRemoteBase.current = true;
      _remote.current.base = true;
      dbRef.current.set(
        dbRef.current.ref('taif/base'),
        { date: baseDate, base }
      );
    } catch (_) {}
  }, [base, baseDate]);
  /* ================== Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿµŸÅÿ≠ÿ© ================== */

  // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ ŸÅŸÜŸÇŸàŸÖ ÿ®ÿπÿ±ÿ∂ ÿµŸÅÿ≠ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸàŸÜŸàŸÇŸÅ ÿπÿ±ÿ∂ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ£ÿ≥ÿπÿßÿ±.
  if (!currentUser) {
    return (
      <div className="min-h-screen w-full flex items-center justify-center bg-gradient-to-br from-indigo-700 via-purple-600 to-pink-600 p-4">
        <div className="bg-white/90 backdrop-blur-md rounded-xl shadow-xl w-full max-w-sm p-6 sm:p-8">
          <h2 className="text-2xl font-bold mb-4 text-center text-gray-800">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</h2>
          <form onSubmit={handleLogin} className="grid gap-4">
            {/* ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ Supabase ÿ¨ÿßŸáÿ≤ÿ© ŸÜÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÜÿ™ÿ∏ÿßÿ± */}
            {!window.$db && (
              <div className="text-center text-sm text-gray-600">‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</div>
            )}
            <label className="grid gap-1">
              <span className="text-sm text-gray-600">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</span>
              <input className="fld w-full" value={loginUser} onChange={e => setLoginUser(e.target.value.trim())} placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ" />
            </label>
            <label className="grid gap-1">
              <span className="text-sm text-gray-600">ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</span>
              <input type="password" className="fld w-full" value={loginPass} onChange={e => setLoginPass(e.target.value)} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </label>
            {loginErr && <div className="text-red-600 text-sm text-center">{loginErr}</div>}
            <button type="submit" className="w-full h-11 rounded-lg bg-blue-600 hover:bg-blue-700 transition text-white font-semibold">ÿØÿÆŸàŸÑ</button>
          </form>
        </div>
      </div>
    );
  }
  return (
    <div className="w-full px-2 sm:px-0 lg:px-2 xl:px-2 pb-24">
      { !online && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm pointer-events-auto">
          <div className="bg-yellow-200 text-yellow-900 px-6 py-4 rounded-xl shadow-lg text-center font-semibold">
            ‚ö†Ô∏è ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™
            <div className="text-sm font-normal">ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ</div>
          </div>
        </div>
      )}
      {/* ÿ™ÿ≠ÿ∞Ÿäÿ± ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¨ŸàÿßŸÑ ŸÑŸÖ ŸäÿπÿØ ÿØÿßÿ¶ŸÖŸãÿßÿõ ŸäŸèÿ∏Ÿáÿ± ŸÅŸÇÿ∑ ŸÉÿ™Ÿàÿ≥Ÿíÿ™ ÿπÿ®ÿ± setToast */}
      {/* ÿßŸÑŸáŸäÿØÿ± */}
      <header className="mt-1 mb-1">
  <div
    className="hdr grid items-center gap-3 sm:gap-4 h-auto sm:h-40 md:h-44"
  >
    {/* ÿßŸÑÿµŸÜÿØŸàŸÇ ÿßŸÑÿ£Ÿäÿ≥ÿ±: ÿßŸÑŸÑŸàÿ∫Ÿà */}
    <div className="glass rounded-2xl border-2 border-gray-300 h-full w-full overflow-hidden bg-white/60 logo-box">
      {logo ? (
        <img src={logo} alt="ÿßŸÑÿ¥ÿπÿßÿ±" className="w-full h-full object-fill" />
      ) : (
        <span className="flex items-center justify-center h-full text-gray-400 text-sm">
          ÿßŸÑÿ¥ÿπÿßÿ±
        </span>
      )}
    </div>
    {/* ÿßŸÑÿπŸÖŸàÿØ ÿßŸÑÿ£Ÿàÿ≥ÿ∑: ÿßŸÑÿπŸÜŸàÿßŸÜ */}
    <div className="h-full flex items-center justify-center px-3 overflow-hidden title-plain">
      <h1 className="font-black leading-tight text-center whitespace-normal break-words text-[clamp(1.5rem,4vw,2.7rem)]">{title}</h1>
    </div>
    {/* ÿßŸÑÿµŸÜÿØŸàŸÇ ÿßŸÑÿ£ŸäŸÖŸÜ: ÿµŸàÿ±ÿ© ŸÖÿ™ÿ≠ÿ±ŸÉÿ© */}
    <div className="glass rounded-2xl border-2 border-gray-300 h-full w-full overflow-hidden bg-white/60 banner-box">
  {bannerImg ? (
    <img src={bannerImg} alt="ÿßŸÑÿµŸàÿ±ÿ©" className="w-full h-full object-fill" />
  ) : (
    <span className="flex items-center justify-center h-full text-gray-400 text-sm">ÿµŸàÿ±ÿ©</span>
  )}
</div>
  </div>
</header>
            {/* ÿ≤ÿ± ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ + ÿØÿ±ÿ¨ ÿ¨ÿßŸÜÿ®Ÿä ÿ≠ÿØŸäÿ´ */}
      {menu && ReactDOM.createPortal(
        <>
          <div className="drawer-backdrop" onClick={()=>setMenu(false)} />
          <div className={`drawer ${menu?"open":""}`} role="dialog" aria-modal="true" aria-label="ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™" dir="ltr">
            <header>
              <span>ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</span>
              <button className="px-2 py-1 rounded-lg border" onClick={()=>setMenu(false)} aria-label="ÿ•ÿ∫ŸÑÿßŸÇ">‚úñ</button>
            </header>
            <div className="content" dir="ltr">
  {/* ÿπÿ±ÿ∂ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä ŸàÿØŸàÿ±Ÿá ŸÅŸä ÿ£ÿπŸÑŸâ ÿßŸÑÿØÿ±ÿ¨ */}
  {currentUser && (
    <div className="p-2 border-b text-center text-gray-700">
      <div className="font-semibold text-base">{currentUser.username}</div>
      <div className="text-xs text-gray-500">
        {currentUser.role === 'emergency' ? 'ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶' : currentUser.role === 'superadmin' ? 'ÿ≥Ÿàÿ®ÿ±ÿ£ÿØŸÖŸÜ' : currentUser.role === 'admin' ? 'ŸÖÿØŸäÿ±' : currentUser.role || ''}
      </div>
    </div>
  )}
  <div className="grid gap-2">
    {/* ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ */}
    {hasPermission('editUSD') && (
      <button type="button" className="btn-drawer" onClick={() => { setMenu(false); setModal('usd'); }}>üíµ ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿØŸàŸÑÿßÿ±</button>
    )}
    {hasPermission('bulkEdit') && (
      <button type="button" className="btn-drawer" onClick={() => { setMenu(false); openBulk(); }}>üõ†Ô∏è ÿ™ÿπÿØŸäŸÑ ŸÉŸÑ ÿßŸÑÿπŸÖŸÑÿßÿ™</button>
    )}
    {hasPermission('addCurrency') && (
      <button type="button" className="btn-drawer" onClick={() => { setMenu(false); setEditIdx(null); setModal('form'); }}>‚ûï ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÖŸÑÿ©</button>
    )}
    {hasPermission('editCurrency') && (
      <button type="button" className="btn-drawer" onClick={() => { setMenu(false); setModal('pick'); }}>‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ ÿπŸÖŸÑÿ©</button>
    )}
    {hasPermission('deleteCurrency') && (
      <button type="button" className="btn-drawer" onClick={() => { setMenu(false); setModal('pickDelete'); }}>üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿπŸÖŸÑÿ©</button>
    )}
    {hasPermission('editBanner') && (
      <button type="button" className="btn-drawer" onClick={() => { setMenu(false); setBTmp({ ...banner }); setModal('banner'); }}>‚ö° ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™</button>
    )}
    {hasPermission('changeView') && (
      <button type="button" className="btn-drawer" onClick={() => { setMenu(false); setVTmp(view); setModal('view'); }}>üéõÔ∏è ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿπÿ±ÿ∂</button>
    )}
    {hasPermission('changeTheme') && (
      <button type="button" className="btn-drawer" onClick={() => { setMenu(false); setModal('themes'); }}>üé® ÿßŸÑÿ´ŸäŸÖ</button>
    )}
    {hasPermission('editLogo') && (
      <button type="button" className="btn-drawer" onClick={() => { setMenu(false); setModal('logo'); }}>üñºÔ∏è ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÑŸàÿ∫Ÿà/ÿßŸÑÿπŸÜŸàÿßŸÜ</button>
    )}
    {hasPermission('adjustDatetime') && (
      <button type="button" className="btn-drawer" onClick={() => { setMenu(false); setModal('datetime'); }}>üïí ÿ∂ÿ®ÿ∑ ÿßŸÑŸàŸÇÿ™</button>
    )}
    {hasPermission('manageUsers') && (
      <button type="button" className="btn-drawer" onClick={() => {
        setMenu(false);
        // ÿßŸÅÿ™ÿ≠ ŸÑŸàÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÅŸä Ÿàÿ∂ÿπ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
        setEditUserName(null);
        setAddingUser(false);
        setUserForm({ username:'', password:'', name:'', role:'', perms:{} });
        setAdminModalOpen(true);
      }}>üë§ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</button>
    )}
    {hasPermission('viewAdminLogs') && (
      <button type="button" className="btn-drawer" onClick={() => {
        setMenu(false);
        openLogs();
      }}>üìú ÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿ•ÿØÿßÿ±ÿ©</button>
    )}
    {hasPermission('logout') && (
      <button type="button" className="btn-drawer" onClick={() => { setMenu(false); handleLogout(); }}>üö™ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨</button>
    )}
  </div>
</div>
<div className="px-3 py-2 text-xs text-gray-500 text-center border-t">
              ÿßŸÑÿ•ÿµÿØÿßÿ± ÿßŸÑÿ≠ÿßŸÑŸä: {APP_VERSION}
  {lastSync && (
    <div className="mt-1 opacity-70">
      ÿ¢ÿÆÿ± ŸÖÿ≤ÿßŸÖŸÜÿ©: {new Date(lastSync).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})}
    </div>
  )}
</div>
          </div>
        </>,
        document.body
      )}
      {online && !(menu || !!modal) && (
  <div className="fixed left-3 bottom-1 z-[100] translate-y-1">
    <button
      type="button"
      onClick={() => setMenu(m => !m)}
      aria-label="ŸÅÿ™ÿ≠ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™"
      className="text-gray-800 hover:scale-110 transition-transform
                 text-[22px] sm:text-[26px] lg:text-[30px]"
      style={{ background: "transparent", border: "none" }}
    >
      ‚öôÔ∏è
    </button>
  </div>
)}
      {/* ÿµŸÜÿßÿØŸäŸÇ ÿßŸÑÿπÿ±ÿ∂ */}
      <div className={`mt-1 rounded-3xl border-2 border-gray-300 shadow overflow-hidden bg-gradient-to-tr ${banClass}`}>
        {view==="cards" && <div className="cards-view p-2 sm:p-3"><CardsView rows={rowsDisplay} onEditUSD={onEditUSD} canEditUSD={hasPermission('editUSD')}/></div>}
        {view==="board" && <BoardView rows={rowsDisplay} head={headerClass} onEditUSD={onEditUSD} canEditUSD={hasPermission('editUSD')}/>}
      </div>
      {/* ÿ™ÿπÿØŸäŸÑ USD */}
      <Modal open={modal==="usd"} onClose={()=>setModal(null)} title="ÿ™ÿπÿØŸäŸÑ ÿ≥ÿπÿ± ÿßŸÑÿØŸàŸÑÿßÿ±">
        <div className="grid sm:grid-cols-2 gap-3">
          <label className="grid gap-1">
            <span className="text-sm text-gray-600">ÿ¥ÿ±ÿßÿ° (USD)</span>
            <NumIn allowDecimal value={usdTmp.buy} onChange={n=>setUsdTmp(v=>({...v,buy:n}))} className="fld w-full buy-bg"/>
          </label>
          <label className="grid gap-1">
            <span className="text-sm text-gray-600">ŸÖÿ®Ÿäÿπ (USD)</span>
            <NumIn allowDecimal value={usdTmp.sell} onChange={n=>setUsdTmp(v=>({...v,sell:n}))} className="fld w-full sell-bg"/>
          </label>
        </div>
        <div className="btn-row flex justify-end gap-2 pt-2">
          <Btn className="text-white bg-red-600 w-36 h-11" onClick={()=>{setModal(null); setToast({text:"‚ùå ÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ°",type:"error"})}}>ÿ•ŸÑÿ∫ÿßÿ°</Btn>
          <Btn className="text-white bg-green-600 w-36 h-11" onClick={()=>{
            if(!(usdTmp.buy>0&&usdTmp.sell>0)) return setToast({text:"‚ö†Ô∏è ŸÇŸäŸÖ USD Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿ£ŸÉÿ®ÿ± ŸÖŸÜ 0",type:"error"});
            setData(p=>sanitizeData(p.map(rr=>rr.code==="USD"?{...rr,buy:toNum(usdTmp.buy),sell:toNum(usdTmp.sell)}:rr)));setModal(null); setToast({text:"‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿØŸàŸÑÿßÿ±",type:"success"});
          }}>ÿ≠ŸÅÿ∏</Btn>
        </div>
      </Modal>
      {/* ŸÜÿßŸÅÿ∞ÿ© ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿØÿßÿ±ÿ© */}
      <Modal open={logsModalOpen} onClose={() => { setLogsModalOpen(false); }} title="ÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿ•ÿØÿßÿ±ÿ©">
        <div className="grid gap-3">
          <div className="flex justify-end">
            <Btn className="text-white bg-red-600 w-36 h-10" onClick={clearLogs}>üóëÔ∏è ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ¨ŸÑ</Btn>
          </div>
          <div className="max-h-[60vh] overflow-auto text-sm">
            {logsList.length === 0 ? (
              <div className="text-center py-4">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≥ÿ¨ŸÑÿßÿ™</div>
            ) : (
              <div className="space-y-1 max-h-[60vh] overflow-y-auto pr-1">
  {logsList.map((lg, idx) => (
    <div key={idx} className="flex items-start justify-between gap-3 border-b border-gray-600/20 py-1">
      <div className="text-xs opacity-70 whitespace-nowrap">{fmtDT(lg.at)}</div>
      <div className="text-sm flex-1 text-right">
        <span className="mr-1">{ACTION_ICONS[lg.action] || 'üìå'}</span>
        <span>{humanizeLog(lg)} ‚Äî <span className="opacity-70">ÿ®Ÿàÿßÿ≥ÿ∑ÿ© {lg.actor || '‚Äî'}</span></span>
      </div>
    </div>
  ))}
</div>
            )}
          </div>
        </div>
      </Modal>
      {/* ÿ™ÿπÿØŸäŸÑ ÿ¨ŸÖÿßÿπŸä Bulk */}
      <Modal open={modal==="bulk"} onClose={()=>setModal(null)} title="ÿ™ÿπÿØŸäŸÑ ŸÉŸÑ ÿßŸÑÿπŸÖŸÑÿßÿ™">
        <div className="flex flex-wrap items-center gap-2">
          <input className="fld flex-1 min-w-[220px]" placeholder="üîé ÿ®ÿ≠ÿ´ ŸÉŸàÿØ/ÿßÿ≥ŸÖ" value={q} onChange={e=>setQ(e.target.value.trim())}/>
        </div>
        <div className="bulk-grid bulk-head text-xs opacity-70 select-none"><div>ÿßŸÑÿπŸÖŸÑÿ©</div><div>ÿßŸÑÿ∑ÿ±ŸäŸÇÿ©</div><div>ŸÜÿ≥ÿ®ÿ© ÿ¥ÿ±ÿßÿ°</div><div>ŸÜÿ≥ÿ®ÿ© ŸÖÿ®Ÿäÿπ</div><div>ÿ¥ÿ±ÿßÿ°</div><div>ŸÖÿ®Ÿäÿπ</div></div>
        <div className="max-h-[56vh] sm:max-h-[62vh] overflow-auto">
          {(bulk.length?bulk:data)
            .filter(r=>!q||r.code.toLowerCase().includes(q.toLowerCase())||r.name.includes(q))
            .map((r,i)=>{
              const list=bulk.length?bulk:data,usd=list.find(x=>x.code==="USD")||{buy:5000,sell:5050};
              const pv=r.code==="USD"?{buy:r.buy,sell:r.sell}:calcPrice(r,usd);
              const upd=patch=>setBulk(v=>(v.length?v:list).map((x,ii)=>ii===i?{...r,...patch}:x));
              return(
                <div key={r.code} className="bulk-grid bulk-row items-center hover:bg-slate-50">
                  <div className="cell-name name-inline"><span className="truncate">{r.name}</span><span className="code-badge">{r.code}</span></div>
                  <div className="cell-method">
                    <span className="m-label">ÿßŸÑÿ∑ÿ±ŸäŸÇÿ©</span>
                    {r.code==="USD"?<div></div>:<div className="seg">
                      <button className={`mul ${r.method==="multiply"?"on":""}`} onClick={()=>upd({method:"multiply"})}>ÿ∂ÿ±ÿ®</button>
                      <button className={`div ${r.method==="divide"?"on":""}`} onClick={()=>upd({method:"divide"})}>ŸÇÿ≥ŸÖÿ©</button>
                    </div>}
                  </div>
                  <div className="cell-rb"><span className="m-label">ŸÜÿ≥ÿ®ÿ© ÿ¥ÿ±ÿßÿ°</span>{r.code==="USD"?
                    <div></div>
                    :
                    <NumIn
                      allowDecimal
                      className="fld w-full"
                      value={r.ratioBuy}
                      /*
                       * Update the ratio directly from the numeric input.
                       *
                       * When the user clears the field the value `n` will be
                       * null, which leaves `ratioBuy` as null.  This keeps
                       * the input blank instead of forcing a tiny number like
                       * 1e-9 into the text box.  During calculations null
                       * ratios are treated as 1 (see calcPrice) and on
                       * save they are sanitised to be positive numbers.
                       */
                      onChange={n => upd({ ratioBuy: n })}
                    />}
                  </div>
                  <div className="cell-rs"><span className="m-label">ŸÜÿ≥ÿ®ÿ© ŸÖÿ®Ÿäÿπ</span>{r.code==="USD"?
                    <div></div>
                    :
                    <NumIn
                      allowDecimal
                      className="fld w-full"
                      value={r.ratioSell}
                      onChange={n => upd({ ratioSell: n })}
                    />}
                  </div>
                  <div className="cell-buy"><span className="m-label">ÿ¥ÿ±ÿßÿ°</span>{r.code==="USD"?<NumIn allowDecimal className="fld w-full buy-bg" value={r.buy} onChange={n=>upd({buy:toNum(n)})}/>:<div className="fld table-numbers w-full buy-bg select-none">{fmt(pv.buy)}</div>}</div>
                  <div className="cell-sell"><span className="m-label">ŸÖÿ®Ÿäÿπ</span>{r.code==="USD"?<NumIn allowDecimal className="fld w-full sell-bg" value={r.sell} onChange={n=>upd({sell:toNum(n)})}/>:<div className="fld table-numbers w-full sell-bg select-none">{fmt(pv.sell)}</div>}</div>
                </div>
              )})}
        </div>
        <div className="bulk-foot flex justify-end gap-2">
          <Btn className="text-white bg-red-600 w-36 h-11" onClick={()=>{setModal(null); setToast({text:"‚ùå ÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ°",type:"error"})}}>ÿ•ŸÑÿ∫ÿßÿ°</Btn>
          <Btn className="text-white bg-green-600 w-36 h-11" onClick={()=>{
            const src=bulk.length?bulk:data;
            for(const r of src){
              if(r.code==="USD"){ if(!(r.buy>0&&r.sell>0)) return setToast({text:"‚ö†Ô∏è ŸÇŸäŸÖ USD Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿ£ŸÉÿ®ÿ± ŸÖŸÜ 0",type:"error"}) }
              else { if(!(r.ratioBuy>0&&r.ratioSell>0)) return setToast({text:`‚ö†Ô∏è ÿßŸÑŸÜÿ≥ÿ® Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿ£ŸÉÿ®ÿ± ŸÖŸÜ 0 ‚Äî ${r.code}`,type:"error"}) }
            }
            setData(sanitizeData(src)); setModal(null); setToast({text:"‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÉÿßŸÅÿ© ÿßŸÑÿπŸÖŸÑÿßÿ™",type:"success"});
          }}>ÿ≠ŸÅÿ∏ ÿßŸÑŸÉŸÑ</Btn>
        </div>
      </Modal>
      {/* ÿßÿÆÿ™Ÿäÿßÿ± ÿπŸÖŸÑÿ© ŸÑŸÑÿ≠ÿ∞ŸÅ ‚Äî ÿ™ÿµŸÖŸäŸÖ ÿ¨ÿØŸäÿØ */}
      <Modal open={modal==="pickDelete"} onClose={()=>setModal(null)} title="ÿßÿÆÿ™ÿ± ÿßŸÑÿπŸÖŸÑÿ© ŸÑÿ≠ÿ∞ŸÅŸáÿß">
        <MobilePickList
          rows={rows.filter(r=>r.code!=="USD")}
          action="delete"
          onChoose={(r)=>{
            const idx=data.findIndex(x=>x.code===r.code);
            if(idx>-1){ setEditIdx(idx); setModal("confirmDelete"); }
          }}
        />
        <div className="flex justify-end pt-2">
          <Btn className="text-white bg-red-600 w-28 h-11" 
              onClick={()=>{ setModal(null); setToast({text:"‚ùå ÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ°",type:"error"})}}>
            ÿ•ÿ∫ŸÑÿßŸÇ
          </Btn>
        </div>
      </Modal>
      {/* ÿ≠ÿ∞ŸÅ ÿπŸÖŸÑÿ© ‚Äî ÿ™ÿ£ŸÉŸäÿØ */}
      <Modal open={modal==='confirmDelete'} onClose={()=>setModal(null)} title="ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ∞ŸÅ">
        <div className="text-sm sm:text-base">ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ≠ÿ∞ŸÅÿü</div>
        <div className="flex justify-end gap-2 pt-4">
          <Btn className="text-white bg-red-600 w-28 h-11" onClick={()=>{ setModal(null); setToast({text:"‚ùå ÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ°",type:"error"})}}>ÿ•ŸÑÿ∫ÿßÿ°</Btn>
          <Btn className="text-white bg-green-600 w-28 h-11" onClick={()=>{
            if(editIdx != null){ try { var it = (Array.isArray(data) && data[editIdx]) || null; if (it && it.code) { window.Log && window.Log.logEvent && window.Log.logEvent('ÿ≠ÿ∞ŸÅ ÿπŸÖŸÑÿ©', (it.name||it.code) + ' (' + it.code + ')'); } } catch(_) {} 
              setData(prev => prev.filter((_,i)=>i!==editIdx));
            }
            setModal(null);
            setToast({text:"‚úÖ ÿ™ŸÖ ÿßŸÑÿ≠ÿ∞ŸÅ",type:"success"});
          }}>ÿ™ÿ£ŸÉŸäÿØ</Btn>
        </div>
      </Modal>
      {/* ÿßÿÆÿ™Ÿäÿßÿ± ÿπŸÖŸÑÿ© ŸÑŸÑÿ™ÿπÿØŸäŸÑ ‚Äî ÿ™ÿµŸÖŸäŸÖ ÿ¨ÿØŸäÿØ */}
      <Modal open={modal==="pick"} onClose={()=>setModal(null)} title="ÿßÿÆÿ™ÿ± ÿßŸÑÿπŸÖŸÑÿ© ŸÑÿ™ÿπÿØŸäŸÑŸáÿß">
        <MobilePickList
          rows={rowsDisplay}
          action="edit"
          onChoose={(r)=>{
            const idx=data.findIndex(x=>x.code===r.code);
            if(idx>-1){ setEditIdx(idx); setModal("form"); }
          }}
        />
        <div className="flex justify-end pt-2">
          <Btn className="text-white bg-slate-600 w-28 h-11" 
              onClick={()=>{ setModal(null); setToast({text:"‚ùå ÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ°",type:"error"})}}>
            ÿ•ÿ∫ŸÑÿßŸÇ
          </Btn>
        </div>
      </Modal>
      {/* ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ (Banner) */}
      <Modal open={modal==="banner"} onClose={()=>setModal(null)} title="ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ•ÿπŸÑÿßŸÜŸä ÿßŸÑÿ≥ŸÅŸÑŸä">
        <div className="grid gap-3">
          {(bTmp.texts||[]).length>0 ? (
            bTmp.texts.map((txt,i)=>(
              <div key={i} className="flex gap-2 items-center">
                <input className="fld flex-1" value={txt}
                  onChange={e=>{
                    const newTexts=[...bTmp.texts]; newTexts[i]=e.target.value;
                    setBTmp(v=>({...v,texts:newTexts}));
                  }}
                  placeholder={`ÿ•ÿπŸÑÿßŸÜ ${i+1}`}
                />
                <button type="button" className="px-3 py-2 bg-red-600 text-white rounded-lg"
                  onClick={()=>{ const newTexts=bTmp.texts.filter((_,idx)=>idx!==i); setBTmp(v=>({...v,texts:newTexts})) }}>
                  ‚ùå
                </button>
              </div>
            ))
          ) : (
            <div className="text-sm text-gray-500">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿ≠ÿßŸÑŸäÿßŸã.</div>
          )}
          <button type="button" className="px-3 py-2 bg-blue-600 text-white rounded-lg w-fit"
            onClick={()=>{ const newTexts=[...(bTmp.texts||[]), ""]; setBTmp(v=>({...v,texts:newTexts})) }}>
            ‚ûï ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿπŸÑÿßŸÜ
          </button>
        </div>
        <div className="grid sm:grid-cols-3 gap-3 mt-4">
          <label className="grid gap-1">
            <span className="text-sm text-gray-600">ŸÑŸàŸÜ ÿßŸÑŸÜÿµ</span>
            <input type="color" className="fld h-11 p-1" value={bTmp.color} onChange={e=>setBTmp(v=>({...v,color:e.target.value}))}/>
          </label>
          <label className="grid gap-1">
            <span className="text-sm text-gray-600">ŸÖÿØÿ© ÿßŸÑÿ≠ÿ±ŸÉÿ© (ÿ´)</span>
            <NumIn allowDecimal className="fld" value={bTmp.moveDur} onChange={n=>setBTmp(v=>({...v,moveDur:clamp(n,.3,20)}))}/>
          </label>
          <label className="grid gap-1">
            <span className="text-sm text-gray-600">ŸÖÿØÿ© ÿßŸÑÿ™ŸàŸÇŸÅ (ÿ´)</span>
            <NumIn allowDecimal className="fld" value={bTmp.stayDur} onChange={n=>setBTmp(v=>({...v,stayDur:clamp(n,.3,60)}))}/>
          </label>
        </div>
        <div className="btn-row flex justify-end gap-2 pt-2">
          <Btn className="text-white bg-red-600 w-32 h-11" onClick={()=>{setModal(null); setToast({text:"‚ùå ÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ°",type:"error"})}}>ÿ•ŸÑÿ∫ÿßÿ°</Btn>
          <Btn className="text-white bg-green-600 w-32 h-11" onClick={()=>{
            const safeTexts=(bTmp.texts&&Array.isArray(bTmp.texts)&&bTmp.texts.length>0)
              ? bTmp.texts.filter(t=>(t||"").trim()!=="")
              : ["üì¢ ÿ£ŸáŸÑÿßŸã ÿ®ŸÉŸÖ"];
            setBanner({...bTmp,texts:safeTexts.map(t=>String(t).slice(0,140))});
            setModal(null);
            setToast({text:"‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™",type:"success"});
          }}>ÿ≠ŸÅÿ∏</Btn>
        </div>
      </Modal>
      {/* ŸÖŸàÿØÿßŸÑ ÿßŸÑŸàŸÇÿ™ */}
      <DatetimeModal
        open={modal==="datetime"}
        onClose={()=>setModal(null)}
        dt={dt}
        autoTime={autoTime}
        setDT={setDT}
        setAuto={setAuto}
        setToast={setToast}
      />
      {/* ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿπÿ±ÿ∂ */}
      <Modal open={modal==="view"} onClose={()=>setModal(null)} title="ÿ∑ÿ±ŸäŸÇÿ© ÿπÿ±ÿ∂ ÿßŸÑÿ£ÿ≥ÿπÿßÿ±">
        <div className="grid themes-grid grid-cols-2 sm:grid-cols-2 gap-2 sm:gap-3">
          <button type="button" className={`view-card ${vTmp==='cards'?'sel':''}`} onClick={()=>setVTmp('cards')}>
            <div className="font-bold mb-1">ÿ®ÿ∑ÿßŸÇÿßÿ™</div>
            <div className="text-sm text-gray-600">ÿ¥ÿ®ŸÉÿ© ŸÖÿ±ŸÜÿ© Ÿàÿ≥ÿ±Ÿäÿπÿ© ÿßŸÑŸÇÿ±ÿßÿ°ÿ©.</div>
          </button>
          <button type="button" className={`view-card ${vTmp==='board'?'sel':''}`} onClick={()=>setVTmp('board')}>
            <div className="font-bold mb-1">ŸÑŸàÿ≠ÿ© ŸÉÿ®Ÿäÿ±ÿ©</div>
            <div className="text-sm text-gray-600">ŸÖŸÜÿßÿ≥ÿ®ÿ© ŸÑŸÑÿ¥ÿßÿ¥ÿßÿ™ ÿßŸÑŸÉÿ®Ÿäÿ±ÿ©.</div>
          </button>
        </div>
        <div className="btn-row flex justify-end gap-2 pt-2">
          <Btn className="text-white bg-red-600 w-32 h-11" onClick={()=>{setModal(null); setToast({text:"‚ùå ÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ°",type:"error"})}}>ÿ•ŸÑÿ∫ÿßÿ°</Btn>
          <Btn className="text-white bg-green-600 w-32 h-11" onClick={()=>{ setView(vTmp); setModal(null); setToast({text:"‚úÖ ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿπÿ±ÿ∂",type:"success"})}}>ÿ≠ŸÅÿ∏</Btn>
        </div>
      </Modal>
      {/* ŸÖŸàÿØÿßŸÑ ÿßŸÑÿ´ŸäŸÖ */}
      <Modal open={modal==="themes"} onClose={()=>setModal(null)} title="ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ´ŸäŸÖ">
        <div className="grid themes-grid grid-cols-2 sm:grid-cols-2 gap-2 sm:gap-3">
          {THEMES.map(t=>(
            <button
              type="button"
              key={t.id}
              onClick={()=>setTTmp(t.cls)}
              className={`view-card ${tTmp===t.cls?'sel':''}`}
            >
              <div className={`h-16 rounded-xl mb-2 bg-gradient-to-tr ${t.cls.replace('bg-gradient-to-tr ','').replace('text-gray-900','').replace('text-gray-100','')}`}/>
              <div className="font-bold">{t.name}</div>
              <div className="text-xs text-gray-600 ltr:tracking-wider">{t.id}</div>
            </button>
          ))}
        </div>
        <div className="flex justify-end gap-2 pt-4">
          <Btn className="text-white bg-red-600 w-28 h-11" onClick={()=>{setModal(null); setToast({text:"‚ùå ÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ°",type:"error"})}}>ÿ•ŸÑÿ∫ÿßÿ°</Btn>
          <Btn className="text-white bg-slate-700 w-28 h-11" onClick={()=>{ setTheme(""); setModal(null); setToast({text:"‚ÑπÔ∏è ÿ™ŸÖ ÿßŸÑÿ±ÿ¨Ÿàÿπ ÿ•ŸÑŸâ ÿßŸÑÿ´ŸäŸÖ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä",type:"info"}); }}>ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä</Btn>
          <Btn className="text-white bg-green-600 w-28 h-11" onClick={()=>{
            setTheme(tTmp);
            setModal(null);
            setToast({text:"‚úÖ ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ´ŸäŸÖ",type:"success"});
          }}>ÿ≠ŸÅÿ∏</Btn>
        </div>
      </Modal>
      {/* ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÑŸàÿ∫Ÿà + ÿßŸÑÿπŸÜŸàÿßŸÜ + ÿµŸàÿ±ÿ© Ÿàÿ≥ÿ∑ ÿßŸÑŸáŸäÿØÿ± */}
      {/* ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÑŸàÿ∫Ÿà + ÿßŸÑÿπŸÜŸàÿßŸÜ + ÿµŸàÿ±ÿ© Ÿàÿ≥ÿ∑ ÿßŸÑŸáŸäÿØÿ± */}
      <Modal open={modal==="logo"} onClose={()=>setModal(null)} title="ÿ™ÿ∫ŸäŸäÿ± ŸÑŸàÿ∫Ÿà ÿßŸÑÿ¥ÿ±ŸÉÿ© / ÿßŸÑÿπŸÜŸàÿßŸÜ">
        <div className="grid gap-3 logo-modal">
          {/* ÿßŸÑŸÇÿ≥ŸÖ 1: ÿßŸÑŸÑŸàÿ∫Ÿà */}
          <div className="section">
            <div className="section-title">ÿßŸÑŸÑŸàÿ∫Ÿà</div>
            <div className="row">
              <div className="preview">
{logoTmp ? <img src={logoTmp} alt="ÿßŸÑÿ¥ÿπÿßÿ±" className="object-contain w-full h-full"/> : <span className="text-gray-400 text-xs">ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ¥ÿπÿßÿ±</span>}
              </div>
              <div className="grid gap-2">
                <div className="hint">ŸäŸèÿ≥ÿ™ÿ≠ÿ≥ŸÜ ÿ£ÿ®ÿπÿßÿØ ÿπÿ±Ÿäÿ∂ÿ© ŸÖÿ´ŸÑ 1000√ó400. ÿ≥Ÿäÿ™ŸÖ ÿ™ŸÖÿØŸäÿØ ÿßŸÑÿµŸàÿ±ÿ© ŸÑŸÖŸÑÿ° ÿßŸÑÿµŸÜÿØŸàŸÇ.</div>
                <input type="file" accept="image/png,image/jpeg,image/webp" className="fld w-full" onChange={e=>{ const f=e.target.files && e.target.files[0]; if(!f) return; if(!validateImage(f, setToast)) return; const r=new FileReader(); r.onload=ev=>setLogoTmp(ev.target.result); r.readAsDataURL(f); }}/>
                <div className="actions">
                  {logoTmp && <Btn className="text-white bg-red-600" onClick={()=>setLogoTmp("")}>ŸÖÿ≥ÿ≠ ÿßŸÑŸÑŸàÿ∫Ÿà</Btn>}
                </div>
              </div>
            </div>
          </div>
          {/* ÿßŸÑŸÇÿ≥ŸÖ 2: ÿßŸÑÿπŸÜŸàÿßŸÜ */}
          <div className="section">
            <div className="section-title">ÿßŸÑÿπŸÜŸàÿßŸÜ</div>
            <div className="grid gap-2">
              <input className="fld w-full" value={titleTmp} onChange={e=>setTitleTmp(e.target.value)} placeholder="ÿ£ÿØÿÆŸÑ ÿπŸÜŸàÿßŸÜ ÿßŸÑÿµŸÅÿ≠ÿ©"/>
              <div className="hint">ŸäÿØÿπŸÖ ÿßŸÑÿπŸÜÿßŸàŸäŸÜ ÿßŸÑÿ∑ŸàŸäŸÑÿ©</div>
            </div>
          </div>
          {/* ÿßŸÑŸÇÿ≥ŸÖ 3: ÿµŸàÿ±ÿ© Ÿàÿ≥ÿ∑ ÿßŸÑŸáŸäÿØÿ± (ŸäŸÖŸäŸÜ) */}
          <div className="section">
            <div className="section-title">ÿµŸàÿ±ÿ© (Ÿäÿ≥ÿßÿ± ÿßŸÑÿπŸÜŸàÿßŸÜ)</div>
            <div className="row">
              <div className="preview">
{bannerImgTmp ? <img src={bannerImgTmp} alt="ÿßŸÑÿµŸàÿ±ÿ©" className="object-contain w-full h-full"/> : <span className="text-gray-400 text-xs">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸàÿ±ÿ©</span>}
              </div>
              <div className="grid gap-2">
                <div className="hint">ŸäŸèÿ≥ÿ™ÿ≠ÿ≥ŸÜ ÿ£ÿ®ÿπÿßÿØ ÿπÿ±Ÿäÿ∂ÿ© ŸÖÿ´ŸÑ 1000√ó400. ÿ≥Ÿäÿ™ŸÖ ÿ™ŸÖÿØŸäÿØ ÿßŸÑÿµŸàÿ±ÿ© ŸÑŸÖŸÑÿ° ÿßŸÑÿµŸÜÿØŸàŸÇ.</div>
                <input type="file" accept="image/png,image/jpeg,image/webp" className="fld w-full" onChange={e=>{ const f=e.target.files && e.target.files[0]; if(!f) return; if(!validateImage(f, setToast)) return; const r=new FileReader(); r.onload=ev=>setBannerImgTmp(ev.target.result); r.readAsDataURL(f); }}/>
                <div className="actions">
                  {bannerImgTmp && <Btn className="text-white bg-red-600" onClick={()=>setBannerImgTmp("")}>ŸÖÿ≥ÿ≠ ÿßŸÑÿµŸàÿ±ÿ©</Btn>}
                </div>
              </div>
            </div>
          </div>
          {/* ÿ£ÿ≤ÿ±ÿßÿ± */}
          <div className="sticky-actions flex justify-end gap-2 pt-2">
            <Btn className="text-white bg-red-600 w-32 h-11" onClick={()=>{ setModal(null); setToast({text:"‚ùå ÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ°",type:"error"}); }}>ÿ•ŸÑÿ∫ÿßÿ°</Btn>
            <Btn className="text-white bg-green-600 w-32 h-11" onClick={()=>{
              const safeTitle=titleTmp || "ŸÑŸàÿ≠ÿ© ÿ£ÿ≥ÿπÿßÿ± ÿµÿ±ŸÅ ÿßŸÑÿπŸÖŸÑÿßÿ™";
              setTitle(safeTitle); 
              setLogo(logoTmp);
              if(logoTmp){  } else {  }
              setBannerImg(bannerImgTmp);
              if(bannerImgTmp){  } else {  }
              setModal(null);
              setToast({text:"‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™",type:"success"});
            }}>ÿ≠ŸÅÿ∏</Btn>
          </div>
        </div>
      </Modal>
      {/* ÿ•ÿ∂ÿßŸÅÿ©/ÿ™ÿπÿØŸäŸÑ ÿπŸÖŸÑÿ© */}
      <Modal open={modal==="form"} onClose={()=>setModal(null)} title={editIdx!=null?"ÿ™ÿπÿØŸäŸÑ ÿπŸÖŸÑÿ©":"ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÖŸÑÿ©"}>
        <FormCurrency
          data={data}
          editIdx={editIdx}
          onCancel={()=>setModal(null)}
          onSaved={(list)=>{ setData(list); setModal(null); }}
          setToast={setToast}
        />
      </Modal>
      {/* ŸÖŸàÿØÿßŸÑ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÑŸÖ ŸäÿπÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖŸãÿßÿõ ÿßŸÑŸàÿßÿ¨Ÿáÿ© ÿßŸÑŸÉÿßŸÖŸÑÿ© ŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ™ÿπÿ±ÿ∂ ŸÅŸä ÿßŸÑÿ®ÿØÿßŸäÿ© */}
      {/* ŸÑŸàÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ */}
      <Modal open={adminModalOpen} onClose={() => {
        setAdminModalOpen(false);
        setEditUserName(null);
        setAddingUser(false);
        setUserForm({ username:'', password:'', name:'', role:'', perms:{} });
        setAdminErr('');
      }} title={editUserName ? 'ÿ™ÿπÿØŸäŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ' : addingUser ? 'ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ' : 'ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ'}>
        {(addingUser || editUserName != null) ? (
          <div className="grid gap-3">
            {/* ÿπŸÜÿØ ÿ™ÿπÿØŸäŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸàÿ¨ŸàÿØ ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿ∫ŸäŸäÿ± ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ */}
            {editUserName == null && (
              <label className="grid gap-1">
                <span className="text-sm text-gray-600">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</span>
                <input className="fld w-full" value={userForm.username} onChange={e => setUserForm(v => ({ ...v, username: e.target.value.trim() }))} placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ" />
              </label>
            )}
            {/* ÿ≠ŸÇŸÑ ÿßÿ≥ŸÖ ÿßŸÑÿ¥ÿÆÿµ Ÿäÿ∏Ÿáÿ± ÿØÿßÿ¶ŸÖŸãÿß */}
            <label className="grid gap-1">
              <span className="text-sm text-gray-600">ÿßÿ≥ŸÖ ÿßŸÑÿ¥ÿÆÿµ</span>
              <input className="fld w-full" value={userForm.name || ''} onChange={e => setUserForm(v => ({ ...v, name: e.target.value }))} placeholder="ÿßÿ≥ŸÖ ÿßŸÑÿ¥ÿÆÿµ" />
            </label>
            <label className="grid gap-1">
              <span className="text-sm text-gray-600">ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± {editUserName ? '(ÿßÿ™ÿ±ŸÉŸáÿß ŸÅÿßÿ±ÿ∫ÿ© ŸÑÿπÿØŸÖ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±)' : ''}</span>
              <input type="password" className="fld w-full" value={userForm.password} onChange={e => setUserForm(v => ({ ...v, password: e.target.value }))} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </label>
            {/* ÿ≠ŸÇŸÑ ÿßŸÑÿØŸàÿ±: Ÿäÿ∏Ÿáÿ± ŸÅŸÇÿ∑ ŸÑŸÑÿ≥Ÿàÿ®ÿ±ÿ£ÿØŸÖŸÜ ÿ£Ÿà ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶. Ÿäÿ™Ÿäÿ≠ ÿßÿÆÿ™Ÿäÿßÿ± ÿ±ÿ™ÿ®ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ. */}
            {currentUser && (currentUser.role === 'superadmin' || currentUser.role === 'emergency') && (
              <label className="grid gap-1">
                <span className="text-sm text-gray-600">ÿßŸÑÿØŸàÿ±</span>
                <select
                  className="fld w-full"
                  value={userForm.role || ''}
                  onChange={e => {
                    const val = e.target.value;
                    setUserForm(v => ({ ...v, role: val }));
                  }}
                  // ŸÑÿß ŸäŸÖŸÉŸÜ ŸÑŸÑŸÖÿØŸäÿ± ÿ™ÿπÿØŸäŸÑ ÿØŸàÿ±Ÿá ÿπŸÜÿØ ÿ™ÿπÿØŸäŸÑ ŸÜŸÅÿ≥Ÿá
                  disabled={editUserName && currentUser && currentUser.role === 'admin' && editUserName === currentUser.username}
                >
                  <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿØŸàÿ±</option>
                  <option value="admin">ŸÖÿØŸäÿ±</option>
                  {/* ÿßŸÑÿ≥Ÿàÿ®ÿ±ÿ£ÿØŸÖŸÜ Ÿäÿ≥ÿ™ÿ∑Ÿäÿπ ÿ™ÿπŸäŸäŸÜ ÿ≥Ÿàÿ®ÿ±ÿ£ÿØŸÖŸÜ */}
                  {currentUser.role === 'superadmin' && (
                    <option value="superadmin">ÿ≥Ÿàÿ®ÿ±ÿ£ÿØŸÖŸÜ</option>
                  )}
                  {/* ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶ Ÿäÿ≥ÿ™ÿ∑Ÿäÿπ ÿ™ÿπŸäŸäŸÜ ÿ≥Ÿàÿ®ÿ±ÿ£ÿØŸÖŸÜ ÿ£Ÿà ÿ∑Ÿàÿßÿ±ÿ¶ */}
                  {currentUser.role === 'emergency' && (
                    <>
                      <option value="superadmin">ÿ≥Ÿàÿ®ÿ±ÿ£ÿØŸÖŸÜ</option>
                      <option value="emergency">ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶</option>
                    </>
                  )}
                </select>
              </label>
            )}
            {/* ŸÖÿ¨ŸÖŸàÿπÿ© ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™: Ÿäÿ∏Ÿáÿ± ŸÑŸÉŸÑ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÖÿ±ÿ®ÿπ ÿßÿÆÿ™Ÿäÿßÿ± ŸäŸÖŸÉŸÜ ÿ™ÿ≠ÿØŸäÿØŸá ÿ£Ÿà ÿ•ŸÑÿ∫ÿßÿ°Ÿá */}
            <div className="grid gap-1">
              <span className="text-sm text-gray-600">ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™</span>
              <div className="grid gap-1">
                {PERMISSIONS.map((perm) => (
                  <label key={perm.key} className="inline-flex items-center gap-2">
                    <input
                      type="checkbox"
                      checked={!!userForm.perms[perm.key]}
                      disabled={editUserName && currentUser && currentUser.role === 'admin' && editUserName === currentUser.username}
                      onChange={e => {
                        const checked = e.target.checked;
                        setUserForm(v => ({ ...v, perms: { ...v.perms, [perm.key]: checked } }));
                      }}
                    />
                    <span>{perm.label}</span>
                  </label>
                ))}
              </div>
            </div>
            {adminErr && <div className="text-red-600 text-sm">{adminErr}</div>}
            <div className="flex justify-end gap-2 pt-2">
              <Btn className="text-white bg-red-600 w-28 h-10" onClick={() => {
                setAdminModalOpen(false);
                setEditUserName(null);
                setAddingUser(false);
                setUserForm({ username:'', password:'', name:'', role:'', perms:{} });
                setAdminErr('');
              }}>ÿ•ŸÑÿ∫ÿßÿ°</Btn>
              <Btn className="text-white bg-green-600 w-28 h-10" onClick={handleSaveUser}>ÿ≠ŸÅÿ∏</Btn>
            </div>
          </div>
        ) : (
          <div className="grid gap-3">
            <div className="flex justify-between">
              {/* ÿ≤ÿ± ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿØÿßÿ±ÿ©: Ÿäÿπÿ±ÿ∂ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± */}
              <Btn className="text-white bg-gray-600 w-36 h-10" onClick={openLogs}>üìú ÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿ•ÿØÿßÿ±ÿ©</Btn>
              { (currentUser && (currentUser.role === 'superadmin' || currentUser.role === 'emergency')) && (
                <Btn className="text-white bg-blue-600 w-36 h-10" onClick={openAddUser}>‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ</Btn>
              ) }
            </div>
            <div className="max-h-[60vh] overflow-auto">
              {Object.entries(usersList || {})
                // ÿ•ÿÆŸÅÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶ ÿπŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿπÿØÿß ÿµÿßÿ≠ÿ® ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶
                .filter(([un, us]) => {
                  if (!us) return false;
                  if (us.role === 'emergency' && (!currentUser || currentUser.role !== 'emergency')) return false;
                  return true;
                })
                .map(([uname, u]) => {
                  // ÿ™ÿ≠ÿØŸäÿØ ÿ•ŸÖŸÉÿßŸÜŸäÿ© ÿßŸÑÿ™ÿπÿØŸäŸÑ ŸàÿßŸÑÿ≠ÿ∞ŸÅ ŸÑŸÉŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ±ÿ™ÿ®ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä
                  let canEdit = false;
                  let canDelete = false;
                  const myRole = currentUser ? currentUser.role : '';
                  const targetRole = u.role || '';
                  if (myRole === 'emergency') {
                    canEdit = true;
                    canDelete = true;
                  } else if (myRole === 'superadmin') {
                    if (targetRole !== 'superadmin' && targetRole !== 'emergency') {
                      canEdit = true;
                      canDelete = true;
                    }
                  } else if (myRole === 'admin') {
                    if (uname === (currentUser ? currentUser.username : '')) {
                      // ÿßŸÑŸÖÿØŸäÿ± ŸäŸÖŸÉŸÜŸá ÿ™ÿπÿØŸäŸÑ ŸÜŸÅÿ≥Ÿá (ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±/ÿßŸÑÿßÿ≥ŸÖ)
                      canEdit = true;
                    }
                  }
                  return (
                    <div key={uname} className="flex items-center justify-between border-b py-2">
                        <div className="flex flex-col">
                          <span className="font-bold">{uname}</span>
                          {u.name && <span className="text-sm text-gray-700">{u.name}</span>}
                          <span className="text-xs text-gray-600">
                            ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™: {(Array.isArray(u?.permissions) ? u.permissions.map((permKey) => permLabelMap[permKey] || permKey) : []).join(', ')}
                          </span>
                        </div>
                        <div className="flex gap-2">
                          {canEdit && (
                            <Btn className="text-white bg-blue-500 w-20 h-8 text-xs" onClick={() => handleEditUser(uname)}>ÿ™ÿπÿØŸäŸÑ</Btn>
                          )}
                          {canDelete && (
                            <Btn className="text-white bg-red-600 w-20 h-8 text-xs" onClick={() => handleDeleteUser(uname)}>ÿ≠ÿ∞ŸÅ</Btn>
                          )}
                        </div>
                    </div>
                  );
                })}
            </div>
          </div>
        )}
      </Modal>
{/* Toast + ÿßŸÑÿ≥ÿßÿπÿ© + ÿßŸÑÿ®ÿßŸÜÿ± ÿßŸÑÿ≥ŸÅŸÑŸä */}
      <Toast toast={toast} onClose={() => setToast(null)} />
      <div className="fixed left-0 right-0 bottom-0 z-[60] bottom-fixed" dir="ltr">
        <div className="grid w-full h-10 sm:h-12 footer-grid grid-cols-[1fr_minmax(200px,22%)]">
          <div ref={contRef} className={`ad-wrap bg-gradient-to-r ${banClass}`} dir="rtl">
            <div ref={itemRef} className={`ad-item ${ad.snap?'no-trans':''}`}
              style={{'--ad-move':`${banner.moveDur}s`,color:banner.color,transform:`translate(calc(-50% + ${ad.x}px), -50%)`}}>
              <span className="px-4 sm:px-6">{banner.texts[ad.i]||""}</span>
            </div>
          </div>
          <div className={`border-l border-slate-200 flex items-center justify-center gap-3 px-2 sm:px-4 bg-gradient-to-r ${banClass}`}>
            <div className={`w-3 h-3 sm:w-4 sm:h-4 rounded-full shadow ${online ? "bg-green-500" : "bg-red-500"}`} title={online ? "ŸÖÿ™ÿµŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™" : "ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ"}></div>
            <div className="flex flex-col items-center sm:flex-row sm:items- sm:gap-2 text-slate-900 whitespace-nowrap" dir="ltr">
              <span className="table-numbers text-base sm:text-xl md:text-2xl font-black">{clock.time}</span>
              <span className="hidden sm:inline opacity-50 select-none">|</span>
              <span className="table-numbers text-xs sm:text-base md:text-lg">{clock.date}</span>
              
            </div>
          </div>
        </div>
      </div>
    </div>
  );
} // ŸÜŸáÿßŸäÿ© App
/* ================== ŸÜŸÖŸàÿ∞ÿ¨ ÿ•ÿ∂ÿßŸÅÿ©/ÿ™ÿπÿØŸäŸÑ ÿπŸÖŸÑÿ© ================== */
const FormCurrency=({data,editIdx,onCancel,onSaved,setToast})=>{
  const init=editIdx!=null
    ? data[editIdx]
    : {flag:"",icon:"",code:"",name:"",ratioBuy:1,ratioSell:1,method:"multiply"};
  if (init && init.code === "USD") { setToast?.({text:"‚ö†Ô∏è ÿ™ÿπÿØŸäŸÑ USD Ÿäÿ™ŸÖ ŸÖŸÜ ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿØŸàŸÑÿßÿ± ŸÅŸÇÿ∑", type:"error"}); onCancel?.(); return null; }
  const [f,setF]=useState({...init});
  return <div className="form-currency">
    <div className="grid sm:grid-cols-2 gap-3">
      <label className="grid gap-1">
        <span className="text-sm text-gray-600">ÿßŸÑÿ±ŸÖÿ≤ (ŸÉŸàÿØ)</span>
        <input lang="en" className="fld table-numbers"
          value={f.code||""}
          onChange={e=>setF(v=>({...v,code:e.target.value.toUpperCase()}))}
          placeholder="USD / EUR / SAR ..." />
      </label>
      <label className="grid gap-1">
        <span className="text-sm text-gray-600">ÿßŸÑÿßÿ≥ŸÖ</span>
        <input className="fld"
          value={f.name||""}
          onChange={e=>setF(v=>({...v,name:e.target.value}))}
          placeholder="ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸÑÿ©" />
      </label>
      <label className="grid gap-1">
        <span className="text-sm text-gray-600">ÿπŸÑŸÖ (Emoji)</span>
        <input className="fld"
          value={f.flag||""}
          onChange={e=>setF(v=>({...v,flag:e.target.value}))}
          placeholder="üá∫üá∏ ŸÖÿ´ŸÑÿß" />
      </label>
      <label className="grid gap-1">
        <span className="text-sm text-gray-600">ÿ£ŸäŸÇŸàŸÜÿ© ŸÇÿµŸäÿ±ÿ©</span>
        <input lang="en" className="fld table-numbers"
          value={f.icon||""}
          onChange={e=>setF(v=>({...v,icon:e.target.value}))}
          placeholder="USD, EUR..." />
      </label>
      <label className="grid gap-1">
        <span className="text-sm text-gray-600">ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ¥ÿ±ÿßÿ°</span>
        <NumIn allowDecimal value={f.ratioBuy??1}
          onChange={n=>setF(v=>({...v,ratioBuy:n}))}
          className="fld" />
      </label>
      <label className="grid gap-1">
        <span className="text-sm text-gray-600">ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÖÿ®Ÿäÿπ</span>
        <NumIn allowDecimal value={f.ratioSell??1}
          onChange={n=>setF(v=>({...v,ratioSell:n}))}
          className="fld" />
      </label>
      <label className="grid gap-1">
        <span className="text-sm text-gray-600">ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®</span>
        <select className="fld"
          value={f.method||"multiply"}
          onChange={e=>setF(v=>({...v,method:e.target.value}))}>
          <option value="multiply">ÿ∂ÿ±ÿ®</option>
          <option value="divide">ŸÇÿ≥ŸÖÿ©</option>
        </select>
      </label>
    </div>
    <div className="btn-row flex justify-end gap-2 pt-2">
      <Btn className="text-white bg-red-600 w-32 h-11"
        onClick={()=>{onCancel(); setToast({text:"‚ùå ÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ°",type:"error"})}}>ÿ•ŸÑÿ∫ÿßÿ°</Btn>
      <Btn className="text-white bg-green-600 w-32 h-11"
        onClick={()=>{
          const code=(f.code||"").trim().toUpperCase().slice(0,5),
                name=(f.name||"").trim();
          const rB=toNum(f.ratioBuy),rS=toNum(f.ratioSell),
                m=f.method||"multiply";
          if(!code||!name) return setToast({text:"‚ö†Ô∏è ÿ£ŸÉŸÖŸÑ ÿßŸÑÿ≠ŸÇŸàŸÑ",type:"error"});
          if(!/^[A-Z]{2,5}$/.test(code)) return setToast({text:"‚ö†Ô∏è ÿßŸÑŸÉŸàÿØ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ 2‚Äì5 ÿ£ÿ≠ÿ±ŸÅ ŸÑÿßÿ™ŸäŸÜŸäÿ© ŸÉÿ®Ÿäÿ±ÿ©", type:"error"});
          if(code==="USD") return setToast({text:"‚ö†Ô∏è ÿ™ÿπÿØŸäŸÑ/ÿ•ÿ∂ÿßŸÅÿ© USD ŸÖŸÜ Ÿáÿ∞ÿß ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨ ÿ∫Ÿäÿ± ŸÖÿ≥ŸÖŸàÿ≠ ‚Äî ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿØŸàŸÑÿßÿ±", type:"error"});
          const exists=(i)=>data.some((d,idx)=>d.code===code&&idx!==i);
          if(exists(editIdx!=null?editIdx:-1)) return setToast({text:"‚ö†Ô∏è ÿßŸÑŸÉŸàÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖ",type:"error"});
          if(!(rB>0&&rS>0)) return setToast({text:"‚ö†Ô∏è ÿßŸÑŸÜŸëŸêÿ≥ÿ® Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿ£ŸÉÿ®ÿ± ŸÖŸÜ 0",type:"error"});
          if(!isFlagEmoji(f.flag||"")){
          return setToast({ text:"‚ö†Ô∏è ÿ£ÿØÿÆŸÑ ÿπŸÑŸÖ ÿµÿ≠Ÿäÿ≠ (Emoji)", type:"error" });
        }
        const item={...f,code,name,ratioBuy:rB,ratioSell:rS,method:m,flag:f.flag||"üè≥Ô∏è"};
          const list=[...data];
          if(editIdx!=null) list[editIdx]=item; else list.push(item);
          onSaved(list); try { if (editIdx==null) { window.Log && window.Log.logEvent && window.Log.logEvent('ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÖŸÑÿ©', (f.name||code) + ' (' + code + ')'); } } catch(_) {}
          setToast({text:"‚úÖ ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏",type:"success"});
        }}>ÿ≠ŸÅÿ∏</Btn>
    </div>
  </div>;
};
/* ================== ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ================== */
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
<!-- ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿØÿßÿ±ÿ© (ÿßŸÑÿπÿ±ÿ®Ÿä) v2.0.0.0 --><script>(function(){ "use strict"; function readJSON(k, d){ try{ return JSON.parse(localStorage.getItem(k)||"null") ?? d; }catch(_){ return d; } } function getActor(){ var s = readJSON('taif:session', null); var name = (s && (s.name || s.displayName)) || null; var user = (s && s.username) || null; return name || user || 'anon'; } function fmt(n){ try{ if(n === undefined || n === null || n === '') return ''; var num = Number(n); if (!isFinite(num)) return String(n); return num.toLocaleString('ar-EG'); }catch(_){ return String(n); } } function insertRow(row){ if (!window.$db) return; try{ var id = Date.now() + '_' + Math.random().toString(36).slice(2); window.$db.set(window.$db.ref('taif/adminactionslog/' + id), row); }catch(_){} } window.Log = Object.assign(window.Log||{}, { logEvent: function(actionAr, detailsAr, actor){ insertRow({ actor: actor || getActor(), action: actionAr, target: detailsAr || '' }); }, loginSuccess: function(username){ insertRow({ actor: username || getActor(), action: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ (ŸÜÿ¨ÿßÿ≠)', target: '' }); }, loginFail: function(username){ insertRow({ actor: username || getActor(), action: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ (ŸÅÿ¥ŸÑ)', target: '' }); }, logout: function(username){ insertRow({ actor: username || getActor(), action: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨', target: '' }); } }); var __lastData = null; var __lastUsers = {}; var __lastBanner = null; function ensureSnapshots(){ try{ if (window.$db && !window.__log_snapshots_bound){ window.__log_snapshots_bound = true; try { window.$db.onValue(window.$db.ref('taif/data'), function(s){ __lastData = s && s.val && s.val(); }); } catch(_){} try { window.$db.onValue(window.$db.ref('taif/users'), function(s){ __lastUsers = (s && s.val && s.val()) || {}; }); } catch(_){} } }catch(_){} } function diffCurrencies(oldArr, newArr){ var res = { changed: [], usd: null }; try{ var byCodeOld = Object.create(null), byCodeNew = Object.create(null); (Array.isArray(oldArr)?oldArr:[]).forEach(function(o){ if(o && o.code) byCodeOld[o.code]=o; }); (Array.isArray(newArr)?newArr:[]).forEach(function(o){ if(o && o.code) byCodeNew[o.code]=o; }); var oU = byCodeOld['USD']||{}, nU = byCodeNew['USD']||{}; if ((oU.buy !== nU.buy) || (oU.sell !== nU.sell)){ res.usd = { oldBuy:oU.buy, newBuy:nU.buy, oldSell:oU.sell, newSell:nU.sell }; } Object.keys(byCodeNew).forEach(function(code){ if (code === 'USD') return; var o = byCodeOld[code]||{}, n = byCodeNew[code]||{}; var changed = false; ['ratioBuy','ratioSell','method','buy','sell'].forEach(function(k){ if (o[k] !== n[k]) changed = true; }); if (changed){ res.changed.push({ code: code, name: n.name || o.name || code, oldBuy: o.buy, newBuy: n.buy, oldSell: o.sell, newSell: n.sell, oldRB: o.ratioBuy, newRB: n.ratioBuy, oldRS: o.ratioSell, newRS: n.ratioSell, oldMethod:(o.method||''), newMethod:(n.method||'') }); } }); }catch(_){} return res; } function install(){ if(!window.$db || window.$db.__logWrappedV2) return; ensureSnapshots(); var origSet = window.$db.set.bind(window.$db); window.$db.set = async function(refOrPath, value){ var key = (typeof refOrPath === 'string') ? refOrPath : (refOrPath && refOrPath.key); var actor = getActor(); var res = await origSet(refOrPath, value); try{ if(!key) return res; if (key === 'taif/data' && Array.isArray(value)){ var d = diffCurrencies(__lastData, value); if (d && d.usd){ var m = []; if (d.usd.oldBuy !== d.usd.newBuy) m.push('ÿ¥ÿ±ÿßÿ° ' + fmt(d.usd.oldBuy) + ' ‚Üê ' + fmt(d.usd.newBuy)); if (d.usd.oldSell !== d.usd.newSell) m.push('ŸÖÿ®Ÿäÿπ ' + fmt(d.usd.oldSell) + ' ‚Üê ' + fmt(d.usd.newSell)); insertRow({ actor: actor, action: 'ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿØŸàŸÑÿßÿ±', target: m.join(' | ') }); } if (d && d.changed && d.changed.length){ if (d.changed.length === 1){ var c = d.changed[0]; var msg = ''; if (c.newBuy !== undefined && c.oldBuy !== undefined && (c.oldBuy !== c.newBuy)){ msg += 'ÿ¥ÿ±ÿßÿ° ' + fmt(c.oldBuy) + ' ‚Üê ' + fmt(c.newBuy); } if (c.newSell !== undefined && c.oldSell !== undefined && (c.oldSell !== c.newSell)){ if (msg) msg += ' | '; msg += 'ŸÖÿ®Ÿäÿπ ' + fmt(c.oldSell) + ' ‚Üê ' + fmt(c.newSell); } if (!msg){ msg = 'ŸÜŸêÿ≥Ÿéÿ® ÿ¥ÿ±ÿßÿ° ' + fmt(c.oldRB) + ' ‚Üê ' + fmt(c.newRB) + ' | ŸÜŸêÿ≥Ÿéÿ® ŸÖÿ®Ÿäÿπ ' + fmt(c.oldRS) + ' ‚Üê ' + fmt(c.newRS); } if (c.oldMethod !== c.newMethod){ if(msg) msg += ' | '; var nameOld=(c.oldMethod==='divide'?'ŸÇÿ≥ŸÖÿ©':(c.oldMethod==='multiply'?'ÿ∂ÿ±ÿ®':String(c.oldMethod||''))); var nameNew=(c.newMethod==='divide'?'ŸÇÿ≥ŸÖÿ©':(c.newMethod==='multiply'?'ÿ∂ÿ±ÿ®':String(c.newMethod||''))); msg += 'ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© ' + (nameOld||'‚Äî') + ' ‚Üê ' + (nameNew||'‚Äî'); }
insertRow({ actor: actor, action: 'ÿ™ÿπÿØŸäŸÑ ÿπŸÖŸÑÿ©', target: c.name + ' (' + c.code + ') ‚Äî ' + msg }); } else { insertRow({ actor: actor, action: 'ÿ™ÿπÿØŸäŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÖŸÑÿßÿ™', target: '(' + d.changed.length + ' ÿπŸÖŸÑÿßÿ™)' });
d.changed.forEach(function(c){
  var msg = '';
  if (c.oldRB !== undefined && c.newRB !== undefined) msg += 'ŸÜŸêÿ≥Ÿéÿ® ÿ¥ÿ±ÿßÿ° ' + fmt(c.oldRB) + ' ‚Üê ' + fmt(c.newRB);
  if (c.oldRS !== undefined && c.newRS !== undefined){ if(msg) msg += ' | '; msg += 'ŸÜŸêÿ≥Ÿéÿ® ŸÖÿ®Ÿäÿπ ' + fmt(c.oldRS) + ' ‚Üê ' + fmt(c.newRS); }
  if (c.oldBuy !== undefined && c.newBuy !== undefined){ if(msg) msg += ' | '; msg += 'ÿ¥ÿ±ÿßÿ° ' + fmt(c.oldBuy) + ' ‚Üê ' + fmt(c.newBuy); }
  if (c.oldSell !== undefined && c.newSell !== undefined){ if(msg) msg += ' | '; msg += 'ŸÖÿ®Ÿäÿπ ' + fmt(c.oldSell) + ' ‚Üê ' + fmt(c.newSell); }
  if (c.oldMethod !== c.newMethod){ if(msg) msg += ' | '; var nameOld=(c.oldMethod==='divide'?'ŸÇÿ≥ŸÖÿ©':(c.oldMethod==='multiply'?'ÿ∂ÿ±ÿ®':String(c.oldMethod||''))); var nameNew=(c.newMethod==='divide'?'ŸÇÿ≥ŸÖÿ©':(c.newMethod==='multiply'?'ÿ∂ÿ±ÿ®':String(c.newMethod||''))); msg += 'ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© ' + (nameOld||'‚Äî') + ' ‚Üê ' + (nameNew||'‚Äî'); }
insertRow({ actor: actor, action: 'ÿ™ÿπÿØŸäŸÑ ÿπŸÖŸÑÿ©', target: c.name + ' (' + (c.code||'') + ') ‚Äî ' + msg });
}); } } } else if (key === 'taif/banner' || key === 'taif:banner:v2'){
  try{
    var oldB = (__lastBanner && Array.isArray(__lastBanner.texts)) ? __lastBanner.texts.slice() : [];
    var newB = (value && Array.isArray(value.texts)) ? value.texts.slice() : [];
    var diffs = [];
    var max = Math.max(oldB.length, newB.length);
    for (var i=0;i<max;i++){
      var o = (oldB[i]||"").trim(), n = (newB[i]||"").trim();
      if (o && !n) diffs.push("‚ùå ÿ≠ÿ∞ŸÅ: " + o);
      else if (!o && n) diffs.push("‚ûï ÿ•ÿ∂ÿßŸÅÿ©: " + n);
      else if (o !== n) diffs.push("‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ: " + o + " ‚Üê " + n);
    }
    var msg = diffs.length ? diffs.join(" | ") : "ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÜÿµŸàÿµ ("+newB.length+" ÿπŸÜÿµÿ±)";
    insertRow({ actor: actor, action: 'ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™', target: msg });
    __lastBanner = value;
  }catch(_){
    var count = (value && Array.isArray(value.texts)) ? value.texts.length : 0;
    insertRow({ actor: actor, action: 'ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™', target: '(' + count + ' ÿπŸÜÿµÿ±)' });
  }
}
 else if (key === 'taif/base'){
   try{
     var dte = (value && value.date) ? String(value.date) : '';
     var cnt = 0;
     try { cnt = value && value.base ? Object.keys(value.base).length : 0; } catch(_){}
     insertRow({ actor: actor, action: 'resetBase', target: (dte ? ('ÿ®ÿ™ÿßÿ±ŸäÿÆ ' + dte + ' ‚Äî ') : '') + '(' + cnt + ' ÿπŸÖŸÑÿßÿ™)' });
   }catch(_){}
 }
 else if (key === 'taif/title'){ insertRow({ actor: actor, action: 'ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸáŸàŸäÿ©', target: 'ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿπŸÜŸàÿßŸÜ ÿ•ŸÑŸâ ‚Äú' + String(value||'') + '‚Äù' }); } else if (key === 'taif/logo'){ insertRow({ actor: actor, action: 'ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸáŸàŸäÿ©', target: 'ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÑŸàÿ∫Ÿà' }); } else if (key === 'taif/bannerImg'){ insertRow({ actor: actor, action: 'ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸáŸàŸäÿ©', target: 'ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ÿµŸàÿ±ÿ© ÿßŸÑŸàÿßÿ¨Ÿáÿ©' }); } else if (key === 'taif/datetime' && value && typeof value === 'object'){ var t = (value.time ? String(value.time) : ''); var dte = (value.date ? String(value.date) : ''); insertRow({ actor: actor, action: 'ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸàŸÇÿ™', target: 'ÿ•ŸÑŸâ ' + t + ' ÿ®ÿ™ÿßÿ±ŸäÿÆ ' + dte }); } else if (key === 'taif/adminactionslog' && (value === null || value === undefined)){ insertRow({ actor: actor, action: 'ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ¨ŸÑ', target: '' }); } else if (String(key).startsWith('taif/users/')){ var uname = String(key).split('/')[2] || ''; var before = __lastUsers && __lastUsers[uname]; if (value === null || value === undefined){ insertRow({ actor: actor, action: 'ÿ≠ÿ∞ŸÅ ŸÖÿ≥ÿ™ÿÆÿØŸÖ', target: '(' + uname + ')' }); } else if (!before){ var nm = (value && (value.name || value.username)) || uname; insertRow({ actor: actor, action: 'ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ', target: '(' + nm + ')' }); } else { var nm2 = (value && (value.name || value.username)) || uname; insertRow({ actor: actor, action: 'ÿ™ÿπÿØŸäŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ', target: '(' + nm2 + ')' }); } } }catch(_){} return res; }; window.$db.__logWrappedV2 = true; } if (document.readyState === 'complete' || document.readyState === 'interactive'){ install(); } else { document.addEventListener('DOMContentLoaded', install); } window.addEventListener('db-ready', install); })();</script></script>


<script>
// === Robust double-click fullscreen toggle (global, debounced, selection-safe) ===
(function(){
  // Safeguard: ignore dblclicks inside inputs or editable controls
  function isEditableTarget(t){
    if (!t) return false;
    if (t.closest('input, textarea, select, [contenteditable="true"], .fld')) return true;
    return false;
  }

  function enterFS(el){
    const fn = el.requestFullscreen || el.webkitRequestFullscreen || el.mozRequestFullScreen || el.msRequestFullscreen;
    if (fn) try { fn.call(el); } catch(_){}
  }
  function exitFS(doc){
    const fn = doc.exitFullscreen || doc.webkitExitFullscreen || doc.mozCancelFullScreen || doc.msExitFullscreen;
    if (fn) try { fn.call(doc); } catch(_){}
  }
  function isFS(doc){
    return !!(doc.fullscreenElement || doc.webkitFullscreenElement || doc.mozFullScreenElement || doc.msFullscreenElement);
  }

  // Prevent text selection on quick double click
  document.addEventListener('mousedown', function(e){
    if (e.detail > 1 && !isEditableTarget(e.target)) {
      e.preventDefault();
    }
  }, { capture:true });

  // Main dblclick handler
  const onDbl = function(e){
    if (isEditableTarget(e.target)) return; // do nothing on inputs/text areas
    e.preventDefault();
    e.stopPropagation();

    // brief no-select to avoid highlighting artifacts
    document.body.classList.add('no-select');
    setTimeout(()=>document.body.classList.remove('no-select'), 350);

    if (isFS(document)) exitFS(document);
    else enterFS(document.documentElement);
  };

  // Capture early to beat component handlers that might select text
  document.addEventListener('dblclick', onDbl, { capture:true });
})();
</script>

<script>
// PhaseB: guard write to taif/base outside midnight
const origSetB = window.$db && window.$db.set ? window.$db.set.bind(window.$db) : null;
if(origSetB){
  window.$db.set = async function(refOrPath,value){
    try{
      var key = typeof refOrPath==='string'?refOrPath:(refOrPath&&refOrPath.key);
      if(key==='taif/base'){
        var now=new Date(); if(!(now.getHours()===0 && now.getMinutes()===0)){
          console.warn('‚õî Attempt to modify taif/base outside midnight blocked');
          try{ window.Log && window.Log.logEvent && window.Log.logEvent('resetBase', 'ŸÖÿ±ŸÅŸàÿ∂ ‚Äî ÿÆÿßÿ±ÿ¨ ŸÖŸÜÿ™ÿµŸÅ ÿßŸÑŸÑŸäŸÑ'); }catch(_){}
          return;
        }
      }
    }catch(_){}
    return origSetB(refOrPath,value);
  };
}
</script>
</body>
</html>
